<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0c10">
    <title>Belajar Bersama - Professional Cross-Platform App</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- React & Lucide Icons via CDN -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Global Error Handler -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            // Ignore benign ResizeObserver error
            if (msg.includes('ResizeObserver')) return false;

            const errorContainer = document.getElementById('error-container');
            if (errorContainer) {
                errorContainer.innerText = "Error: " + msg + " (Lines " + line + ")";
                errorContainer.style.display = 'block';
            }
            return false;
        };
    </script>

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --bg-main: #0a0c10;
            --bg-card: #161b22;
            --text-white: #f0f6fc;
            --text-gray: #8b949e;
            --border: #30363d;
            --glass: rgba(22, 27, 34, 0.95);
            --sidebar-width: 260px;

            /* Responsive Tokens */
            --container-max: 1400px;
            --radius-lg: 24px;
            --radius-md: 16px;
            --gap-responsive: clamp(16px, 4vw, 32px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE and Edge */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        body {
            background: #111;
            color: var(--text-white);
            font-family: 'Outfit', sans-serif;
            overflow: hidden;
        }

        #root {
            width: 100%;
            min-height: 100vh;
            background: var(--bg-main);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- Responsive Spacing & Grid System --- */
        .container {
            width: 100%;
            max-width: var(--container-max);
            margin: 0 auto;
            padding: 0 clamp(12px, 3vw, 24px);
        }

        .grid-responsive {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(clamp(140px, 22vw, 280px), 1fr));
            gap: clamp(10px, 2vw, 20px);
            width: 100%;
        }

        /* Responsive paddings */
        .section-p {
            padding: clamp(20px, 6vw, 40px) 0;
        }

        .content-gap {
            gap: var(--gap-responsive);
        }

        .page-header {
            padding: clamp(20px, 5vw, 40px) var(--gap-responsive);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            position: relative;
        }

        /* --- Animations --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* Sidebar Layout (Global) */
        .sidebar-page-container {
            display: flex;
            height: 100vh;
            width: 100%;
            overflow: hidden;
            flex-direction: column;
            /* Mobile first: Stacked */
        }

        .app-sidebar {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 16px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            flex-shrink: 0;
            z-index: 10;
            scrollbar-width: none;
            /* Firefox */
        }

        .app-sidebar::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .sidebar-header {
            display: none;
        }

        .sidebar-menu {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .sidebar-menu button {
            flex: 1;
            min-width: fit-content;
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            font-size: 13px;
            white-space: nowrap;
        }

        .sidebar-menu button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .app-content {
            flex: 1;
            overflow-y: auto;
            padding: clamp(16px, 4vw, 32px);
            padding-bottom: 120px;
            /* Space for bottom nav */
            position: relative;
        }

        .mobile-header {
            margin-bottom: 24px;
            display: block;
        }

        /* --- Advanced Scrolling & Scrollbar System --- */
        html {
            scroll-behavior: smooth;
        }

        /* Container Scroll Area dengan Batasan Tinggi */
        .content-scroll-area {
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            /* Momentum scroll iOS */

            /* Responsive Max Height calculations */
            max-height: calc(100vh - 400px);
            /* Mobile Default */

            /* Visuals */
            padding-right: 4px;
            /* Space for scrollbar */
            scrollbar-color: var(--primary) rgba(255, 255, 255, 0.05);
            scrollbar-width: thin;
        }

        /* Desktop Scrollbar Styling */
        @media (min-width: 1024px) {
            .content-scroll-area {
                max-height: calc(100vh - 420px);
            }

            /* Custom Scrollbar PC */
            ::-webkit-scrollbar {
                width: 10px;
                background: rgba(0, 0, 0, 0.2);
            }

            ::-webkit-scrollbar-thumb {
                background: linear-gradient(to bottom, var(--primary), var(--secondary));
                border-radius: 5px;
                border: 2px solid rgba(0, 0, 0, 0.2);
                /* Creates padding effect */
            }

            ::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.02);
                border-radius: 5px;
            }
        }

        /* Tablet Scrollbar Styling */
        @media (min-width: 768px) and (max-width: 1023px) {
            .content-scroll-area {
                max-height: calc(100vh - 380px);
            }
        }

        /* Mobile Scrollbar Styling */
        @media (max-width: 767px) {

            /* Scrollbar tipis/tersembunyi di mobile */
            ::-webkit-scrollbar {
                width: 6px;
                background: transparent;
            }

            ::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.2);
                border-radius: 3px;
            }

            /* Hide scrollbar when not interacting if supported */
            .content-scroll-area {
                scrollbar-width: none;
                /* Firefox mobile */
            }
        }

        /* Horizontal Scroll Utility (Updated) */
        .horizontal-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            /* Hide for cleanliness */
        }

        .horizontal-scroll::-webkit-scrollbar {
            display: none;
        }

        @media (min-width: 768px) {
            .sidebar-page-container {
                flex-direction: row;
            }

            .app-sidebar {
                width: 260px;
                height: 100%;
                flex-direction: column;
                border-right: 1px solid var(--border);
                border-bottom: none;
                gap: 24px;
                padding: 24px;
            }

            .sidebar-header {
                display: block;
                padding-bottom: 20px;
                border-bottom: 1px solid var(--border);
            }

            .sidebar-header h2 {
                font-size: 20px;
                color: white;
                margin-bottom: 4px;
            }

            .sidebar-header p {
                font-size: 12px;
                color: var(--text-gray);
            }

            .sidebar-menu {
                flex-direction: column;
                width: 100%;
            }

            .sidebar-menu button {
                justify-content: flex-start;
                padding: 14px 16px;
                font-size: 14px;
            }

            .mobile-header {
                display: none;
            }
        }

        /* --- Components --- */
        header {
            padding: 30px 24px 10px;
        }

        .search-bar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .search-bar:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: white;
            outline: none;
            width: 100%;
            font-family: inherit;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* --- 3D Atmospheric Backgrounds --- */
        .page-container-3d {
            position: relative;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            background: #0a0c10;
            scroll-behavior: smooth;
            padding-bottom: 140px;
            /* Jarak aman agar tidak tertutup nav bar */
        }

        .bg-blob {
            position: fixed;
            width: clamp(300px, 60vw, 600px);
            height: clamp(300px, 60vw, 600px);
            border-radius: 50%;
            filter: blur(80px);
            z-index: 0;
            opacity: 0.15;
            pointer-events: none;
            animation: moveBlob 20s infinite alternate;
        }

        @keyframes moveBlob {
            0% {
                transform: translate(-10%, -10%) rotate(0deg) scale(1);
            }

            100% {
                transform: translate(20%, 20%) rotate(360deg) scale(1.2);
            }
        }

        .blob-1 {
            top: -10%;
            left: -10%;
            background: var(--primary);
        }

        .blob-2 {
            bottom: -10%;
            right: -10%;
            background: var(--secondary);
            animation-delay: -5s;
        }

        .blob-3 {
            top: 40%;
            right: -5%;
            background: #10B981;
            animation-delay: -10s;
            opacity: 0.1;
        }

        .mesh-grid {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            perspective: 1000px;
            transform: rotateX(60deg) translateY(-200px);
            mask-image: linear-gradient(to bottom, transparent, black, transparent);
            z-index: 0;
            opacity: 0.3;
            pointer-events: none;
        }

        .glass-panel-3d {
            position: relative;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
            opacity: 0;
            transition: 0.2s;
        }

        .card:hover::before {
            opacity: 1;
        }

        .tag {
            font-size: 11px;
            font-weight: 500;
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            margin-right: 6px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        /* --- Enhanced Navigation --- */
        .bottom-nav {
            position: fixed;
            bottom: calc(16px + env(safe-area-inset-bottom));
            left: 16px;
            right: 16px;
            background: rgba(22, 27, 34, 0.85);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            display: flex;
            justify-content: space-around;
            padding: 8px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .sidebar {
            display: none;
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.9) 0%, rgba(10, 12, 16, 0.98) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            padding: 40px 24px;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }

        .main-content {
            flex: 1;
            padding-bottom: calc(100px + env(safe-area-inset-bottom));
            width: 100%;
            transition: padding 0.3s ease;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            color: var(--text-gray);
            font-size: 10px;
            cursor: pointer;
            padding: 12px;
            border-radius: 18px;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
        }

        .nav-item i {
            font-size: 20px;
            transition: transform 0.3s;
        }

        .nav-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-item.active {
            font-weight: 00;
            scale: 1.05;
        }

        /* --- Menu Colors --- */
        .nav-item[data-menu="home"].active {
            color: #818cf8;
            background: rgba(129, 140, 248, 0.15);
        }

        .nav-item[data-menu="bidang"].active {
            color: #fb7185;
            background: rgba(251, 113, 133, 0.15);
        }

        .nav-item[data-menu="pesan"].active {
            color: #34d399;
            background: rgba(52, 211, 153, 0.15);
        }

        .nav-item[data-menu="anggota"].active {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.15);
        }

        .nav-item[data-menu="notif"].active {
            color: #f87171;
            background: rgba(248, 113, 113, 0.15);
        }

        .nav-item[data-menu="profil"].active {
            color: #a78bfa;
            background: rgba(167, 139, 250, 0.15);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0px;
            width: 20px;
            height: 3px;
            background: currentColor;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 0 15px currentColor;
        }

        .nav-item.active i {
            transform: translateY(-2px);
            filter: drop-shadow(0 4px 8px currentColor);
        }

        /* --- Pull To Refresh Styles --- */
        .ptr-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            pointer-events: none;
            transition: transform 0.1s ease-out, opacity 0.2s;
        }

        .ptr-indicator {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            color: var(--primary);
            transform: scale(0.5);
            opacity: 0;
            transition: transform 0.2s, opacity 0.2s;
        }

        .ptr-indicator.visible {
            transform: scale(1);
            opacity: 1;
        }

        .ptr-spinning {
            animation: ptr-spin 0.8s linear infinite;
        }

        @keyframes ptr-spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .fab {
            position: fixed;
            bottom: 100px;
            right: 24px;
            z-index: 99;
            width: 56px;
            height: 56px;
            background: var(--primary);
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
            cursor: pointer;
            transition: 0.3s;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
        }

        /* --- 3D Bidang Cards --- */
        .bidang-card {
            perspective: 1200px !important;
            background: linear-gradient(145deg, rgba(22, 27, 34, 0.8), rgba(22, 27, 34, 1)) !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
            padding: 30px 20px !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            height: auto !important;
            width: 100% !important;
            margin: 0 !important;
        }

        .bidang-card:hover {
            transform: translateY(-8px) rotateX(4deg) !important;
            border-color: var(--primary) !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4) !important;
        }

        .icon-container-3d {
            width: 80px;
            height: 80px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .bidang-card:hover .icon-container-3d {
            transform: translateZ(30px) rotateY(10deg);
        }

        .icon-box {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            z-index: 5;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .bidang-card:hover .icon-box {
            background: rgba(255, 255, 255, 0.07);
            border-color: rgba(255, 255, 255, 0.2);
            scale: 1.1;
        }

        .icon-shadow-3d {
            position: absolute;
            bottom: -5px;
            width: 50px;
            height: 12px;
            background: var(--glow-color);
            border-radius: 50%;
            filter: blur(15px);
            opacity: 0.4;
            transform: rotateX(90deg) translateZ(-40px);
            transition: 0.3s;
            z-index: 1;
        }

        .bidang-card:hover .icon-shadow-3d {
            opacity: 0.8;
            filter: blur(12px);
            scale: 1.4;
        }

        .category-glow-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            background: radial-gradient(circle, var(--glow-color) 0%, transparent 70%);
            opacity: 0.05;
            z-index: 0;
            transition: 0.4s;
            pointer-events: none;
        }

        .bidang-card:hover .category-glow-bg {
            opacity: 0.15;
            scale: 1.2;
        }

        /* --- Multi-Platform Desktop Responsive --- */
        @media (min-width: 768px) {
            #root {
                flex-direction: row;
                padding-left: var(--sidebar-width);
                position: relative;
            }

            body:has(.auth-screen) #root,
            body:has(.splash-screen) #root,
            body:has(.onboarding-screen) #root {
                padding-left: 0 !important;
                padding-top: 0 !important;
                justify-content: center !important;
                align-items: center !important;
                height: 100vh !important;
            }

            .bottom-nav {
                display: none;
            }

            .sidebar {
                display: flex;
                box-shadow: 10px 0 30px rgba(0, 0, 0, 0.3);
            }

            .main-content {
                padding-bottom: 40px;
                padding-top: 0;
                width: 100%;
                min-height: 100vh;
            }

            .page-container-3d,
            .app-content {
                padding-bottom: 40px !important;
            }

            .nav-item {
                flex-direction: row;
                font-size: 15px;
                gap: 16px;
                padding: 14px 20px;
                margin-bottom: 10px;
                width: 100%;
                justify-content: flex-start;
                border-radius: 14px;
            }

            .nav-item.active::after {
                bottom: auto;
                left: -24px;
                width: 4px;
                height: 24px;
                border-radius: 0 4px 4px 0;
            }

            .nav-item i {
                font-size: 22px;
                width: 24px;
                height: 24px;
            }

            .fab {
                bottom: 40px;
                right: 40px;
                width: 64px;
                height: 64px;
            }

            .grid-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 24px;
                max-width: 1200px;
                margin: 0 auto;
            }

            .favorites-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) !important;
                gap: 20px !important;
            }
        }

        /* --- Splash & Auth (Keep specific screens centered and mobile-width) --- */
        .splash-screen,
        .onboarding-screen,
        .auth-screen {
            min-height: 100vh !important;
            width: 100% !important;
            z-index: 9999 !important;
            overflow: hidden !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 20px !important;
        }

        .auth-container {
            margin: 0 auto;
            max-width: 340px;
        }

        @keyframes shine {
            0% {
                left: -50px;
                opacity: 0;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                left: 120%;
                opacity: 0;
            }
        }

        /* --- Mobile Optimizations (Maximal Responsiveness) --- */
        html,
        body {
            overscroll-behavior-y: none;
            /* Prevent pull-to-refresh */
            touch-action: pan-x pan-y;
            -webkit-tap-highlight-color: transparent;
        }

        .db-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #2b2b2b;
            z-index: 50000;
            display: flex;
            flex-direction: column;
            font-family: 'Segoe UI', sans-serif;
            color: #ccc;
        }

        .db-layout {
            display: flex;
            flex: 1;
            flex-direction: row;
            overflow: hidden;
        }

        .db-sidebar {
            width: 250px;
            background: #313335;
            border-right: 1px solid #111;
            display: flex;
            flex-direction: column;
        }

        .db-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #2b2b2b;
        }

        @media (max-width: 768px) {
            .db-layout {
                flex-direction: column;
            }

            .db-sidebar {
                width: 100%;
                height: 40%;
                min-height: 200px;
                border-right: none;
                border-bottom: 1px solid #111;
            }

            .db-editor {
                height: 60%;
            }

            .bidang-card {
                min-height: 140px;
            }

            /* Ensure touch target size */
            .logo-container {
                width: 80px !important;
                height: 80px !important;
            }

            /* Smaller logo on mobile sidebar if shown */
        }
    </style>
</head>

<body>
    <div id="error-container"
        style="background: #333; color: #ff6b6b; padding: 20px; display: none; margin: 20px; border-radius: 8px; font-family: monospace;">
    </div>
    <div id="root">
        <div style="color: #666; font-family: sans-serif; text-align: center; padding-top: 50px;">
            <h2>Memuat Aplikasi...</h2>
            <p>Jika halaman ini tidak berubah dalam 10 detik, cek koneksi internet Anda.</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- UI COMPONENTS ---
        const Icon = ({ name, size = 20, color = "currentColor" }) => {
            useEffect(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size, color }}></i>;
        };

        // Utility: Robust Share Function
        const globalShare = async (data) => {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: data.title,
                        text: data.text,
                        url: data.url || window.location.href
                    });
                } catch (err) {
                    if (err.name !== 'AbortError') console.error('Share failed:', err);
                }
            } else {
                const shareText = `${data.title}\n${data.text}\n${data.url || window.location.href}`;
                try {
                    await navigator.clipboard.writeText(shareText);
                    alert('✓ Berhasil disalin ke clipboard! Siap dibagikan.');
                } catch (err) {
                    alert('Gagal menyalin. Silakan salin link secara manual.');
                }
            }
        };

        // Utility: Render Text with clickable @User Mentions
        const renderTextWithMentions = (text, onTagClick) => {
            if (!text || typeof text !== 'string') return text;
            const parts = text.split(/(\s+)/);
            return parts.map((part, i) => {
                if (part.startsWith('@') && part.length > 1) {
                    const cleanName = part.substring(1).replace(/[:;,.!?]$/, '');
                    return (
                        <span
                            key={i}
                            onClick={(e) => {
                                e.stopPropagation();
                                if (onTagClick) onTagClick(cleanName);
                            }}
                            className="user-tag"
                            style={{
                                color: '#fbbf24',
                                fontWeight: 'bold',
                                cursor: 'pointer',
                                background: 'rgba(251, 191, 36, 0.1)',
                                padding: '0 4px',
                                borderRadius: '4px',
                                transition: 'all 0.2s'
                            }}
                        >
                            {part}
                        </span>
                    );
                }
                return part;
            });
        };

        // Global Constants
        const DEMO_MEMBERS = [
            { id: 101, name: 'Budi Santoso', role: 'IT Support Senior', status: 'Online', email: 'budi.s@mrtech.com', image: 'https://i.pravatar.cc/150?u=1' },
            { id: 102, name: 'Siti Aminah', role: 'Database Admin', status: 'Baru Bergabung', email: 'siti.a@mrtech.com', image: 'https://i.pravatar.cc/150?u=2' },
            { id: 103, name: 'FAHRIL', role: 'System Architect', status: 'Online', email: 'fahril@mrtech.com', image: 'https://i.pravatar.cc/150?u=3' },
            { id: 104, name: 'Natasya Rina', role: 'UI/UX Designer', status: 'Busy', email: 'natasya@mrtech.com', image: 'https://i.pravatar.cc/150?u=12' }
        ];

        const REGISTERED_MEMBERS = [
            { id: 'u1', name: 'Rama (Admin)', role: 'Administrator IT', image: 'https://ui-avatars.com/api/?name=Rama&background=000&color=fff' },
            { id: 'u2', name: 'Siti Aminah', role: 'Hardware Specialist', image: 'https://ui-avatars.com/api/?name=Siti+Aminah&background=random&color=fff' },
            { id: 'u3', name: 'Budi Santoso', role: 'Network Engineer', image: 'https://ui-avatars.com/api/?name=Budi+Santoso&background=random&color=fff' },
            { id: 'u4', name: 'Rudi Hermawan', role: 'Security Analyst', image: 'https://ui-avatars.com/api/?name=Rudi+Hermawan&background=random&color=fff' }
        ];

        const TRANSLATIONS = {
            id: {
                // Common
                back: 'Kembali',
                save: 'Simpan',
                cancel: 'Batal',
                delete: 'Hapus',
                search: 'Cari',
                loading: 'Memuat...',
                just_now: 'Baru saja',
                confirm_delete: 'Apakah Anda yakin ingin menghapus ini?',
                confirm_delete_notif: 'Hapus notifikasi ini?',
                confirm_delete_all_notif: 'Hapus semua notifikasi?',
                confirm_delete_all_msg: 'Hapus semua pesan?',
                confirm_delete_discuss: 'Hapus diskusi ini?',

                // Tabs / Nav
                tab_home: 'Beranda',
                tab_bidang: 'Bidang',
                tab_pesan: 'Pesan',
                tab_anggota: 'Anggota',
                tab_notif: 'Notifikasi',
                tab_profil: 'Profil',

                // Splash / Onboarding
                splash_subtitle: 'Platform Kolaborasi IT Support',
                onboarding_1_title: 'SOLUSI IT SUPPORT',
                onboarding_1_desc: 'Temukan jawaban dari masalah troubleshooting IT di tempat kerja Anda',
                onboarding_2_title: 'TANYA JAWAB KREDIBEL',
                onboarding_2_desc: 'Dapatkan jawaban valid dari karyawan ahli di berbagai bidang IT',
                onboarding_3_title: 'DISKUSI BERSAMA REKAN KERJA',
                onboarding_3_desc: 'Berdiskusi dan berbagi solusi dengan sesama karyawan',
                onboarding_next: 'Lanjut',
                onboarding_start: 'Mulai Sekarang',

                // Knowledge Feed
                kf_title: 'Semua Pengetahuan',
                kf_subtitle: 'Daftar lengkap analisa AI & Google Update',
                kf_trending: 'TRENDING',
                kf_ai_analyzing: 'AI Sedang Menganalisa...',
                kf_ai_connecting: 'Menghubungkan ke Google Search & Database Internal',
                kf_report_title: 'Laporan Analisa Deep-AI',
                kf_report_sync: 'Sinkronisasi Google Data + AI Real-time',
                kf_problem_summary: 'Ringkasan Masalah',
                kf_ai_engine: 'AI CRAWLING ENGINE',
                kf_btn_resource: 'Tinjau Resource AI',
                kf_google_insight: 'GOOGLE SEARCH INSIGHT',
                kf_btn_google: 'Lihat di Google',
                kf_solution_title: 'SOLUSI & LANGKAH PERBAIKAN',
                kf_btn_copy: 'Salin Solusi',
                kf_btn_share: 'Bagikan',
                kf_btn_close: 'Tutup Laporan',
                kf_copy_success: 'Solusi berhasil disalin ke clipboard!',
                kf_resource_ai: 'Sumber AI: Verified Support Thread & Knowledge Base #8812',

                // Auth
                auth_welcome: 'Selamat Datang!',
                auth_create_acc: 'Buat Akun Baru',
                auth_forgot_pass: 'Lupa Kata Sandi',
                auth_verify_otp: 'Verifikasi OTP',
                auth_reset_pass: 'Atur Ulang Kata Sandi',
                auth_login_subtitle: 'Masuk ke akun Anda',
                auth_register_subtitle: 'Buat akun gratis sekarang',
                auth_forgot_subtitle: 'Masukkan email untuk menerima kode OTP',
                auth_otp_sent: 'Kode OTP telah dikirim ke email Anda',
                auth_reset_subtitle: 'Masukkan kata sandi baru Anda',
                auth_label_name: 'Nama Lengkap',
                auth_label_email: 'Alamat Email',
                auth_label_pass: 'Kata Sandi',
                auth_label_confirm_pass: 'Konfirmasi Sandi',
                auth_label_otp: '6-Digit Kode OTP',
                auth_remember_me: 'Ingat Saya',
                auth_btn_login: 'Masuk Sekarang',
                auth_btn_register: 'Daftar Akun',
                auth_btn_send_otp: 'Kirim Kode OTP',
                auth_btn_verify_otp: 'Verifikasi Kode',
                auth_btn_reset_pass: 'Perbarui Sandi',
                auth_no_acc: 'Belum punya akun?',
                auth_have_acc: 'Sudah punya akun?',
                auth_back_login: 'Kembali Login',
                auth_social_connecting: 'Menghubungkan ke {type}...',
                auth_social_wait: 'Mohon tunggu, sedang memverifikasi kredensial Anda.',
                auth_err_required: 'Email dan Password wajib diisi',
                auth_err_email_required: 'Email wajib diisi',
                auth_err_name: 'Nama Lengkap wajib diisi',
                auth_err_match: 'Konfirmasi password tidak cocok',
                auth_err_length: 'Password minimal 6 karakter',
                auth_err_email_exist: 'Email sudah terdaftar! Silakan login.',
                auth_err_email_not_found: 'Email tidak terdaftar!',
                auth_err_otp: 'Kode OTP salah!',
                auth_msg_reset_success: 'Kata sandi berhasil diubah! Silakan login.',
                auth_msg_register_success: 'Registrasi Berhasil! Selamat datang, ',
                auth_or: 'atau',
                auth_link_forgot: 'Lupa Password?',
                auth_agree: 'Saya setuju dengan',
                auth_tos: 'Ketentuan Layanan',

                // Home Menu
                menu_my_profile: 'Profil Saya',
                menu_profile_desc: 'Kelola data diri & badge',
                menu_notif: 'Notifikasi',
                menu_notif_desc: 'Pesan & update terbaru',
                menu_history: 'Riwayat Diskusi',
                menu_history_desc: 'Lihat tanya jawab lama',
                menu_help: 'Pusat Bantuan',
                menu_help_desc: 'Informasi tentang aplikasi',
                menu_settings: 'Pengaturan',
                menu_settings_desc: 'Konfigurasi Aplikasi',
                menu_db_manager: 'Database Manager',
                menu_db_desc: 'DBeaver Lite Console',
                menu_logout: 'Keluar',
                menu_logout_desc: 'Keluar dari sesi ini',
                menu_role: 'Peran',
                menu_status_active: 'Aktif',

                fav_fields: 'Bidang Favorit',
                view_all: 'Lihat Semua',
                ai_base_title: 'Deep-AI Analysis Base',
                ai_base_subtitle: 'Validasi otomatis tiap 24 jam',
                explore: 'Eksplorasi',

                // Bidang Detail
                fd_choose_colleague: 'Pilih Rekan Kerja',
                fd_search_colleague: 'Cari nama rekan...',
                fd_not_found: 'Pekerja tidak ditemukan',
                fd_expert_hub: 'Expert Hub',
                fd_tab_diskusi: 'Diskusi',
                fd_tab_materi: 'Materi',
                fd_tab_ahli: 'AHLI',
                fd_list_diskusi: 'Daftar Isi Diskusi',
                fd_empty_diskusi: 'Belum ada materi diskusi di bidang ini.',
                fd_modul_title: 'Modul Pembelajaran',
                fd_btn_add_materi: 'Tambah Materi',
                fd_expert_title: 'Konsultasi & Diskusi Ahli',
                fd_expert_placeholder: 'Bagikan pemikiran ahli di',
                fd_public_chat: 'Percakapan Publik',
                fd_chat_empty: 'Belum ada pesan. Mulai obrolan sekarang!',
                fd_chat_placeholder: 'Ketik pesan...',
                fd_confirm_delete_diskusi: 'Hapus diskusi ini?',
                fd_alert_colleague_added: 'Rekan berhasil dihubungkan ke bidang ini.',
                fd_alert_joined: 'sudah bergabung dalam diskusi ini.',
                fd_alert_diskusi_added: 'berhasil ditambahkan ke diskusi:',

                // Home
                welcome_morning: 'Selamat Pagi',
                welcome_afternoon: 'Selamat Siang',
                welcome_evening: 'Selamat Sore',
                welcome_night: 'Selamat Malam',
                search_placeholder_internal: 'Cari bidang...',
                search_placeholder_google: 'Ketik & cari di Google...',
                search_placeholder_chatgpt: 'Tanya AI (ChatGPT)...',
                search_placeholder_youtube: 'Cari panduan video...',
                quick_menu_profil: 'Profil Saya',
                quick_menu_notif: 'Notifikasi',
                quick_menu_history: 'Riwayat Diskusi',
                quick_menu_help: 'Pusat Bantuan',
                quick_menu_settings: 'Pengaturan',
                quick_menu_logout: 'Log Out',
                knowledge_trending: 'TRENDING',
                knowledge_report_title: 'Laporan Analisa Deep-AI',
                knowledge_report_subtitle: 'Sinkronisasi Google Data + AI Real-time',
                knowledge_solution_title: 'SOLUSI & LANGKAH PERBAIKAN',
                knowledge_btn_copy: 'Salin Solusi',
                knowledge_btn_share: 'Bagikan',
                knowledge_btn_close: 'Tutup Laporan',

                // Bidang
                field_title: 'Bidang Keahlian',
                field_search_placeholder: 'Cari bidang keahlianmu...',
                field_topics: 'TOPIK',
                field_detail_expert_hub: 'Expert Hub',
                field_detail_tab_discuss: 'Diskusi',
                field_detail_tab_module: 'Materi',
                field_detail_tab_expert: 'AHLI',
                field_detail_public_chat: 'Percakapan Publik',
                field_detail_add_material: 'Tambah Materi',
                field_detail_invite: 'Undangan',
                field_detail_no_discuss: 'Belum ada materi diskusi di bidang ini.',
                field_detail_add_material_prompt: 'Masukkan Judul Materi:',
                field_detail_chat_placeholder: 'Ketik pesan...',
                field_detail_expert_placeholder: 'Bagikan pemikiran ahli di ',

                // Pesan
                msg_title: 'Riwayat Diskusi',
                msg_subtitle: 'Chat & Konsultasi',
                msg_inbox: 'Kotak Masuk',
                msg_archived: 'Arsip',
                msg_contacts: 'Kontak',
                msg_search_placeholder: 'Cari pesan atau teman...',
                msg_empty: 'Kotak masuk kosong.',
                msg_clear_all: 'Bersihkan Semua',

                // Notifikasi
                notif_title: 'Notifikasi',
                notif_all: 'Semua',
                notif_discuss: 'Pesan & Diskusi',
                notif_achievement: 'Pencapaian',
                notif_system: 'Sistem',
                notif_empty: 'Tidak ada notifikasi di kategori ini.',

                // Anggota
                member_title: 'Anggota & Grup',
                member_tab_all: 'Semua',
                member_tab_friend: 'Teman',
                member_tab_group: 'Grup',
                member_tab_contribution: 'Kontribusi',
                member_search_placeholder: 'Cari anggota atau grup...',
                member_btn_follow: 'Ikuti',
                member_btn_following: 'Diikuti',
                member_btn_chat: 'Kirim Pesan',
                member_group_create: 'Buat Grup',
                member_btn_remove_friend: 'Hapus Teman',
                member_btn_add_friend: 'Tambah Teman',
                member_btn_delete_user: 'Hapus User',
                member_group_new_title: 'Buat Grup Baru',
                member_group_label_name: 'Nama Grup',
                member_group_label_desc: 'Deskripsi Singkat',
                member_group_btn_create: 'Buat Grup Sekarang',
                member_group_success: 'Grup "{name}" berhasil dibuat! Anda memiliki hak akses penuh sebagai Administrator Grup.',
                member_heading_suggestion: 'Saran Koneksi Baru',
                member_heading_my_groups: 'Grup Saya',
                member_heading_all_members: 'Daftar Anggota',
                member_heading_my_friends: 'Teman Saya',
                member_heading_leaderboard: 'Papan Peringkat Kontribusi',
                member_desc_leaderboard: 'Top kontributor grup dan diskusi bidang.',
                member_stat_contribution: 'KONTRIBUSI',
                member_stat_rating: 'RATING',
                member_stat_status: 'STATUS',
                member_performance_weekly: 'Kinerja Mingguan',
                member_btn_view_group: 'Lihat Grup',
                member_empty_group: 'Belum Ada Grup',
                member_empty_group_desc: 'Buat grup baru untuk berkolaborasi dengan tim Anda.',
                member_btn_add: 'Tambah',
                member_no_found: 'Tidak ada anggota ditemukan.',

                // Profil
                profile_title: 'Profil Saya',
                profile_subtitle: 'Kelola akun & preferensi',
                profile_menu_summary: 'Ringkasan',
                profile_menu_activity: 'Aktivitas',
                profile_menu_security: 'Keamanan',
                profile_menu_settings: 'Pengaturan',
                profile_label_name: 'Nama Lengkap',
                profile_label_bio: 'Bio Singkat',
                profile_label_save: 'Simpan Perubahan',
                profile_stat_discuss: 'Diskusi',
                profile_stat_solution: 'Solusi',
                profile_stat_points: 'Poin',
                profile_skills_title: 'Keahlian IT',
                profile_activity_title: 'Riwayat Aktivitas',
                profile_activity_empty: 'Belum ada aktivitas.',
                profile_privacy_title: 'Privasi Akun',
                profile_privacy_desc: 'Mode privat menyamarkan nama Anda pada daftar anggota publik.',
                profile_pass_title: 'Ganti Password',
                profile_pass_old: 'Password Lama',
                profile_pass_new: 'Password Baru',
                profile_pref_display: 'Preferensi Tampilan',
                profile_lang_label: 'Bahasa / Language',
                profile_theme_label: 'Tema Aplikasi',
                profile_config_app: 'Konfigurasi Aplikasi',
                profile_logout: 'Keluar Sesi',
                profile_delete_acc: 'Hapus Akun Permanen',
                profile_timezone: 'Zona Waktu',
                profile_update_success: 'Profil berhasil diperbarui!',
                profile_delete_confirm: '⚠️ PERINGATAN: Apakah Anda yakin ingin menghapus akun? Tindakan ini tidak dapat dibatalkan.',
                profile_activity_update: 'Memperbarui profil akun',

                // Bantuan
                help_title: 'Pusat Bantuan',
                help_subtitle: 'Support Center',
                help_tab_general: 'Umum',
                help_tab_faq: 'FAQ',
                help_tab_contact: 'Hubungi Kami',
                help_ver: 'Versi',
                help_dev: 'Developer',
                help_need_more: 'Butuh Bantuan Lebih?',
                help_btn_email: 'Email IT Support'
            },
            en: {
                // Common
                back: 'Back',
                save: 'Save',
                cancel: 'Cancel',
                delete: 'Delete',
                search: 'Search',
                loading: 'Loading...',
                just_now: 'Just now',
                confirm_delete: 'Are you sure you want to delete this?',
                confirm_delete_notif: 'Delete this notification?',
                confirm_delete_all_notif: 'Delete all notifications?',
                confirm_delete_all_msg: 'Delete all messages?',
                confirm_delete_discuss: 'Delete this discussion?',

                // Tabs / Nav
                tab_home: 'Home',
                tab_bidang: 'Fields',
                tab_pesan: 'Messages',
                tab_anggota: 'Members',
                tab_notif: 'Notifications',
                tab_profil: 'Profile',

                // Splash / Onboarding
                splash_subtitle: 'IT Support Collaboration Platform',
                onboarding_1_title: 'IT SUPPORT SOLUTIONS',
                onboarding_1_desc: 'Find answers to IT troubleshooting problems at your workplace',
                onboarding_2_title: 'CREDIBLE Q&A',
                onboarding_2_desc: 'Get valid answers from expert employees in various IT fields',
                onboarding_3_title: 'DISCUSS WITH COLLEAGUES',
                onboarding_3_desc: 'Discuss and share solutions with fellow employees',
                onboarding_next: 'Next',
                onboarding_start: 'Start Now',

                // Knowledge Feed
                kf_title: 'All Knowledge',
                kf_subtitle: 'Complete list of AI analysis & Google Updates',
                kf_trending: 'TRENDING',
                kf_ai_analyzing: 'AI is Analyzing...',
                kf_ai_connecting: 'Connecting to Google Search & Internal Database',
                kf_report_title: 'Deep-AI Analysis Report',
                kf_report_sync: 'Google Data + Real-time AI Sync',
                kf_problem_summary: 'Problem Summary',
                kf_ai_engine: 'AI CRAWLING ENGINE',
                kf_btn_resource: 'Review AI Resources',
                kf_google_insight: 'GOOGLE SEARCH INSIGHT',
                kf_btn_google: 'View on Google',
                kf_solution_title: 'SOLUTION & FIX STEPS',
                kf_btn_copy: 'Copy Solution',
                kf_btn_share: 'Share',
                kf_btn_close: 'Close Report',
                kf_copy_success: 'Solution successfully copied to clipboard!',
                kf_resource_ai: 'AI Source: Verified Support Thread & Knowledge Base #8812',

                // Auth
                auth_welcome: 'Welcome Back!',
                auth_create_acc: 'Create New Account',
                auth_forgot_pass: 'Forgot Password',
                auth_verify_otp: 'Verify OTP',
                auth_reset_pass: 'Reset Password',
                auth_login_subtitle: 'Sign in to your account',
                auth_register_subtitle: 'Create a free account now',
                auth_forgot_subtitle: 'Enter your email to receive OTP code',
                auth_otp_sent: 'OTP code has been sent to your email',
                auth_reset_subtitle: 'Enter your new password',
                auth_label_name: 'Full Name',
                auth_label_email: 'Email Address',
                auth_label_pass: 'Password',
                auth_label_confirm_pass: 'Confirm Password',
                auth_label_otp: '6-Digit OTP Code',
                auth_remember_me: 'Remember Me',
                auth_btn_login: 'Sign In Now',
                auth_btn_register: 'Sign Up',
                auth_btn_send_otp: 'Send OTP Code',
                auth_btn_verify_otp: 'Verify Code',
                auth_btn_reset_pass: 'Update Password',
                auth_no_acc: 'Don\'t have an account?',
                auth_have_acc: 'Already have an account?',
                auth_back_login: 'Back to Login',
                auth_social_connecting: 'Connecting to {type}...',
                auth_social_wait: 'Please wait, verifying your credentials.',
                auth_err_required: 'Email and Password are required',
                auth_err_email_required: 'Email is required',
                auth_err_name: 'Full Name is required',
                auth_err_match: 'Passwords do not match',
                auth_err_length: 'Password must be at least 6 characters',
                auth_err_email_exist: 'Email already registered! Please login.',
                auth_err_email_not_found: 'Email not found!',
                auth_err_otp: 'Invalid OTP code!',
                auth_msg_reset_success: 'Password successfully changed! Please login.',
                auth_msg_register_success: 'Registration Successful! Welcome, ',
                auth_or: 'or',
                auth_link_forgot: 'Forgot Password?',
                auth_agree: 'I agree with',
                auth_tos: 'Terms of Service',

                // Home Menu
                menu_my_profile: 'My Profile',
                menu_profile_desc: 'Manage Bio & Badges',
                menu_notif: 'Notifications',
                menu_notif_desc: 'Messages & updates',
                menu_history: 'History',
                menu_history_desc: 'View past Q&A',
                menu_help: 'Help Center',
                menu_help_desc: 'App information',
                menu_settings: 'Settings',
                menu_settings_desc: 'App Configuration',
                menu_db_manager: 'Database Manager',
                menu_db_desc: 'DBeaver Lite Console',
                menu_logout: 'Log Out',
                menu_logout_desc: 'Exit this session',
                menu_role: 'Role',
                menu_status_active: 'Active',

                fav_fields: 'Favorite Fields',
                view_all: 'View All',
                ai_base_title: 'Deep-AI Analysis Base',
                ai_base_subtitle: 'Automated validaton every 24h',
                explore: 'Explore',

                // Bidang Detail
                fd_choose_colleague: 'Choose Colleague',
                fd_search_colleague: 'Search name...',
                fd_not_found: 'Employee not found',
                fd_expert_hub: 'Expert Hub',
                fd_tab_diskusi: 'Discussion',
                fd_tab_materi: 'Material',
                fd_tab_ahli: 'EXPERT',
                fd_list_diskusi: 'Discussion List',
                fd_empty_diskusi: 'No discussion topic yet in this field.',
                fd_modul_title: 'Learning Module',
                fd_btn_add_materi: 'Add Material',
                fd_expert_title: 'Expert Consultation & Discussion',
                fd_expert_placeholder: 'Share expert thoughts in',
                fd_public_chat: 'Public Conversation',
                fd_chat_empty: 'No messages yet. Start a conversation!',
                fd_chat_placeholder: 'Type a message...',
                fd_confirm_delete_diskusi: 'Delete this discussion?',
                fd_alert_colleague_added: 'Colleague successfully linked to this field.',
                fd_alert_joined: 'already joined this discussion.',
                fd_alert_diskusi_added: 'successfully added to discussion:',

                // Home
                welcome_morning: 'Good Morning',
                welcome_afternoon: 'Good Afternoon',
                welcome_evening: 'Good Evening',
                welcome_night: 'Good Night',
                search_placeholder_internal: 'Search fields...',
                search_placeholder_google: 'Type & search in Google...',
                search_placeholder_chatgpt: 'Ask AI (ChatGPT)...',
                search_placeholder_youtube: 'Search video guides...',
                quick_menu_profil: 'My Profile',
                quick_menu_notif: 'Notifications',
                quick_menu_history: 'Discussion History',
                quick_menu_help: 'Help Center',
                quick_menu_settings: 'Settings',
                quick_menu_logout: 'Log Out',
                knowledge_trending: 'TRENDING',
                knowledge_report_title: 'Deep-AI Analysis Report',
                knowledge_report_subtitle: 'Real-time Google Data + AI Synchronization',
                knowledge_solution_title: 'SOLUTION & IMPROVEMENT STEPS',
                knowledge_btn_copy: 'Copy Solution',
                knowledge_btn_share: 'Share',
                knowledge_btn_close: 'Close Report',

                // Bidang
                field_title: 'Skill Fields',
                field_search_placeholder: 'Search your expertise...',
                field_topics: 'TOPICS',
                field_detail_expert_hub: 'Expert Hub',
                field_detail_tab_discuss: 'Discussion',
                field_detail_tab_module: 'Module',
                field_detail_tab_expert: 'EXPERT',
                field_detail_public_chat: 'Public Conversation',
                field_detail_add_material: 'Add Material',
                field_detail_invite: 'Invite',
                field_detail_no_discuss: 'No discussion material in this field yet.',
                field_detail_add_material_prompt: 'Enter Material Title:',
                field_detail_chat_placeholder: 'Type a message...',
                field_detail_expert_placeholder: 'Share expert thoughts in ',

                // Pesan
                msg_title: 'Discussion History',
                msg_subtitle: 'Chat & Consultation',
                msg_inbox: 'Inbox',
                msg_archived: 'Archived',
                msg_contacts: 'Contacts',
                msg_search_placeholder: 'Search messages or friends...',
                msg_empty: 'Inbox is empty.',
                msg_clear_all: 'Clear All',

                // Notifikasi
                notif_title: 'Notifications',
                notif_all: 'All',
                notif_discuss: 'Messages & Discussions',
                notif_achievement: 'Achievement',
                notif_system: 'System',
                notif_empty: 'No notifications in this category.',

                // Anggota
                member_title: 'Members & Groups',
                member_tab_all: 'All',
                member_tab_friend: 'Friends',
                member_tab_group: 'Groups',
                member_tab_contribution: 'Contribution',
                member_search_placeholder: 'Search members or groups...',
                member_btn_follow: 'Follow',
                member_btn_following: 'Following',
                member_btn_chat: 'Send Message',
                member_group_create: 'Create Group',
                member_btn_remove_friend: 'Remove Friend',
                member_btn_add_friend: 'Add Friend',
                member_btn_delete_user: 'Delete User',
                member_group_new_title: 'Create New Group',
                member_group_label_name: 'Group Name',
                member_group_label_desc: 'Short Description',
                member_group_btn_create: 'Create Group Now',
                member_group_success: 'Group "{name}" successfully created! You have full access as Group Administrator.',
                member_heading_suggestion: 'New Connection Suggestions',
                member_heading_my_groups: 'My Groups',
                member_heading_all_members: 'Member List',
                member_heading_my_friends: 'My Friends',
                member_heading_leaderboard: 'Contribution Leaderboard',
                member_desc_leaderboard: 'Top contributors for groups and field discussions.',
                member_stat_contribution: 'CONTRIBUTION',
                member_stat_rating: 'RATING',
                member_stat_status: 'STATUS',
                member_performance_weekly: 'Weekly Performance',
                member_btn_view_group: 'View Group',
                member_empty_group: 'No Groups Yet',
                member_empty_group_desc: 'Create a new group to collaborate with your team.',
                member_btn_add: 'Add',
                member_no_found: 'No members found.',

                // Profil
                profile_title: 'My Profile',
                profile_subtitle: 'Manage account & preferences',
                profile_menu_summary: 'Summary',
                profile_menu_activity: 'Activity',
                profile_menu_security: 'Security',
                profile_menu_settings: 'Settings',
                profile_label_name: 'Full Name',
                profile_label_bio: 'Short Bio',
                profile_label_save: 'Save Changes',
                profile_stat_discuss: 'Discussions',
                profile_stat_solution: 'Solutions',
                profile_stat_points: 'Points',
                profile_skills_title: 'IT Skills',
                profile_activity_title: 'Activity History',
                profile_activity_empty: 'No activity recorded.',
                profile_privacy_title: 'Account Privacy',
                profile_privacy_desc: 'Private mode hides your name from public member lists.',
                profile_pass_title: 'Change Password',
                profile_pass_old: 'Old Password',
                profile_pass_new: 'New Password',
                profile_pref_display: 'Display Preferences',
                profile_lang_label: 'Language / Bahasa',
                profile_theme_label: 'App Theme',
                profile_config_app: 'App Configuration',
                profile_logout: 'Log Out',
                profile_delete_acc: 'Delete Permanent Account',
                profile_timezone: 'Time Zone',
                profile_update_success: 'Profile updated successfully!',
                profile_delete_confirm: '⚠️ WARNING: Are you sure you want to delete your account? This action cannot be undone.',
                profile_activity_update: 'Updating account profile',

                // Bantuan
                help_title: 'Help Center',
                help_subtitle: 'Support Center',
                help_tab_general: 'General',
                help_tab_faq: 'FAQ',
                help_tab_contact: 'Contact Us',
                help_ver: 'Version',
                help_dev: 'Developer',
                help_need_more: 'Need More Help?',
                help_btn_email: 'Email IT Support'
            }
        };

        const getT = (lang) => TRANSLATIONS[lang] || TRANSLATIONS.id;

        const QuestionCard = ({ user, title, tags, comments = 0, participants = [], onReply, onAddColleague, onDelete }) => {
            return (
                <div className="card animate">
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                        <div style={{ width: 36, height: 36, borderRadius: '50%', background: 'linear-gradient(45deg, #6366f1, #ec4899)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontWeight: 700, fontSize: 14 }}>{user[0]}</div>
                        <div>
                            <div style={{ fontSize: '14px', fontWeight: '600' }}>{user}</div>
                            <div style={{ fontSize: '11px', color: 'var(--text-gray)' }}>Baru saja</div>
                        </div>
                    </div>
                    <div style={{ fontSize: '16px', fontWeight: '700', marginBottom: '8px' }}>{title}</div>
                    <div style={{ display: 'flex', gap: '4px', marginBottom: '12px' }}>
                        {tags.map(t => <span key={t} className="tag" style={{ textTransform: 'uppercase', fontSize: '10px' }}>{t}</span>)}
                    </div>

                    {participants.length > 0 && (
                        <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
                            <div style={{ display: 'flex', marginLeft: 4 }}>
                                {participants.slice(0, 3).map((p, i) => (
                                    <img
                                        key={i}
                                        src={p.image || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=random&color=fff`}
                                        style={{ width: 20, height: 20, borderRadius: '50%', border: '2px solid var(--bg-card)', marginLeft: i === 0 ? 0 : -8 }}
                                        title={p.name}
                                    />
                                ))}
                                {participants.length > 3 && (
                                    <div style={{ width: 20, height: 20, borderRadius: '50%', background: 'rgba(255,255,255,0.1)', border: '2px solid var(--bg-card)', marginLeft: -8, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 8, color: 'white' }}>
                                        +{participants.length - 3}
                                    </div>
                                )}
                            </div>
                            <span style={{ fontSize: 10, color: 'var(--text-gray)' }}>{participants.length} Rekan Bergabung</span>
                        </div>
                    )}

                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px', paddingTop: '12px', borderTop: '1px solid rgba(255,255,255,0.05)' }}>
                        <div onClick={onReply} style={{ display: 'flex', alignItems: 'center', gap: '6px', color: 'var(--primary)', fontSize: '12px', cursor: 'pointer', fontWeight: '600' }}>
                            <Icon name="message-circle" size={16} />
                            <span>{comments} Balasan</span>
                        </div>
                        <div onClick={onAddColleague} style={{ display: 'flex', alignItems: 'center', gap: '6px', color: 'var(--text-gray)', fontSize: '12px', cursor: 'pointer' }}>
                            <Icon name="user-plus" size={16} />
                            <span style={{ color: participants.some(p => p.name === user) ? 'var(--primary)' : 'inherit' }}>Ikut Serta</span>
                        </div>
                        <div onClick={(e) => { e.stopPropagation(); globalShare({ title: 'Diskusi IT', text: `Yuk bantu jawab diskusi ini: "${title}"` }); }} style={{ display: 'flex', alignItems: 'center', gap: '6px', color: 'var(--text-gray)', fontSize: '12px', cursor: 'pointer' }}>
                            <Icon name="share-2" size={16} />
                        </div>
                        {onDelete && (
                            <div onClick={(e) => { e.stopPropagation(); onDelete(); }} style={{ display: 'flex', alignItems: 'center', gap: '6px', color: '#EF4444', fontSize: '12px', cursor: 'pointer', marginLeft: 'auto' }}>
                                <Icon name="trash-2" size={16} />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const KNOWLEDGE_BASE = [
            {
                id: 'wifi', icon: 'wifi-off', color: '#3B82F6',
                title: "Masalah Koneksi WiFi Kantor pada Windows 11",
                trendInfo: "Muncul 12x di Grup Diskusi hari ini",
                question: "Kenapa banyak laptop karyawan tidak bisa terkoneksi ke WiFi kantor (SSID: Kantor_Utama) setelah menjalankan update Windows 11 versi 23H2 secara massal?",
                desc: "Evaluasi Otomatis: Gagal autentikasi protokol WPA3 pada infrastruktur legacy.",
                aiCrawling: "AI mendeteksi lonjakan diskusi di 12 forum IT internasional. Analisa pola menunjukkan kegagalan pada lapisan 'WLAN AutoConfig Service'. AI telah merangkum analisa dari 50+ laporan troubleshooting serupa dalam 24 jam terakhir.",
                googleInsight: "Google Search Data Highlights: \n- Trending Keywords: 'Windows 11 KB503 WiFi issue'\n- Top Reference: Microsoft Official Thread ID #9921 memvalidasI adanya bug driver pada chip Intel AX seri-AX.\n- Solusi Terpopuler di Google: Rolling back driver atau menonaktifkan fitur 802.11ax di properti adapter.",
                analysis: "Hasil Evaluasi Gabungan (Google Support & Deep-AI): \n\n**Akar Masalah:** \nKetidakcocokan power management chip WiFi Windows 11 dengan standar 802.11ax. Terdeteksi 85% kegagalan terjadi pada Access Point seri-H. \n\n**Langkah Pemecahan:** \n1. Buka Device Manager > Network Adapters. \n2. Pilih Driver WiFi > Properties > Power Management. \n3. Hilangkan centang pada 'Allow computer to turn off this device'. \n4. Paksa update driver ke versi Enterprise 22.40.1."
            },
            {
                id: 'node', icon: 'server', color: '#10B981',
                title: "Error Runtime: Heap Out of Memory di Node.js",
                trendInfo: "Isu Populer di Bidang Backend",
                question: "Aplikasi backend HRIS tiba-tiba crash dengan pesan 'v8: Fatal error in manages heap' saat melakukan proses export database tahunan.",
                desc: "Evaluasi Otomatis: Kebocoran memori pada proses asinkronus skala besar.",
                aiCrawling: "AI menscan repository internal dan forum StackOverflow. Terdeteksi adanya loop tak berujung (infinity loop) pada modul 'excel-export-service'. AI menyarankan penggunaan stream API untuk data besar.",
                googleInsight: "Google Search Data Highlights: \n- Trending Keywords: 'Nodejs heap out of memory export large csv'\n- Top Reference: Node.js Documentation Section 'Memory Management'.\n- Forum Suggestion: Meningkatkan limit memory V8 menggunakan flag --max-old-space-size.",
                analysis: "Analisa Komprehensif AI + Google Cloud Logging: \n\n**Akar Masalah:** \nPenumpukan Zombie Objects pada event loop akibat closure yang tidak di-release. Terdeteksi kebocoran pada file `socket-handler.js`. \n\n**Langkah Pemecahan:** \n1. Jalankan aplikasi dengan flag `--max-old-space-size=4096`. \n2. Tambahkan `global.gc()` pada bagian krusial proses. \n3. Lakukan audit memori menggunakan `node-inspect` untuk menemukan referensi sirkular."
            },
            {
                id: 'printer', icon: 'printer', color: '#F59E0B',
                title: "Konflik Driver Printer HP di MacOS Sonoma",
                trendInfo: "Trend di Bidang Hardware",
                question: "User melaporkan printer HP LaserJet tidak terdeteksi di MacOS Sonoma padahal kabel USB sudah terhubung dengan baik.",
                desc: "Evaluasi Otomatis: Isu kompatibilitas AirPrint pada Apple Silicon.",
                aiCrawling: "AI memantau rilis driver terbaru dari vendor HP dan Apple Support. Terdeteksi bahwa MacOS Sonoma menghapus dukungan untuk driver arsitektur x86 lama.",
                googleInsight: "Google Search Data Highlights: \n- Trending Keywords: 'MacOS Sonoma HP printer driver missing'\n- Top Reference: Apple Communities thread tentang 'Legacy Printer Support removed'.\n- Google Solution: Menggunakan Generic PostScript Driver atau aplikasi HP Smart.",
                analysis: "Hasil Crawling Google Support & AI Analysis: \n\n**Akar Masalah:** \nMacOS Sonoma memblokir legacy driver extensions (KEXT) demi keamanan. Modul HP Utility versi lama tidak memiliki signature yang valid. \n\n**Langkah Pemecahan:** \n1. Uninstal semua driver HP lama dari System Settings. \n2. Download HP Smart App versi terbaru dari App Store. \n3. Tambahkan printer secara manual menggunakan protokol 'IP Printing' (JetDirect-Socket)."
            },
            {
                id: 'security', icon: 'shield-alert', color: '#EF4444',
                title: "Deteksi Unauthorized Login Attempt di VPN",
                trendInfo: "Peringatan Keamanan Sistem",
                question: "Terdeteksi 100+ percobaan login gagal dari IP luar negeri pada dashboard admin VPN dalam waktu 10 menit.",
                desc: "Evaluasi Otomatis: Pola serangan brute-force terdeteksi pada gateway.",
                aiCrawling: "AI mengintegrasikan data dari database ancaman global (Threat Intel). Terdeteksi IP penyerang berasal dari botnet yang sedang aktif menyerang infrastruktur VPN serupa di Asia Tenggara.",
                googleInsight: "Google Search Data Highlights: \n- Trending Keywords: 'CVE-2024 VPN brute force attack'\n- Top Reference: Fortinet Security Advisory.\n- Google Solution: Mengaktifkan Geo-Blocking dan rate limiting IP.",
                analysis: "Analisa Keamanan AI Terintegrasi Security-Cloud: \n\n**Akar Masalah:** \nUpaya login berulang dari 15 IP publik berbeda dalam rentang waktu 5 menit. Terindikasi sebagai serangan Credential Stuffing. \n\n**Langkah Pemecahan:** \n1. Blokir range IP penyerang pada level Firewall gateway. \n2. Aktifkan wajib Multi-Factor Authentication (MFA) untuk semua akun VPN. \n3. Lakukan sinkronisasi ulang kredensial via Active Directory."
            }
        ];



        // --- PAGES ---

        // Splash Screen
        const Splash = ({ onFinish, t }) => {
            useEffect(() => {
                const timer = setTimeout(() => onFinish(), 2500);
                return () => clearTimeout(timer);
            }, [onFinish]);

            return (
                <div className="splash-screen animate" style={{
                    background: 'radial-gradient(circle at center, #1a1c23 0%, #000000 100%)',
                    perspective: '1000px'
                }}>
                    <style>
                        {`
                        @keyframes float {
                            0% { transform: translateY(0px) rotateX(0deg); }
                            50% { transform: translateY(-20px) rotateX(5deg); }
                            100% { transform: translateY(0px) rotateX(0deg); }
                        }
                        @keyframes pulse-glow {
                            0% { box-shadow: 0 0 50px rgba(255, 215, 0, 0.1); }
                            50% { box-shadow: 0 0 100px rgba(255, 215, 0, 0.3); }
                            100% { box-shadow: 0 0 50px rgba(255, 215, 0, 0.1); }
                        }
                        `}
                    </style>
                    <div style={{
                        position: 'relative',
                        animation: 'float 4s ease-in-out infinite'
                    }}>
                        {/* Main Logo Container */}
                        <div style={{
                            width: 'clamp(250px, 70vw, 350px)',
                            height: 'auto',
                            minHeight: '250px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            animation: 'pulse-glow 3s infinite',
                            position: 'relative',
                            zIndex: 2,
                            padding: '20px'
                        }}>
                            <img src="WhatsApp Image 2026-02-01 at 20.04.56.jpeg" alt="MR Tech Logo" style={{
                                width: '100%',
                                maxWidth: '100%',
                                height: 'auto',
                                objectFit: 'contain',
                                filter: 'drop-shadow(0 0 30px rgba(255, 215, 0, 0.4))', // Enhanced Gold Glow
                                transform: 'translateZ(50px)'
                            }} />

                            {/* Subtle Shine Overlay (Optional, adjusted for non-circle) */}
                            <div style={{
                                position: 'absolute',
                                top: 0, left: 0, right: 0, bottom: 0,
                                background: 'radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), transparent 70%)',
                                pointerEvents: 'none',
                                mixBlendMode: 'overlay'
                            }}></div>
                        </div>

                        {/* Reflection Shadow */}
                        <div style={{
                            width: '80%',
                            height: 20,
                            background: 'radial-gradient(ellipse at center, rgba(255, 215, 0, 0.3) 0%, transparent 70%)',
                            position: 'absolute',
                            bottom: -50,
                            left: '10%',
                            borderRadius: '50%',
                            filter: 'blur(10px)',
                            transform: 'scaleY(0.5)',
                            opacity: 0.6,
                            animation: 'pulse-glow 3s infinite reverse'
                        }}></div>
                    </div>
                </div>
            );
        };

        const Onboarding = ({ step, onNext, t }) => {
            const data = [
                { title: t.onboarding_1_title, desc: t.onboarding_1_desc, icon: 'wrench' },
                { title: t.onboarding_2_title, desc: t.onboarding_2_desc, icon: 'check-circle' },
                { title: t.onboarding_3_title, desc: t.onboarding_3_desc, icon: 'users' }
            ][step];

            // Inline styles for the responsive layout
            const styles = {
                container: {
                    width: '100%',
                    height: '100vh',
                    display: 'flex',
                    flexDirection: 'column', // Mobile default: Vertical Stack
                    position: 'relative',
                    overflow: 'hidden',
                    background: '#0a0c10'
                },
                // Visual Side (Top on Mobile, Left on Desktop)
                visualSide: {
                    flex: 1,
                    position: 'relative',
                    background: 'linear-gradient(to bottom, rgba(10, 12, 16, 0.4), rgba(10, 12, 16, 0.9)), url("RAMA.jpeg")',
                    backgroundSize: 'cover',
                    backgroundPosition: 'center',
                    backgroundRepeat: 'no-repeat',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    transition: 'all 0.5s cubic-bezier(0.23, 1, 0.32, 1)'
                },
                // Content Side (Bottom on Mobile, Right on Desktop)
                contentSide: {
                    padding: '40px',
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'flex-end', // Mobile: text at bottom
                    zIndex: 10,
                    transition: 'all 0.5s ease'
                },
                // Desktop Overrides (Applied via class-like conditional logic in JSX slightly limited, so using media query style block)
            };

            return (
                <div className="onboarding-screen animate" style={{
                    padding: 0,
                    display: 'flex',
                    width: '100%',
                    height: '100vh',
                    overflow: 'hidden'
                }}>
                    <style>
                        {`
                        .onboarding-layout {
                            display: flex;
                            flex-direction: column;
                            width: 100%;
                            height: 100%;
                            background: #0a0c10;
                        }
                        /* --- Mobile: Vertical Stack (Image Top, Content Bottom) --- */
                        .onboarding-visual {
                            flex: 1; /* Takes remaining space */
                            width: 100%;
                            /* 'center top' ensures face is visible if it's a portrait */
                            background: linear-gradient(to bottom, rgba(10, 12, 16, 0.1), rgba(10, 12, 16, 1)), url("RAMA.jpeg");
                            background-size: cover;
                            background-position: center top; 
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            position: relative;
                            min-height: 50%; /* Ensure image gets at least 50% screen */
                        }
                        .onboarding-content-panel {
                            position: relative; /* No longer absolute/overlay */
                            width: 100%;
                            padding: 30px 24px 40px; /* More bottom padding for safe area */
                            background: #0a0c10; /* Solid background */
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: flex-start;
                            z-index: 10;
                            box-shadow: 0 -20px 40px rgba(0,0,0,0.5); /* Shadow to blend upwards */
                        }
                        
                        /* --- Desktop: Split Row (Side-by-Side) --- */
                        @media (min-width: 768px) {
                            .onboarding-layout {
                                flex-direction: row;
                            }
                            .onboarding-visual {
                                flex: 1.2;
                                height: 100%; /* Full height */
                                background: linear-gradient(to right, rgba(10, 12, 16, 0.2), rgba(10, 12, 16, 0.8)), url("RAMA.jpeg");
                                background-size: cover;
                                background-position: center top;
                                border-right: 1px solid rgba(255,255,255,0.05);
                                order: 1; 
                            }
                            .onboarding-content-panel {
                                flex: 1;
                                height: 100%; /* Full height */
                                background: var(--bg-card);
                                padding: 60px;
                                justify-content: center;
                                border-left: 1px solid var(--border);
                                order: 2; 
                                background: #0a0c10;
                                box-shadow: none;
                            }
                            .onboarding-title {
                                font-size: 42px !important;
                                text-align: left !important;
                                align-self: flex-start;
                            }
                            .onboarding-desc {
                                text-align: left !important;
                                font-size: 18px !important;
                                align-self: flex-start;
                                max-width: 450px;
                                margin-bottom: 40px !important;
                            }
                            .onboarding-btn-wrapper {
                                margin-top: 20px;
                                width: 100%;
                                display: flex;
                                justify-content: flex-start;
                            }
                            .step-indicator {
                                justify-content: flex-start !important;
                                margin-bottom: 40px !important;
                            }
                            .visual-icon-wrapper {
                                width: 180px !important;
                                height: 180px !important;
                            }
                        }
                        `}
                    </style>

                    <div className="onboarding-layout">
                        {/* Left/Top Visual Panel */}
                        <div className="onboarding-visual">
                            {/* Floating 3D Icon */}
                            <div className="visual-icon-wrapper animate" style={{
                                width: '120px',
                                height: '120px',
                                background: 'rgba(255,255,255,0.05)',
                                backdropFilter: 'blur(20px)',
                                borderRadius: '50%',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                boxShadow: '0 20px 60px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.1)',
                                transform: 'translateY(-20px)',
                                transition: 'all 0.5s cubic-bezier(0.23, 1, 0.32, 1)'
                            }}>
                                <div style={{
                                    filter: 'drop-shadow(0 0 20px rgba(99, 102, 241, 0.6))',
                                    animation: 'float 3s ease-in-out infinite'
                                }}>
                                    <Icon name={data.icon} size={60} color="white" />
                                </div>
                            </div>
                        </div>

                        {/* Right/Bottom Content Panel */}
                        <div className="onboarding-content-panel">
                            {/* Step Dots */}
                            <div className="step-indicator" style={{ display: 'flex', gap: 8, marginBottom: 20, width: '100%', justifyContent: 'center' }}>
                                {[0, 1, 2].map(i => (
                                    <div key={i} style={{
                                        width: i === step ? 32 : 8, height: 8, borderRadius: 4,
                                        background: i === step ? 'var(--primary)' : 'rgba(255,255,255,0.2)',
                                        transition: 'all 0.3s cubic-bezier(0.23, 1, 0.32, 1)'
                                    }} />
                                ))}
                            </div>

                            <h1 className="onboarding-title" style={{
                                fontSize: '32px', fontWeight: 800, marginBottom: 16, lineHeight: 1.2, width: '100%', textAlign: 'center'
                            }}>
                                {data.title}
                            </h1>

                            <p className="onboarding-desc" style={{
                                color: 'var(--text-gray)', fontSize: '15px', lineHeight: 1.6, marginBottom: 30, width: '100%', textAlign: 'center', opacity: 0.8
                            }}>
                                {data.desc}
                            </p>

                            <div className="onboarding-btn-wrapper" style={{ width: '100%' }}>
                                <button onClick={onNext} style={{
                                    width: '100%',
                                    padding: '18px',
                                    background: step === 2
                                        ? 'linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%)'
                                        : 'rgba(255,255,255,0.1)',
                                    border: step === 2 ? 'none' : '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '16px',
                                    color: 'white',
                                    fontSize: '16px',
                                    fontWeight: '700',
                                    cursor: 'pointer',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 10,
                                    boxShadow: step === 2 ? '0 10px 30px rgba(99, 102, 241, 0.4)' : 'none',
                                    transition: 'all 0.3s ease'
                                }}>
                                    {step === 2 ? t.onboarding_start : t.onboarding_next}
                                    <Icon name={step === 2 ? "rocket" : "arrow-right"} size={18} />
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Auth Screen
        const Auth = ({ onLogin, t }) => {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [otp, setOtp] = useState('');
            const [generatedOtp, setGeneratedOtp] = useState(null);
            const [showPassword, setShowPassword] = useState(false); // State for toggle visibility

            // Auth Mode: 'login', 'register', 'forgot_email', 'forgot_otp', 'forgot_reset'
            const [authMode, setAuthMode] = useState('login');
            const [socialType, setSocialType] = useState(null);
            const [rememberMe, setRememberMe] = useState(false);

            useEffect(() => {
                const savedEmail = localStorage.getItem('remember_email');
                if (savedEmail) {
                    setEmail(savedEmail);
                    setRememberMe(true);
                }
            }, []);

            const handleSubmit = () => {
                if (!email || !password) { alert(t.auth_err_required); return; }

                if (authMode === 'register') {
                    // Register Validation
                    if (!name) { alert(t.auth_err_name); return; }
                    if (password !== confirmPassword) { alert(t.auth_err_match); return; }
                    if (password.length < 6) { alert(t.auth_err_length); return; }
                }

                // Handle Remember Me logic
                if (authMode === 'login') {
                    if (rememberMe) {
                        localStorage.setItem('remember_email', email);
                    } else {
                        localStorage.removeItem('remember_email');
                    }
                }

                // Call parent handler with object
                onLogin({ name, email, password, isRegister: authMode === 'register' });
            };

            const handleSendOtp = () => {
                if (!email) { alert(t.auth_err_email_required); return; }

                // Check DB using redis helper
                const users = redis.get('users_db', []);
                const user = users.find(u => u.email === email);

                if (!user) {
                    alert(t.auth_err_email_not_found);
                    return;
                }

                // Generate OTP
                const code = Math.floor(100000 + Math.random() * 900000).toString();
                setGeneratedOtp(code);
                alert(`Kode OTP: ${code}`); // Simulate Email Sending
                setAuthMode('forgot_otp');
            };

            const handleVerifyOtp = () => {
                if (otp === generatedOtp) {
                    setAuthMode('forgot_reset');
                } else {
                    alert(t.auth_err_otp);
                }
            };

            const handleResetPassword = () => {
                if (password.length < 6) { alert(t.auth_err_length); return; }
                if (password !== confirmPassword) { alert(t.auth_err_match); return; }

                // Update Password in DB using redis
                const users = redis.get('users_db', []);
                const updatedUsers = users.map(u => {
                    if (u.email === email) {
                        return { ...u, password: password };
                    }
                    return u;
                });
                redis.set('users_db', updatedUsers);

                alert(t.auth_msg_reset_success);
                setAuthMode('login');
                setPassword('');
                setConfirmPassword('');
                setOtp('');
            };

            // Force full width centering by removing sidebar padding
            useEffect(() => {
                const root = document.getElementById('root');
                const originalStyle = root.style.paddingLeft;

                // Force reset padding
                root.style.paddingLeft = '0px';
                root.style.justifyContent = 'center';

                return () => {
                    // Restore on cleanup
                    root.style.paddingLeft = '';
                    root.style.justifyContent = ''; // Reset to default
                };
            }, []);

            const inputStyle = {
                width: '100%',
                padding: '16px 16px 16px 48px',
                background: 'rgba(255,255,255,0.05)',
                border: '1px solid rgba(255,255,255,0.1)',
                borderRadius: 14,
                color: 'white',
                fontSize: 15,
                fontFamily: 'inherit',
                transition: 'all 0.3s ease',
                outline: 'none'
            };

            const labelIconStyle = {
                position: 'absolute',
                left: 16,
                top: '50%',
                transform: 'translateY(-50%)',
                fontSize: 18,
                opacity: 0.6
            };

            // Social Login Simulation (Auto-Login Mock)
            if (socialType) {
                // Simulate auto-login process
                setTimeout(() => {
                    const mockEmail = socialType === 'google' ? 'googleuser@gmail.com' : 'msuser@outlook.com';
                    const mockName = socialType === 'google' ? 'Google User' : 'Microsoft User';

                    onLogin({
                        name: mockName,
                        email: mockEmail,
                        password: 'social-login',
                        isRegister: true // Forces "Upsert" logic in handleLogin (Login if exists, Register if new)
                    });
                }, 1500);

                return (
                    <div className="auth-screen animate" style={{
                        display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px'
                    }}>
                        <div style={{
                            background: 'rgba(255,255,255,0.03)',
                            backdropFilter: 'blur(30px) saturate(150%)',
                            padding: '40px',
                            borderRadius: '32px',
                            border: '1px solid rgba(255,255,255,0.1)',
                            width: '100%', maxWidth: '360px', textAlign: 'center'
                        }}>
                            <div className="animate-pulse" style={{ width: 60, height: 60, borderRadius: '50%', background: socialType === 'google' ? '#dc2626' : '#2563eb', margin: '0 auto 20px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                {socialType === 'google' ? (
                                    <svg width="30" height="30" viewBox="0 0 24 24" fill="white"><path d="M12.48 10.92v3.28h7.84c-.24 1.84-.92 3.2-1.84 4.32-1.04 1.28-2.6 2.4-5.44 2.4-4.8 0-8.68-3.88-8.68-8.68s3.88-8.68 8.68-8.68c2.6 0 4.56.92 6 2.32l2.32-2.32C21.04 1.28 17.6 0 12.4 0 5.6 0 0 5.48 0 12.4s5.6 12.4 12.4 12.4c3.6 0 6.36-1.2 8.52-3.44 2.24-2.24 2.8-5.36 2.8-7.88 0-.52-.04-1.04-.12-1.56H12.48z" /></svg>
                                ) : (
                                    <svg width="30" height="30" viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="white" /><rect x="11" y="1" width="9" height="9" fill="white" /><rect x="1" y="11" width="9" height="9" fill="white" /><rect x="11" y="11" width="9" height="9" fill="white" /></svg>
                                )}
                            </div>
                            <h3 style={{ fontSize: 18, color: 'white', marginBottom: 10 }}>{t.auth_social_connecting.replace('{type}', socialType.charAt(0).toUpperCase() + socialType.slice(1))}</h3>
                            <p style={{ fontSize: 13, color: 'rgba(255,255,255,0.6)' }}>{t.auth_social_wait}</p>

                            <button onClick={() => setSocialType(null)} style={{ marginTop: 24, background: 'none', border: 'none', color: 'rgba(255,255,255,0.4)', fontSize: 12, cursor: 'pointer' }}>{t.cancel}</button>
                        </div>
                    </div>
                );
            }

            return (
                <Background3D color1="#7c3aed" color2="#ec4899">
                    <div className="auth-screen animate">
                        {/* Main Card Container */}
                        <div style={{
                            position: 'relative',
                            zIndex: 1,
                            background: 'rgba(255,255,255,0.03)',
                            backdropFilter: 'blur(30px) saturate(150%)',
                            borderRadius: 24,
                            padding: 'clamp(20px, 5vw, 30px)',
                            border: '1px solid rgba(255,255,255,0.1)',
                            boxShadow: '0 25px 50px -12px rgba(0,0,0,0.5)',
                            maxWidth: 380,
                            width: 'calc(100% - 32px)',
                            margin: 'auto',
                            maxHeight: '95vh',
                            display: 'flex',
                            flexDirection: 'column',
                            justifyContent: 'center',
                            overflowY: 'auto'
                        }}>
                            <div style={{ textAlign: 'center', marginBottom: 20, flexShrink: 0 }}>
                                <div style={{
                                    width: 60,
                                    height: 60,
                                    margin: '0 auto 10px',
                                    background: 'linear-gradient(145deg, #7c3aed, #4f46e5)',
                                    borderRadius: 10,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: 32,
                                    boxShadow: '0 15px 35px rgba(99, 102, 241, 0.5), inset 0 -4px 12px rgba(0,0,0,0.2), inset 0 4px 12px rgba(255,255,255,0.2)',
                                    transform: 'perspective(500px) rotateX(5deg)',
                                    border: '2px solid rgba(255,255,255,0.15)',
                                    overflow: 'hidden'
                                }}>
                                    <img src="RAMA.jpeg" alt="Logo" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                </div>
                                <h1 style={{
                                    fontSize: '28px',
                                    fontWeight: '900',
                                    color: '#FF4D4D',
                                    textShadow: '1px 1px 0 #C70039, 2px 2px 0 #900C3F, 3px 3px 0 #581845, 4px 4px 10px rgba(0,0,0,0.5)',
                                    marginBottom: 4,
                                    letterSpacing: '2px',
                                    textTransform: 'uppercase'
                                }}>
                                    {authMode === 'login' ? t.auth_welcome :
                                        authMode === 'register' ? t.auth_create_acc :
                                            authMode === 'forgot_email' ? t.auth_forgot_pass :
                                                authMode === 'forgot_otp' ? t.auth_verify_otp : t.auth_reset_pass}
                                </h1>
                                <p style={{ color: 'rgba(255,255,255,0.5)', fontSize: 13 }}>
                                    {authMode === 'login' ? t.auth_login_subtitle :
                                        authMode === 'register' ? t.auth_register_subtitle :
                                            authMode === 'forgot_email' ? t.auth_forgot_subtitle :
                                                authMode === 'forgot_otp' ? t.auth_otp_sent : t.auth_reset_subtitle}
                                </p>
                            </div>

                            {/* Social Login & Form Fields Group */}
                            {(authMode === 'login' || authMode === 'register') && (
                                <>
                                    {/* Social Login */}
                                    <div style={{ display: 'flex', gap: 10, marginBottom: 20 }}>
                                        <button
                                            onClick={() => setSocialType('google')}
                                            style={{
                                                flex: 1,
                                                padding: '12px',
                                                background: '#dc2626',
                                                border: 'none',
                                                borderRadius: 12,
                                                color: 'white',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: 8,
                                                fontSize: 13,
                                                fontWeight: 500,
                                                fontFamily: 'inherit',
                                                transition: 'all 0.2s'
                                            }}>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="white">
                                                <path d="M12.48 10.92v3.28h7.84c-.24 1.84-.92 3.2-1.84 4.32-1.04 1.28-2.6 2.4-5.44 2.4-4.8 0-8.68-3.88-8.68-8.68s3.88-8.68 8.68-8.68c2.6 0 4.56.92 6 2.32l2.32-2.32C21.04 1.28 17.6 0 12.4 0 5.6 0 0 5.48 0 12.4s5.6 12.4 12.4 12.4c3.6 0 6.36-1.2 8.52-3.44 2.24-2.24 2.8-5.36 2.8-7.88 0-.52-.04-1.04-.12-1.56H12.48z" />
                                            </svg>
                                            <span>Google</span>
                                        </button>
                                        <button
                                            onClick={() => setSocialType('microsoft')}
                                            style={{
                                                flex: 1,
                                                padding: '12px',
                                                background: '#2563eb',
                                                border: 'none',
                                                borderRadius: 12,
                                                color: 'white',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: 8,
                                                fontSize: 13,
                                                fontWeight: 500,
                                                fontFamily: 'inherit',
                                                transition: 'all 0.2s'
                                            }}>
                                            <svg width="14" height="14" viewBox="0 0 21 21" fill="white">
                                                <rect x="1" y="1" width="9" height="9" fill="white" />
                                                <rect x="11" y="1" width="9" height="9" fill="white" />
                                                <rect x="1" y="11" width="9" height="9" fill="white" />
                                                <rect x="11" y="11" width="9" height="9" fill="white" />
                                            </svg>
                                            <span>Microsoft</span>
                                        </button>
                                    </div>

                                    {/* Divider */}
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 12, margin: '20px 0' }}>
                                        <div style={{ flex: 1, height: 1, background: 'rgba(255,255,255,0.1)' }}></div>
                                        <span style={{ color: 'rgba(255,255,255,0.4)', fontSize: 11, textTransform: 'uppercase', letterSpacing: 1 }}>{t.auth_or}</span>
                                        <div style={{ flex: 1, height: 1, background: 'rgba(255,255,255,0.1)' }}></div>
                                    </div>

                                    {/* Form Fields */}
                                    {authMode === 'register' && (
                                        <div style={{ position: 'relative', marginBottom: 14 }}>
                                            <span style={{ ...labelIconStyle, filter: 'drop-shadow(0 2px 3px rgba(0,0,0,0.3))' }}>
                                                <Icon name="user" size={20} />
                                            </span>
                                            <input
                                                type="text"
                                                placeholder={t.auth_label_name}
                                                value={name}
                                                onChange={e => setName(e.target.value)}
                                                style={inputStyle}
                                                onKeyDown={(e) => e.key === "Enter" && handleSubmit()}
                                            />
                                        </div>
                                    )}

                                    <div style={{ position: 'relative', marginBottom: 14 }}>
                                        <span style={{ ...labelIconStyle, filter: 'drop-shadow(0 2px 3px rgba(0,0,0,0.3))' }}>
                                            <Icon name="mail" size={20} />
                                        </span>
                                        <input
                                            type="email"
                                            placeholder={t.auth_label_email}
                                            value={email}
                                            onChange={e => setEmail(e.target.value)}
                                            style={inputStyle}
                                            onKeyDown={(e) => e.key === "Enter" && handleSubmit()}
                                        />
                                    </div>

                                    <div style={{ position: 'relative', marginBottom: authMode === 'register' ? 14 : 8 }}>
                                        <span style={{ ...labelIconStyle, filter: 'drop-shadow(0 2px 3px rgba(0,0,0,0.3))' }}>
                                            <Icon name="lock" size={20} />
                                        </span>
                                        <input
                                            type={showPassword ? "text" : "password"}
                                            placeholder={t.auth_label_pass}
                                            value={password}
                                            onChange={e => setPassword(e.target.value)}
                                            style={inputStyle}
                                            onKeyDown={(e) => e.key === "Enter" && handleSubmit()}
                                        />
                                        <span
                                            onClick={() => setShowPassword(!showPassword)}
                                            style={{
                                                position: 'absolute',
                                                right: 16,
                                                top: '50%',
                                                transform: 'translateY(-50%)',
                                                cursor: 'pointer',
                                                opacity: 0.6,
                                                color: 'white',
                                                zIndex: 10
                                            }}>
                                            <Icon name={showPassword ? "eye" : "eye-off"} size={18} />
                                        </span>
                                    </div>

                                    {authMode === 'register' && (
                                        <div style={{ position: 'relative', marginBottom: 8 }}>
                                            <span style={{ ...labelIconStyle, filter: 'drop-shadow(0 2px 3px rgba(0,0,0,0.3))' }}>
                                                <Icon name="check-circle" size={20} />
                                            </span>
                                            <input
                                                type={showPassword ? "text" : "password"}
                                                placeholder={t.auth_label_confirm_pass}
                                                value={confirmPassword}
                                                onChange={e => setConfirmPassword(e.target.value)}
                                                style={inputStyle}
                                                onKeyDown={(e) => e.key === "Enter" && handleSubmit()}
                                            />
                                        </div>
                                    )}

                                    {authMode === 'login' && (
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                                            <label style={{ display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer', fontSize: 13, color: 'rgba(255,255,255,0.7)', fontWeight: 500 }}>
                                                <input
                                                    type="checkbox"
                                                    checked={rememberMe}
                                                    onChange={(e) => setRememberMe(e.target.checked)}
                                                    style={{ width: 16, height: 16, accentColor: '#6366f1', borderRadius: 4, cursor: 'pointer' }}
                                                />
                                                {t.auth_remember_me}
                                            </label>
                                            <span onClick={() => setAuthMode('forgot_email')} style={{ color: '#6366f1', fontSize: 12, cursor: 'pointer' }}>{t.auth_link_forgot}</span>
                                        </div>
                                    )}

                                    {authMode === 'register' && (
                                        <label style={{ display: 'flex', alignItems: 'center', gap: 10, marginTop: 12, marginBottom: 16, cursor: 'pointer' }}>
                                            <input type="checkbox" style={{ width: 18, height: 18, accentColor: '#6366f1', borderRadius: 4 }} />
                                            <span style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)', lineHeight: 1.4 }}>
                                                {t.auth_agree} <span style={{ color: '#6366f1' }}>{t.auth_tos}</span>
                                            </span>
                                        </label>
                                    )}

                                    <button
                                        onClick={handleSubmit}
                                        style={{
                                            width: '100%',
                                            padding: '16px',
                                            background: 'linear-gradient(135deg, #6366f1, #8b5cf6)',
                                            border: 'none',
                                            borderRadius: 14,
                                            color: 'white',
                                            fontSize: 15,
                                            fontWeight: 600,
                                            cursor: 'pointer',
                                            boxShadow: '0 8px 24px rgba(99, 102, 241, 0.35)',
                                            transition: 'all 0.3s ease',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: 8
                                        }}
                                    >
                                        {authMode === 'login' ? t.auth_btn_login : t.auth_btn_register} <Icon name="arrow-right" size={18} />
                                    </button>

                                    <p style={{ textAlign: 'center', marginTop: 20, fontSize: 13, color: 'rgba(255,255,255,0.5)' }}>
                                        {authMode === 'login' ? t.auth_no_acc : t.auth_have_acc}
                                        <span onClick={() => setAuthMode(authMode === 'login' ? 'register' : 'login')} style={{ color: '#6366f1', cursor: 'pointer', fontWeight: 600, marginLeft: 5 }}>
                                            {authMode === 'login' ? t.auth_btn_register : t.auth_btn_login}
                                        </span>
                                    </p>
                                </>
                            )}

                            {/* Forgot Password Flow */}
                            {authMode === 'forgot_email' && (
                                <div>
                                    <div style={{ position: 'relative', marginBottom: 20 }}>
                                        <span style={{ ...labelIconStyle }}><Icon name="mail" size={20} /></span>
                                        <input type="email" placeholder={t.auth_label_email} value={email} onChange={e => setEmail(e.target.value)} style={inputStyle} />
                                    </div>
                                    <button onClick={handleSendOtp} style={{ width: '100%', padding: '16px', background: '#6366f1', color: 'white', border: 'none', borderRadius: 14, cursor: 'pointer', fontWeight: 600 }}>
                                        {t.auth_btn_send_otp}
                                    </button>
                                    <button onClick={() => setAuthMode('login')} style={{ width: '100%', marginTop: 10, background: 'none', border: 'none', color: 'white', cursor: 'pointer' }}>
                                        {t.back}
                                    </button>
                                </div>
                            )}

                            {authMode === 'forgot_otp' && (
                                <div>
                                    <div style={{ position: 'relative', marginBottom: 20 }}>
                                        <span style={{ ...labelIconStyle }}><Icon name="key" size={20} /></span>
                                        <input type="text" placeholder={t.auth_label_otp} value={otp} onChange={e => setOtp(e.target.value)} style={inputStyle} />
                                    </div>
                                    <button onClick={handleVerifyOtp} style={{ width: '100%', padding: '16px', background: '#6366f1', color: 'white', border: 'none', borderRadius: 14, cursor: 'pointer', fontWeight: 600 }}>
                                        {t.auth_btn_verify_otp}
                                    </button>
                                </div>
                            )}

                            {authMode === 'forgot_reset' && (
                                <div>
                                    <div style={{ position: 'relative', marginBottom: 14 }}>
                                        <span style={{ ...labelIconStyle }}><Icon name="lock" size={20} /></span>
                                        <input type="password" placeholder={t.auth_label_pass} value={password} onChange={e => setPassword(e.target.value)} style={inputStyle} />
                                    </div>
                                    <div style={{ position: 'relative', marginBottom: 20 }}>
                                        <span style={{ ...labelIconStyle }}><Icon name="check-circle" size={20} /></span>
                                        <input type="password" placeholder={t.auth_label_confirm_pass} value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} style={inputStyle} />
                                    </div>
                                    <button onClick={handleResetPassword} style={{ width: '100%', padding: '16px', background: '#6366f1', color: 'white', border: 'none', borderRadius: 14, cursor: 'pointer', fontWeight: 600 }}>
                                        {t.auth_btn_reset_pass}
                                    </button>
                                </div>
                            )}

                        </div>
                    </div>
                </Background3D>
            );
        };

        // --- 3D Background Wrapper ---
        const Background3D = ({ children, color1, color2, showGrid = true }) => {
            return (
                <div className="page-container-3d">
                    <div className="bg-blob blob-1" style={{ background: color1 || 'var(--primary)' }}></div>
                    <div className="bg-blob blob-2" style={{ background: color2 || 'var(--secondary)' }}></div>
                    {showGrid && <div className="mesh-grid"></div>}
                    <div className="glass-panel-3d">
                        {children}
                    </div>
                </div>
            );
        };

        // --- Bidang (Categories) Screen ---
        const Bidang = ({ onBidangClick, getCategoryCount, t, categories: propCategories }) => {
            const defaultCategories = [
                { name: 'Hardware', icon: '🖥️', color: '#3B82F6' },
                { name: 'Software', icon: '💿', color: '#8B5CF6' },
                { name: 'Network', icon: '🌐', color: '#10B981' },
                { name: 'Security', icon: '🛡️', color: '#EF4444' },
                { name: 'Database', icon: '🗄️', color: '#F59E0B' },
                { name: 'Development', icon: '⚡', color: '#EC4899' },
                { name: 'Runtimes', icon: '🚀', color: '#F59E0B' },
                { name: 'Cloud', icon: '☁️', color: '#0EA5E9' }
            ];

            const displayCategories = propCategories || defaultCategories;

            return (
                <Background3D color1="var(--primary)" color2="var(--secondary)">
                    <div className="animate">
                        <header className="page-header" style={{
                            padding: '12px 16px 16px', borderBottomLeftRadius: 20, borderBottomRightRadius: 20,
                            background: 'linear-gradient(135deg, var(--primary), var(--secondary))'
                        }}>
                            <h1 style={{ fontSize: '20px', fontWeight: '800', color: 'white' }}>{t.field_title}</h1>
                            <div className="search-bar" style={{
                                background: 'rgba(255,255,255,0.2)', border: 'none',
                                marginTop: 10, padding: '8px 12px'
                            }}>
                                <Icon name="search" color="white" size={18} />
                                <input type="text" placeholder={t.field_search_placeholder} style={{ color: 'white', fontSize: 13 }} />
                            </div>
                        </header>
                        <div className="container" style={{ padding: '24px 0' }}>
                            <div className="grid-responsive">
                                {displayCategories.map(cat => (
                                    <div key={cat.name} className="card bidang-card" onClick={() => onBidangClick && onBidangClick(cat)} style={{
                                        '--glow-color': cat.color,
                                        position: 'relative'
                                    }}>
                                        <div className="category-glow-bg"></div>
                                        <div className="icon-container-3d">
                                            <div className="icon-box" style={{ fontSize: 'clamp(32px, 6vw, 44px)' }}>
                                                {cat.icon}
                                            </div>
                                            <div className="icon-shadow-3d"></div>
                                        </div>
                                        <div style={{
                                            fontSize: '14px',
                                            fontWeight: '800',
                                            color: 'white',
                                            marginBottom: 4,
                                            zIndex: 10
                                        }}>{cat.name}</div>
                                        <div style={{
                                            fontSize: '11px',
                                            color: cat.color,
                                            fontWeight: 700,
                                            textTransform: 'uppercase',
                                            letterSpacing: 1,
                                            zIndex: 10
                                        }}>{getCategoryCount ? getCategoryCount(cat.name) : 0} {t.field_topics}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </Background3D>
            );
        };

        const ChatInput = ({ onSend }) => {
            const [message, setMessage] = useState('');
            const [showEmojiPicker, setShowEmojiPicker] = useState(false);

            const handleSendClick = () => {
                if (message.trim()) {
                    onSend(message);
                    setMessage('');
                    setShowEmojiPicker(false);
                }
            };

            const handleEmojiSelect = (emoji) => {
                setMessage(prev => prev + emoji);
            };

            return (
                <div style={{ display: 'flex', alignItems: 'center', gap: 10, background: 'var(--bg-card)', padding: 10, borderRadius: 14, border: '1px solid var(--border)', position: 'relative' }}>
                    <button onClick={() => setShowEmojiPicker(!showEmojiPicker)} style={{ background: 'none', border: 'none', color: 'var(--text-gray)', cursor: 'pointer', padding: 5, display: 'flex', alignItems: 'center' }}>
                        <Icon name="smile" size={20} />
                    </button>
                    <input
                        type="text"
                        value={message}
                        onChange={(e) => setMessage(e.target.value)}
                        onKeyPress={(e) => { if (e.key === 'Enter') handleSendClick(); }}
                        placeholder="Ketik pesan..."
                        style={{ flex: 1, background: 'none', border: 'none', color: 'white', fontSize: 14, padding: '8px 0', outline: 'none' }}
                    />
                    <button onClick={handleSendClick} style={{ background: 'var(--primary)', border: 'none', borderRadius: 10, padding: '8px 12px', color: 'white', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 5 }}>
                        <Icon name="send" size={18} />
                    </button>

                    {showEmojiPicker && (
                        <div style={{
                            position: 'absolute',
                            bottom: 'calc(100% + 10px)',
                            left: 0,
                            background: 'var(--bg-card)',
                            border: '1px solid var(--border)',
                            borderRadius: 10,
                            padding: 10,
                            display: 'grid',
                            gridTemplateColumns: 'repeat(7, 1fr)',
                            gap: 5,
                            boxShadow: '0 4px 12px rgba(0,0,0,0.2)',
                            zIndex: 10
                        }}>
                            {['😀', '😂', '😍', '👍', '🙏', '🔥', '🎉', '🤔', '💡', '💻', '🌐', '🚀', '✅', '❌', '❤️', '💔'].map(emoji => (
                                <span key={emoji} onClick={() => handleEmojiSelect(emoji)} style={{ cursor: 'pointer', fontSize: 20 }}>
                                    {emoji}
                                </span>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const Pesan = ({ userName, onNavigate, t, newChatTarget, onClearChatTarget, friends = [], registeredUsers = [], onTagClick }) => {
            const safeRegisteredUsers = Array.isArray(registeredUsers) ? registeredUsers : [];
            const safeFriends = Array.isArray(friends) ? friends : [];

            const [filter, setFilter] = useState('inbox');
            const [searchTerm, setSearchTerm] = useState('');
            const [activeChat, setActiveChat] = useState(null); // Track active chat for detail view

            // Resolve full friend objects
            const myContacts = useMemo(() => {
                const real = safeRegisteredUsers.map(u => ({ ...u, image: `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name)}&background=random` }));
                let pool = [...real];
                // Add demo members if not present
                DEMO_MEMBERS.forEach(dm => {
                    if (!pool.find(p => p.name === dm.name)) {
                        pool.push({ ...dm });
                    }
                });
                return pool.filter(u => safeFriends.includes(u.id));
            }, [safeRegisteredUsers, safeFriends]);

            // Use state for chats to allow deletion
            const [chats, setChats] = useState([
                { id: 1, name: 'Natasya Rina', msg: 'Bisa kita diskusi lebih lanjut?', time: '2m', unread: true, image: 'https://i.pravatar.cc/150?u=12' },
                { id: 2, name: 'Budi Santoso', msg: 'Terima kasih atas solusinya!', time: '1h', unread: false, image: 'https://i.pravatar.cc/150?u=1' },
                { id: 3, name: 'Ahmad Rizky', msg: 'Update hardware sudah selesai.', time: '3h', unread: false, image: 'https://i.pravatar.cc/150?u=3' }
            ]);

            const filteredChats = chats.filter(c =>
                c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                c.msg.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const filteredContacts = myContacts.filter(c =>
                c.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const startChatWithContact = (contact) => {
                const exists = chats.find(c => c.name === contact.name);
                if (!exists) {
                    const newChat = {
                        id: Date.now(),
                        name: contact.name,
                        msg: 'Halo, salam kenal!',
                        time: 'Baru saja',
                        unread: false,
                        image: contact.image,
                        messages: [
                            { id: 1, text: 'Halo, salam kenal!', time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), isMe: true }
                        ]
                    };
                    setChats(prev => [newChat, ...prev]);
                    setActiveChat(newChat);
                } else {
                    setActiveChat(exists);
                }
                setFilter('inbox');
                setSearchTerm('');
            };

            const changeFilter = (newFilter) => {
                setFilter(newFilter);
                setSearchTerm('');
            };

            useEffect(() => {
                if (newChatTarget) {
                    const exists = chats.find(c => c.name === newChatTarget.name);
                    if (!exists) {
                        const newChat = {
                            id: Date.now(),
                            name: newChatTarget.name,
                            msg: 'Halo, saya ingin berdiskusi.',
                            time: 'Baru saja',
                            unread: false,
                            image: newChatTarget.image || `https://ui-avatars.com/api/?name=${encodeURIComponent(newChatTarget.name)}&background=random`,
                            messages: [
                                { id: 1, text: 'Halo, saya ingin berdiskusi.', time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), isMe: true }
                            ]
                        };
                        setChats(prev => [newChat, ...prev]);
                        setActiveChat(newChat);
                    } else {
                        const baseChat = {
                            ...exists,
                            messages: exists.messages || [{ id: Date.now(), text: exists.msg, time: exists.time, isMe: false }]
                        };
                        setActiveChat(baseChat);
                    }
                    if (onClearChatTarget) onClearChatTarget();
                }
            }, [newChatTarget]);

            const handleSendMessage = (text) => {
                if (!activeChat || !text.trim()) return;

                const newMessage = {
                    id: Date.now(),
                    text: text,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    isMe: true
                };

                const updatedMessages = [...(activeChat.messages || []), newMessage];

                // Update active chat messages
                const updatedChat = {
                    ...activeChat,
                    msg: text, // Update preview
                    time: 'Baru saja',
                    messages: updatedMessages
                };

                setActiveChat(updatedChat);
                setChats(prev => prev.map(c => c.id === activeChat.id ? updatedChat : c));
            };

            const handleDelete = (id) => {
                if (confirm('Apakah Anda yakin ingin menghapus pesan ini?')) {
                    const updated = chats.filter(c => c.id !== id);
                    setChats(updated);
                    if (activeChat && activeChat.id === id) setActiveChat(null);
                }
            };

            return (
                <Background3D color1="var(--primary)" color2="var(--secondary)">
                    <div className="animate sidebar-page-container">
                        <div className="app-sidebar">
                            <div className="sidebar-header">
                                <h2>{t.msg_title}</h2>
                                <p>{t.msg_subtitle}</p>
                            </div>
                            <div className="sidebar-menu">
                                <button className={filter === 'inbox' ? 'active' : ''} onClick={() => changeFilter('inbox')}><Icon name="message-circle" size={18} /> {t.msg_inbox}</button>
                                <button className={filter === 'archived' ? 'active' : ''} onClick={() => changeFilter('archived')}><Icon name="archive" size={18} /> {t.msg_archived}</button>
                                <button className={filter === 'contacts' ? 'active' : ''} onClick={() => changeFilter('contacts')}><Icon name="users" size={18} /> {t.msg_contacts}</button>
                            </div>
                        </div>
                        <div className="app-content" style={{ display: 'flex', flexDirection: 'column', height: '100%', overflow: activeChat ? 'hidden' : 'auto', paddingBottom: activeChat ? 90 : 140 }}>
                            <header className="mobile-header" style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                <div onClick={() => onNavigate && onNavigate('home')} style={{ cursor: 'pointer', padding: 8, background: 'rgba(99, 102, 241, 0.15)', borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                    <Icon name="chevron-left" size={20} color="var(--primary)" />
                                </div>
                                <h1>{t.msg_title}</h1>
                            </header>

                            {/* Detail Chat View */}
                            {activeChat ? (
                                <div className="chat-detail animate" style={{ display: 'flex', flexDirection: 'column', height: '100%', animation: 'fadeIn 0.2s', overflow: 'hidden' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 12, paddingBottom: 16, borderBottom: '1px solid var(--border)', marginBottom: 16, flexShrink: 0 }}>
                                        <div onClick={() => setActiveChat(null)} style={{ cursor: 'pointer', padding: 8, background: 'rgba(255,255,255,0.1)', borderRadius: '50%' }}>
                                            <Icon name="arrow-left" size={20} />
                                        </div>
                                        <img src={activeChat.image} style={{ width: 40, height: 40, borderRadius: '50%', objectFit: 'cover' }} />
                                        <div>
                                            <div style={{ fontWeight: 700, fontSize: 16 }}>{activeChat.name}</div>
                                            <div style={{ fontSize: 12, color: '#10B981' }}>Online</div>
                                        </div>
                                    </div>

                                    <div className="messages-area" style={{ flex: 1, overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: 12, paddingRight: 8, marginBottom: 16 }}>
                                        {(activeChat.messages || []).length === 0 && (
                                            <div style={{ textAlign: 'center', color: 'var(--text-gray)', marginTop: 40, fontSize: 12 }}>
                                                Mulai percakapan dengan {activeChat.name}
                                            </div>
                                        )}
                                        {(activeChat.messages || []).map(m => (
                                            <div key={m.id} style={{ alignSelf: m.isMe ? 'flex-end' : 'flex-start', maxWidth: '75%', position: 'relative' }}>
                                                <div style={{
                                                    background: m.isMe ? 'var(--primary)' : '#334155',
                                                    color: 'white',
                                                    padding: '10px 14px',
                                                    borderRadius: m.isMe ? '16px 16px 4px 16px' : '16px 16px 16px 4px',
                                                    fontSize: 14,
                                                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                                                }}>
                                                    {renderTextWithMentions(m.text, onTagClick)}
                                                </div>
                                                <div style={{ fontSize: 10, color: 'var(--text-gray)', marginTop: 4, textAlign: m.isMe ? 'right' : 'left' }}>{m.time}</div>
                                            </div>
                                        ))}
                                    </div>

                                    {/* Input Area */}
                                    <div style={{ flexShrink: 0 }}>
                                        <ChatInput onSend={handleSendMessage} />
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <div className="search-bar" style={{ background: 'rgba(255,255,255,0.05)', border: '1px solid var(--border)', marginBottom: 16 }}>
                                        <Icon name="search" color="var(--text-gray)" />
                                        <input
                                            type="text"
                                            placeholder={t.msg_search_placeholder}
                                            style={{ color: 'white' }}
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                        {searchTerm && (
                                            <div onClick={() => setSearchTerm('')} style={{ cursor: 'pointer' }}>
                                                <Icon name="x" size={14} color="var(--text-gray)" />
                                            </div>
                                        )}
                                    </div>

                                    <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: 12 }}>
                                        <button onClick={() => { if (confirm(t.confirm_delete_all_msg)) setChats([]); }} style={{ background: 'transparent', border: 'none', color: '#EF4444', fontSize: 11, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 4, fontWeight: 600 }}>
                                            <Icon name="trash-2" size={14} /> {t.msg_clear_all}
                                        </button>
                                    </div>

                                    {filter === 'inbox' && (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
                                            {filteredChats.map((c) => (
                                                <div key={c.id} className="card" onClick={() => setActiveChat({ ...c, messages: c.messages || [{ id: 999, text: c.msg, time: c.time, isMe: false }] })} style={{ display: 'flex', alignItems: 'center', gap: 16, margin: 0, cursor: 'pointer' }}>
                                                    <div style={{ position: 'relative' }}>
                                                        <img src={c.image} style={{ width: 50, height: 50, borderRadius: '50%', objectFit: 'cover' }} />
                                                        {c.unread && <div style={{ position: 'absolute', top: 0, right: 0, width: 12, height: 12, background: '#EF4444', borderRadius: '50%', border: '2px solid var(--bg-card)' }}></div>}
                                                    </div>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                                                            <div style={{ fontWeight: 700, fontSize: 15 }}>{c.name}</div>
                                                            <div style={{ fontSize: 11, color: 'var(--text-gray)' }}>{c.time}</div>
                                                        </div>
                                                        <div style={{ fontSize: 13, color: c.unread ? 'white' : 'var(--text-gray)', fontWeight: c.unread ? 600 : 400 }}>{c.msg}</div>
                                                    </div>

                                                    {/* Delete Action */}
                                                    <div
                                                        onClick={(e) => { e.stopPropagation(); handleDelete(c.id); }}
                                                        style={{
                                                            padding: 10,
                                                            color: '#EF4444',
                                                            borderRadius: 10,
                                                            transition: '0.2s',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center'
                                                        }}
                                                        onMouseOver={(e) => e.currentTarget.style.background = 'rgba(239, 68, 68, 0.1)'}
                                                        onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}
                                                        title="Hapus Pesan"
                                                    >
                                                        <Icon name="trash-2" size={18} />
                                                    </div>
                                                </div>
                                            ))}
                                            {filteredChats.length === 0 && <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-gray)' }}>{searchTerm ? 'Pesan tidak ditemukan' : t.msg_empty}</div>}
                                        </div>
                                    )}

                                    {filter === 'contacts' && (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
                                            {filteredContacts.map((c) => (
                                                <div key={c.id} className="card" onClick={() => startChatWithContact(c)} style={{ display: 'flex', alignItems: 'center', gap: 16, margin: 0, cursor: 'pointer' }}>
                                                    <div style={{ position: 'relative' }}>
                                                        <img src={c.image} style={{ width: 50, height: 50, borderRadius: '50%', objectFit: 'cover' }} />
                                                    </div>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: 700, fontSize: 15 }}>{c.name}</div>
                                                        <div style={{ fontSize: 12, color: 'var(--text-gray)' }}>{c.role || 'User'}</div>
                                                    </div>
                                                    <div style={{ padding: 8, background: 'var(--primary)', borderRadius: 8, color: 'white' }}>
                                                        <Icon name="message-circle" size={18} />
                                                    </div>
                                                </div>
                                            ))}
                                            {filteredContacts.length === 0 && <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-gray)' }}>{friends.length === 0 ? 'Belum ada kontak teman.' : 'Kontak tidak ditemukan.'}</div>}
                                        </div>
                                    )}

                                    {filter === 'archived' && <div style={{ padding: 40, textAlign: 'center', color: 'var(--text-gray)' }}>Folder ini kosong</div>}
                                </>
                            )}
                        </div>
                    </div>
                </Background3D>
            );
        };

        const Notifikasi = ({ onNavigate, notifications = [], onNotificationClick, setNotifications, t }) => {
            const [filter, setFilter] = useState('all');

            const handleDelete = (id) => {
                if (confirm('Hapus notifikasi ini?')) {
                    setNotifications(notifications.filter(n => n.id !== id));
                }
            };

            const clearAll = () => {
                if (confirm('Hapus semua notifikasi?')) {
                    setNotifications([]);
                }
            };

            // Filter logic
            const filtered = filter === 'all' ? notifications : notifications.filter(n => n.type === filter);

            return (
                <Background3D color1="var(--primary)" color2="var(--secondary)">
                    <div className="animate sidebar-page-container">
                        <div className="app-sidebar">
                            <div className="sidebar-header">
                                <h2>{t.notif_title}</h2>
                            </div>
                            <div className="sidebar-menu">
                                <button className={filter === 'all' ? 'active' : ''} onClick={() => setFilter('all')}><Icon name="inbox" size={18} /> {t.notif_all}</button>
                                <button className={filter === 'message' ? 'active' : ''} onClick={() => setFilter('message')}><Icon name="message-circle" size={18} /> {t.notif_discuss}</button>
                                <button className={filter === 'award' ? 'active' : ''} onClick={() => setFilter('award')}><Icon name="award" size={18} /> {t.notif_achievement}</button>
                                <button className={filter === 'info' ? 'active' : ''} onClick={() => setFilter('info')}><Icon name="info" size={18} /> {t.notif_system}</button>
                            </div>
                        </div>
                        <div className="app-content">
                            <header className="mobile-header" style={{ display: 'flex', alignItems: 'center', gap: 12, justifyContent: 'space-between' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                    <div onClick={() => onNavigate && onNavigate('home')} style={{ cursor: 'pointer', padding: 8, background: 'rgba(99, 102, 241, 0.15)', borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                        <Icon name="chevron-left" size={20} color="var(--primary)" />
                                    </div>
                                    <h1>{t.notif_title}</h1>
                                </div>
                                <div onClick={clearAll} style={{ cursor: 'pointer', color: '#EF4444', padding: 8 }} title="Hapus Semua">
                                    <Icon name="trash-2" size={20} />
                                </div>
                            </header>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                                {filtered.length === 0 && <div style={{ color: 'var(--text-gray)', textAlign: 'center', marginTop: 40 }}>{t.notif_empty}</div>}
                                {filtered.map(n => (
                                    <div key={n.id} className="card"
                                        onClick={() => onNotificationClick && onNotificationClick(n)}
                                        style={{ display: 'flex', gap: 16, alignItems: 'center', margin: 0, cursor: 'pointer', borderLeft: n.unread ? '3px solid var(--primary)' : 'none' }}>
                                        <div style={{ width: 44, height: 44, borderRadius: 12, background: 'rgba(255,255,255,0.05)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--primary)', flexShrink: 0 }}>
                                            <Icon name={n.type === 'message' ? 'message-square' : n.type === 'award' ? 'award' : 'bell'} />
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ fontWeight: 700, fontSize: 14 }}>{n.title}</div>
                                            <div style={{ fontSize: 12, color: 'var(--text-gray)', marginTop: 2 }}>{n.desc}</div>
                                            <div style={{ fontSize: 10, color: 'rgba(255,255,255,0.2)', marginTop: 4 }}>{n.time}</div>
                                        </div>
                                        <div
                                            onClick={(e) => { e.stopPropagation(); handleDelete(n.id); }}
                                            style={{ padding: 8, color: '#EF4444', opacity: 0.5, cursor: 'pointer' }}
                                            onMouseOver={e => e.currentTarget.style.opacity = 1}
                                            onMouseOut={e => e.currentTarget.style.opacity = 0.5}
                                        >
                                            <Icon name="trash-2" size={16} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </Background3D>
            );
        };

        const Bantuan = ({ onNavigate, t }) => {
            const [tab, setTab] = useState('umum');
            return (
                <Background3D color1="var(--primary)" color2="var(--secondary)">
                    <div className="animate sidebar-page-container">
                        <div className="app-sidebar">
                            <div className="sidebar-header">
                                <h2>{t.help_title}</h2>
                                <p>{t.help_subtitle}</p>
                            </div>
                            <div className="sidebar-menu">
                                <button className={tab === 'umum' ? 'active' : ''} onClick={() => setTab('umum')}><Icon name="info" size={18} /> {t.help_tab_general}</button>
                                <button className={tab === 'faq' ? 'active' : ''} onClick={() => setTab('faq')}><Icon name="help-circle" size={18} /> {t.help_tab_faq}</button>
                                <button className={tab === 'contact' ? 'active' : ''} onClick={() => setTab('contact')}><Icon name="mail" size={18} /> {t.help_tab_contact}</button>
                            </div>
                        </div>

                        <div className="app-content">
                            <header className="mobile-header" style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                <div onClick={() => onNavigate && onNavigate('home')} style={{ cursor: 'pointer', padding: 8, background: 'rgba(99, 102, 241, 0.15)', borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                    <Icon name="chevron-left" size={20} color="var(--primary)" />
                                </div>
                                <h1>{t.help_title}</h1>
                            </header>
                            {tab === 'umum' && (
                                <div className="card" style={{ padding: 24, textAlign: 'center' }}>
                                    <div style={{ width: 80, height: 80, background: 'linear-gradient(135deg, var(--primary), var(--secondary))', borderRadius: 20, margin: '0 auto 20px', display: 'flex', alignItems: 'center', justifyContent: 'center', boxShadow: '0 10px 30px rgba(99, 102, 241, 0.3)' }}>
                                        <Icon name="info" size={40} color="white" />
                                    </div>
                                    <h2 style={{ fontSize: 20, fontWeight: 800, marginBottom: 8 }}>Belajar Bersama v2.0</h2>
                                    <p style={{ fontSize: 13, color: 'var(--text-gray)', lineHeight: 1.6 }}>Platform kolaborasi IT Support & Troubleshooting antar karyawan.</p>

                                    <div className="card" style={{ marginTop: 24, background: 'rgba(255,255,255,0.03)', textAlign: 'left' }}>
                                        <h4 style={{ fontSize: 14, fontWeight: 700, marginBottom: 16 }}>Keamanan & Privasi</h4>
                                        <div style={{ fontSize: 12, color: 'var(--text-gray)', display: 'flex', flexDirection: 'column', gap: 12 }}>
                                            <p style={{ lineHeight: 1.5 }}>Data Anda terlindungi dengan enkripsi standar industri.</p>
                                            <div style={{ height: 1, background: 'rgba(255,255,255,0.05)', margin: '4px 0' }} />
                                            <div style={{ display: 'flex', justifyContent: 'space-between' }}><span>{t.help_ver}</span><span style={{ color: 'white' }}>2.0.1</span></div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between' }}><span>{t.help_dev}</span><span style={{ color: 'white' }}>Muhammad Ramadhan</span></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {tab === 'faq' && (
                                <div>
                                    <div className="card"><h4 style={{ marginBottom: 8 }}>Bagaimana cara reset password?</h4><p style={{ fontSize: 13, color: 'var(--text-gray)' }}>Hubungi admin IT melalui menu Kontak atau gunakan fitur Lupa Password di halaman login.</p></div>
                                    <div className="card"><h4 style={{ marginBottom: 8 }}>Apakah chat bersifat pribadi?</h4><p style={{ fontSize: 13, color: 'var(--text-gray)' }}>Ya, chat antar pengguna dienkripsi. Namun diskusi publik dapat dilihat oleh semua anggota.</p></div>
                                </div>
                            )}
                            {tab === 'contact' && (
                                <div className="card" style={{ textAlign: 'center', padding: '40px 20px' }}>
                                    <Icon name="mail" size={48} color="var(--primary)" />
                                    <h3>{t.help_need_more}</h3>
                                    <button style={{ marginTop: 16, padding: '12px 24px', background: 'var(--primary)', color: 'white', border: 'none', borderRadius: 8 }}>{t.help_btn_email}</button>
                                </div>
                            )}
                        </div>
                    </div>
                </Background3D>
            );
        };

        const KnowledgeFeed = ({ onBack, knowledgeBase, searchTerm, onKnowledgeClick, t }) => {
            const [selectedId, setSelectedId] = useState(null);
            const [isAnalyzingLocal, setIsAnalyzingLocal] = useState(false);

            const displayKnowledge = knowledgeBase.filter(k =>
                !searchTerm ||
                k.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                k.question.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const selectedItem = knowledgeBase.find(k => k.id === selectedId);

            const handleItemClick = (k) => {
                if (onKnowledgeClick) {
                    onKnowledgeClick(k);
                } else {
                    setSelectedId(k.id);
                    setIsAnalyzingLocal(true);
                    setTimeout(() => setIsAnalyzingLocal(false), 2000);
                }
            };

            return (
                <div className="animate">
                    {onBack && (
                        <header className="page-header" style={{ background: 'linear-gradient(135deg, var(--primary), var(--secondary))' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>
                                <div onClick={onBack} style={{ cursor: 'pointer', background: 'rgba(255,255,255,0.2)', padding: 8, borderRadius: 10, display: 'flex' }}>
                                    <Icon name="chevron-left" size={20} color="white" />
                                </div>
                                <h1 style={{ fontSize: '20px', fontWeight: '800', color: 'white' }}>{t.kf_title}</h1>
                            </div>
                            <p style={{ color: 'rgba(255,255,255,0.8)', fontSize: '12px', marginLeft: 44 }}>{t.kf_subtitle}</p>
                        </header>
                    )}

                    <div className="container" style={{ padding: '24px 0' }}>
                        <div className="grid-responsive">
                            {displayKnowledge.map((k, i) => (
                                <div key={i} className="card"
                                    onClick={() => handleItemClick(k)}
                                    style={{ display: 'flex', gap: 16, alignItems: 'center', margin: 0 }}>
                                    <div style={{ width: 44, height: 44, borderRadius: 12, background: `${k.color}15`, display: 'flex', alignItems: 'center', justifyContent: 'center', color: k.color, flexShrink: 0 }}>
                                        <Icon name={k.icon} size={22} />
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 4 }}>
                                            <div style={{ fontSize: 9, padding: '2px 8px', background: 'rgba(239, 68, 68, 0.1)', color: '#EF4444', borderRadius: 20, fontWeight: 700 }}>
                                                {t.kf_trending}
                                            </div>
                                            <div style={{ fontSize: 9, color: 'var(--text-gray)' }}>{k.trendInfo}</div>
                                        </div>
                                        <div style={{ fontWeight: 700, fontSize: 13, color: 'white' }}>{k.title}</div>
                                        <div style={{ fontSize: 10, color: 'var(--text-gray)', marginTop: 2 }}>{k.desc}</div>
                                    </div>
                                    <Icon name="chevron-right" size={14} color="rgba(255,255,255,0.1)" />
                                </div>
                            ))}
                        </div>
                    </div>

                    {selectedItem && (
                        <div style={{
                            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                            background: 'rgba(0,0,0,0.9)', backdropFilter: 'blur(15px)',
                            zIndex: 30000, display: 'flex', alignItems: 'center', justifyContent: 'center',
                            padding: 20
                        }} onClick={() => setSelectedId(null)}>
                            <div className="animate" style={{
                                maxWidth: 'min(95vw, 850px)', width: 'calc(100% - 32px)', background: 'var(--bg-card)',
                                borderRadius: 32, border: '1px solid var(--primary)',
                                maxHeight: '92vh', overflowY: 'auto', overflowX: 'hidden',
                                position: 'relative', boxShadow: '0 0 80px rgba(99, 102, 241, 0.4)',
                                margin: 'auto', WebkitOverflowScrolling: 'touch'
                            }} onClick={e => e.stopPropagation()}>
                                {isAnalyzingLocal && (
                                    <div style={{
                                        position: 'absolute', top: 0, left: 0, right: 0, bottom: 0,
                                        background: 'rgba(15, 23, 42, 0.95)', zIndex: 40000,
                                        display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',
                                        gap: 20
                                    }}>
                                        <div className="animate-pulse" style={{ width: 80, height: 80, borderRadius: '50%', border: '4px solid var(--primary)', borderTopColor: 'transparent', animation: 'spin 1s linear infinite' }}></div>
                                        <div style={{ color: 'white', fontWeight: 800, fontSize: 18 }}>{t.kf_ai_analyzing}</div>
                                        <div style={{ color: 'var(--text-gray)', fontSize: 12 }}>{t.kf_ai_connecting}</div>
                                    </div>
                                )}
                                <div style={{ background: 'linear-gradient(135deg, var(--primary), var(--secondary))', padding: 'clamp(16px, 4vw, 24px) clamp(20px, 5vw, 30px)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 15 }}>
                                        <div style={{ width: 'clamp(36px, 10vw, 44px)', height: 'clamp(36px, 10vw, 44px)', background: 'rgba(255,255,255,0.2)', borderRadius: 12, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                            <Icon name="brain-circuit" size={24} color="white" />
                                        </div>
                                        <div>
                                            <div style={{ fontSize: 'clamp(15px, 4vw, 18px)', fontWeight: 900, color: 'white' }}>{t.kf_report_title}</div>
                                            <div style={{ fontSize: 10, color: 'rgba(255,255,255,0.7)', fontWeight: 600 }}>{t.kf_report_sync}</div>
                                        </div>
                                    </div>
                                    <div onClick={() => setSelectedId(null)} style={{ cursor: 'pointer', background: 'rgba(0,0,0,0.2)', padding: 10, borderRadius: '50%', color: 'white' }}><Icon name="x" size={20} /></div>
                                </div>

                                <div style={{ padding: 'clamp(16px, 5vw, 30px)' }}>
                                    {/* Question Section */}
                                    <div style={{ marginBottom: 24 }}>
                                        <div style={{ fontSize: 11, fontWeight: 800, color: 'var(--primary)', marginBottom: 10, textTransform: 'uppercase', letterSpacing: 1.5 }}>{t.kf_problem_summary}</div>
                                        <div style={{ fontSize: 16, fontWeight: 700, color: 'white', lineHeight: 1.5, background: 'rgba(99, 102, 241, 0.05)', padding: 16, borderRadius: 16, borderLeft: '4px solid var(--primary)' }}>
                                            "{selectedItem.question}"
                                        </div>
                                    </div>

                                    {/* AI Crawling Section */}
                                    <div style={{
                                        marginBottom: 24,
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(auto-fit, minmax(min(100%, 250px), 1fr))',
                                        gap: 16
                                    }}>
                                        <div className="card" style={{ background: 'rgba(16, 185, 129, 0.05)', padding: 'clamp(12px, 3vw, 16px)', borderRadius: 20, border: '1px solid rgba(16, 185, 129, 0.1)', margin: 0 }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: 8, color: '#10B981', marginBottom: 10 }}>
                                                <Icon name="activity" size={16} />
                                                <div style={{ fontSize: 11, fontWeight: 800 }}>{t.kf_ai_engine}</div>
                                            </div>
                                            <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.7)', lineHeight: 1.6, marginBottom: 12 }}>{selectedItem.aiCrawling}</div>
                                            <button
                                                onClick={() => alert(t.kf_resource_ai)}
                                                style={{ background: 'rgba(16, 185, 129, 0.1)', border: 'none', borderRadius: 8, color: '#10B981', fontSize: 10, fontWeight: 700, padding: '6px 10px', cursor: 'pointer' }}>
                                                {t.kf_btn_resource}
                                            </button>
                                        </div>
                                        <div className="card" style={{ background: 'rgba(66, 133, 244, 0.05)', padding: 'clamp(12px, 3vw, 16px)', borderRadius: 20, border: '1px solid rgba(66, 133, 244, 0.1)', margin: 0 }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: 8, color: '#4285F4', marginBottom: 10 }}>
                                                <Icon name="search" size={16} />
                                                <div style={{ fontSize: 11, fontWeight: 800 }}>{t.kf_google_insight}</div>
                                            </div>
                                            <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.7)', lineHeight: 1.6, whiteSpace: 'pre-line', marginBottom: 12 }}>{selectedItem.googleInsight}</div>
                                            <button
                                                onClick={() => window.open(`https://www.google.com/search?q=${encodeURIComponent(selectedItem.title)}`, '_blank')}
                                                style={{ background: 'rgba(66, 133, 244, 0.1)', border: 'none', borderRadius: 8, color: '#4285F4', fontSize: 10, fontWeight: 700, padding: '6px 10px', cursor: 'pointer' }}>
                                                {t.kf_btn_google}
                                            </button>
                                        </div>
                                    </div>

                                    {/* Detailed Analysis Section */}
                                    <div style={{ background: 'rgba(255,255,255,0.03)', padding: 'clamp(16px, 4vw, 24px)', borderRadius: 24, border: '1px solid var(--border)' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 16 }}>
                                            <Icon name="clipboard-check" color="var(--primary)" size={18} />
                                            <div style={{ fontSize: 13, fontWeight: 800, color: 'white' }}>{t.kf_solution_title}</div>
                                        </div>
                                        <div style={{ fontSize: 14, color: 'rgba(255,255,255,0.8)', lineHeight: 1.8, whiteSpace: 'pre-line' }}>
                                            {selectedItem.analysis}
                                        </div>
                                    </div>

                                    <div style={{ display: 'flex', gap: 12, marginTop: 30 }}>
                                        <button
                                            onClick={() => {
                                                navigator.clipboard.writeText(selectedItem.analysis);
                                                alert(t.kf_copy_success);
                                            }}
                                            style={{
                                                flex: 1, padding: '16px',
                                                background: 'rgba(255,255,255,0.05)',
                                                border: '1px solid var(--border)', borderRadius: 16, color: 'white',
                                                fontWeight: 800, fontSize: 14, cursor: 'pointer',
                                                display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8
                                            }}>
                                            <Icon name="copy" size={18} /> {t.kf_btn_copy}
                                        </button>
                                        <button
                                            onClick={() => globalShare({ title: selectedItem.title, text: selectedItem.analysis })}
                                            style={{
                                                flex: 1, padding: '16px',
                                                background: 'linear-gradient(135deg, var(--primary), var(--secondary))',
                                                border: 'none', borderRadius: 16, color: 'white',
                                                fontWeight: 800, fontSize: 14, cursor: 'pointer',
                                                display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8,
                                                boxShadow: '0 10px 25px rgba(99, 102, 241, 0.3)'
                                            }}>
                                            <Icon name="share-2" size={18} /> {t.kf_btn_share}
                                        </button>
                                    </div>
                                    <button
                                        onClick={() => setSelectedId(null)}
                                        style={{ width: '100%', padding: '12px', background: 'transparent', border: 'none', color: 'var(--text-gray)', fontSize: 13, fontWeight: 600, marginTop: 16, cursor: 'pointer' }}>
                                        {t.kf_btn_close}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Profil = ({ userName, userRole, bio, photo, activityLog, isPrivate, onTogglePrivate, onLogout, onNavigate, onOpenDB, onOpenUserMan, onUpdateProfile, onDeleteAccount, appLang, onSetLang, theme, onSetTheme, timeZone, onSetTimeZone, t }) => {
            const [tab, setTab] = useState('ringkasan');
            const [isEditing, setIsEditing] = useState(false);
            const [editForm, setEditForm] = useState({ name: userName, bio: bio, photo: photo });
            const [uploading, setUploading] = useState(false);
            const fileInputRef = useRef(null);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 2 * 1024 * 1024) {
                    alert('Ukuran file terlalu besar! Maksimal 2MB.');
                    return;
                }

                setUploading(true);
                const reader = new FileReader();
                reader.onloadend = () => {
                    setEditForm(prev => ({ ...prev, photo: reader.result }));
                    setUploading(false);
                };
                reader.readAsDataURL(file);
            };

            // Dictionary Bahasa handled by t prop

            // Theme & TimeZone now via props
            // const [theme, setTheme] = useState('dark');
            // const [timeZone, setTimeZone] = useState('WIB');

            useEffect(() => {
                setEditForm({ name: userName, bio: bio, photo: photo });
            }, [userName, bio, photo]);

            // --- Enhanced Features States ---
            const [skills, setSkills] = useState(() => {
                try {
                    const saved = localStorage.getItem('bb_user_skills_' + (userName || 'default'));
                    return saved ? JSON.parse(saved) : ['Hardware', 'Networking', 'Software Install', 'Windows OS'];
                } catch (e) { return ['Hardware', 'Networking', 'Software Install', 'Windows OS']; }
            });

            // Stats Simulation
            const [stats] = useState({
                diskusi: 128,
                solusi: '85%',
                poin: '1.2k'
            });

            // Helper: Format Relative Time
            const formatRelativeTime = (val) => {
                if (!val) return 'Baru saja';
                // If string, assume it's already formatted
                if (typeof val === 'string' && val.includes('lalu')) return val;
                if (typeof val === 'string') return val; // fallback

                const diff = (Date.now() - val) / 1000;
                if (diff < 60) return 'Baru saja';
                if (diff < 3600) return `${Math.floor(diff / 60)} menit lalu`;
                if (diff < 86400) return `${Math.floor(diff / 3600)} jam lalu`;
                return `${Math.floor(diff / 86400)} hari lalu`;
            };

            // Password Management
            const [passState, setPassState] = useState({ old: '', new: '' });

            useEffect(() => {
                if (userName) {
                    localStorage.setItem('bb_user_skills_' + userName, JSON.stringify(skills));
                }
            }, [skills, userName]);

            const handleAddSkill = () => {
                const newSkill = prompt("Tambah Keahlian Baru (mis: ReactJS, Python):");
                if (newSkill && newSkill.trim()) {
                    if (skills.includes(newSkill.trim())) {
                        alert('Keahlian sudah ada!');
                        return;
                    }
                    setSkills([...skills, newSkill.trim()]);
                }
            };

            const handleRemoveSkill = (skillToRemove) => {
                if (confirm(`Hapus keahlian "${skillToRemove}"?`)) {
                    setSkills(skills.filter(s => s !== skillToRemove));
                }
            };

            const handleSavePassword = () => {
                if (!passState.old || !passState.new) {
                    alert('Mohon isi password lama dan baru.');
                    return;
                }
                // Simulation
                alert('Password berhasil diperbarui! Silakan login ulang nanti.');
                setPassState({ old: '', new: '' });
            };

            const saveProfileChanges = () => {
                onUpdateProfile && onUpdateProfile(editForm);
                setIsEditing(false);
            };

            return (
                <Background3D color1="var(--primary)" color2="var(--secondary)">
                    <div className="animate sidebar-page-container">
                        {/* Sidebar (Slide Bar) */}
                        <div className="app-sidebar">
                            <div className="sidebar-header">
                                <h2>{t.profile_title}</h2>
                                <p>{t.profile_subtitle}</p>
                            </div>
                            <div className="sidebar-menu">
                                <button className={tab === 'ringkasan' ? 'active' : ''} onClick={() => setTab('ringkasan')}>
                                    <Icon name="user" size={18} /> {t.profile_menu_summary}
                                </button>
                                <button className={tab === 'aktivitas' ? 'active' : ''} onClick={() => setTab('aktivitas')}>
                                    <Icon name="activity" size={18} /> {t.profile_menu_activity}
                                </button>
                                <button className={tab === 'security' ? 'active' : ''} onClick={() => setTab('security')}>
                                    <Icon name="shield" size={18} /> {t.profile_menu_security}
                                </button>
                                <button className={tab === 'settings' ? 'active' : ''} onClick={() => setTab('settings')}>
                                    <Icon name="settings" size={18} /> {t.profile_menu_settings}
                                </button>
                            </div>
                        </div>

                        {/* Content Area */}
                        <div className="app-content">
                            <header className="mobile-header" style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                <div onClick={() => onNavigate && onNavigate('home')} style={{ cursor: 'pointer', padding: 8, background: 'rgba(99, 102, 241, 0.15)', borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                    <Icon name="chevron-left" size={20} color="var(--primary)" />
                                </div>
                                <h1 style={{ fontSize: 24 }}>{t.profile_title}</h1>
                            </header>

                            {tab === 'ringkasan' && (
                                <div className="animate">
                                    <div className="card" style={{ padding: 30, background: 'linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0))', border: '1px solid var(--primary)', position: 'relative' }}>
                                        {/* Edit Toggle */}
                                        <div onClick={() => setIsEditing(!isEditing)} style={{ position: 'absolute', top: 20, right: 20, padding: 8, background: isEditing ? 'var(--primary)' : 'rgba(255,255,255,0.1)', borderRadius: 8, cursor: 'pointer', color: 'white' }}>
                                            <Icon name={isEditing ? 'x' : 'edit-2'} size={18} />
                                        </div>

                                        <div style={{ display: 'flex', alignItems: 'center', gap: 20 }}>
                                            <div style={{ position: 'relative', width: 80, height: 80 }}>
                                                <img src={isEditing ? editForm.photo : photo} style={{ width: '100%', height: '100%', borderRadius: '50%', objectFit: 'cover', border: '2px solid white' }} />
                                                <div style={{ position: 'absolute', bottom: 0, right: 0, width: 24, height: 24, background: '#10B981', borderRadius: '50%', border: '2px solid #1e1e1e' }}></div>
                                            </div>
                                            <div style={{ flex: 1 }}>
                                                {isEditing ? (
                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                                                        <input
                                                            value={editForm.name}
                                                            onChange={e => setEditForm({ ...editForm, name: e.target.value })}
                                                            placeholder={t.profile_label_name}
                                                            style={{ background: 'rgba(0,0,0,0.3)', border: '1px solid var(--primary)', padding: 8, borderRadius: 6, color: 'white', width: '100%' }}
                                                        />
                                                        <input
                                                            value={editForm.bio}
                                                            onChange={e => setEditForm({ ...editForm, bio: e.target.value })}
                                                            placeholder={t.profile_label_bio}
                                                            style={{ background: 'rgba(0,0,0,0.3)', border: '1px solid var(--border)', padding: 8, borderRadius: 6, color: 'white', fontSize: 13, width: '100%' }}
                                                        />
                                                        <input
                                                            value={editForm.photo}
                                                            onChange={e => setEditForm({ ...editForm, photo: e.target.value })}
                                                            placeholder="URL Foto Profil"
                                                            style={{ background: 'rgba(0,0,0,0.3)', border: '1px solid var(--border)', padding: 8, borderRadius: 6, color: 'white', fontSize: 11, width: '100%' }}
                                                        />
                                                        <input
                                                            type="file"
                                                            ref={fileInputRef}
                                                            style={{ display: 'none' }}
                                                            accept="image/*"
                                                            onChange={handleFileChange}
                                                        />
                                                        <button
                                                            onClick={() => fileInputRef.current.click()}
                                                            style={{ background: 'rgba(255,255,255,0.1)', border: '1px dashed var(--border)', padding: 8, borderRadius: 6, color: 'var(--text-gray)', fontSize: 11, cursor: 'pointer', width: '100%' }}>
                                                            {uploading ? t.loading : t.profile_upload_label || 'Upload Foto'}
                                                        </button>
                                                        <button onClick={saveProfileChanges} style={{ marginTop: 4, background: '#10B981', color: 'white', border: 'none', padding: 8, borderRadius: 6, cursor: 'pointer', fontWeight: 'bold' }}>{t.profile_label_save}</button>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <h2 style={{ fontSize: 24, marginBottom: 4 }}>{userName || 'Karyawan'}</h2>
                                                        <div style={{ color: 'var(--text-gray)', fontSize: 13, marginBottom: 12 }}>{bio || 'Senior System Admin • IT Support'}</div>
                                                        <div style={{ display: 'flex', gap: 8 }}>
                                                            <span className="tag" style={{ background: 'rgba(99, 102, 241, 0.2)', color: '#818cf8', border: 'none' }}>{userRole}</span>
                                                            <span className="tag" style={{ background: 'rgba(16, 185, 129, 0.2)', color: '#34d399', border: 'none' }}>Verified</span>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="card" style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', textAlign: 'center', padding: '24px 0', marginTop: 24 }}>
                                        <div className="hover-scale" style={{ cursor: 'pointer' }} onClick={() => alert(t.profile_stat_discuss_detail || 'Detail diskusi')}>
                                            <div style={{ fontSize: 20, fontWeight: 800 }}>{stats.diskusi}</div>
                                            <div style={{ fontSize: 11, color: 'var(--text-gray)', textTransform: 'uppercase', marginTop: 4 }}>{t.profile_stat_discuss}</div>
                                        </div>
                                        <div className="hover-scale" style={{ borderLeft: '1px solid var(--border)', borderRight: '1px solid var(--border)', cursor: 'pointer' }} onClick={() => alert(t.profile_stat_solution_detail || 'Detail solusi')}>
                                            <div style={{ fontSize: 20, fontWeight: 800 }}>{stats.solusi}</div>
                                            <div style={{ fontSize: 11, color: 'var(--text-gray)', textTransform: 'uppercase', marginTop: 4 }}>{t.profile_stat_solution}</div>
                                        </div>
                                        <div className="hover-scale" style={{ cursor: 'pointer' }} onClick={() => alert(t.profile_stat_points_detail || 'Detail poin')}>
                                            <div style={{ fontSize: 20, fontWeight: 800 }}>{stats.poin}</div>
                                            <div style={{ fontSize: 11, color: 'var(--text-gray)', textTransform: 'uppercase', marginTop: 4 }}>{t.profile_stat_points}</div>
                                        </div>
                                    </div>

                                    <div className="card" style={{ marginTop: 24 }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
                                            <h3 style={{ fontSize: 16 }}>{t.profile_skills_title}</h3>
                                            <button onClick={handleAddSkill} style={{ background: 'var(--primary)', border: 'none', borderRadius: 8, width: 28, height: 28, color: 'white', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                                <Icon name="plus" size={16} />
                                            </button>
                                        </div>
                                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8 }}>
                                            {skills.map(t => (
                                                <div key={t} className="tag" style={{ display: 'flex', alignItems: 'center', gap: 6, paddingRight: 6 }}>
                                                    {t}
                                                    <span onClick={() => handleRemoveSkill(t)} style={{ cursor: 'pointer', opacity: 0.6, display: 'flex', alignItems: 'center' }}>
                                                        <Icon name="x" size={12} />
                                                    </span>
                                                </div>
                                            ))}
                                            {skills.length === 0 && <span style={{ color: 'var(--text-gray)', fontSize: 13 }}>Belum ada keahlian ditambahkan.</span>}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {tab === 'aktivitas' && (
                                <div className="animate">
                                    <div className="card" style={{ padding: 0, overflow: 'hidden' }}>
                                        <div style={{ padding: '16px 20px', borderBottom: '1px solid var(--border)', fontWeight: 700 }}>
                                            <h3 style={{ fontSize: 16, marginBottom: 16 }}>{t.profile_activity_title}</h3>
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                                                {activityLog && activityLog.length > 0 ? activityLog.map((log, i) => (
                                                    <div key={i} style={{ display: 'flex', gap: 12, padding: 12, background: 'rgba(255,255,255,0.02)', borderRadius: 12 }}>
                                                        <div style={{ width: 8, height: 8, background: 'var(--primary)', borderRadius: '50%', marginTop: 6 }} />
                                                        <div>
                                                            <div style={{ fontSize: 13, fontWeight: 600 }}>{log.action}</div>
                                                            <div style={{ fontSize: 11, color: 'var(--text-gray)' }}>{formatRelativeTime(log.timestamp)}</div>
                                                        </div>
                                                    </div>
                                                )) : (
                                                    <div style={{ padding: 40, textAlign: 'center', color: 'var(--text-gray)' }}>{t.profile_activity_empty}</div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {tab === 'security' && (
                                <div className="animate">
                                    <div className="card" style={{ marginBottom: 16 }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                                <Icon name="shield" color="#10B981" />
                                                <div style={{ fontWeight: 700 }}>{t.profile_privacy_title}</div>
                                            </div>
                                            <div
                                                onClick={onTogglePrivate}
                                                style={{
                                                    width: 44, height: 24, borderRadius: 12,
                                                    background: isPrivate ? 'var(--primary)' : 'rgba(255,255,255,0.1)',
                                                    position: 'relative', transition: '0.3s', cursor: 'pointer'
                                                }}
                                            >
                                                <div style={{
                                                    width: 18, height: 18, borderRadius: '50%', background: 'white',
                                                    position: 'absolute', top: 3, left: isPrivate ? 23 : 3, transition: '0.3s'
                                                }}></div>
                                            </div>
                                        </div>
                                        <p style={{ fontSize: 12, color: 'var(--text-gray)', lineHeight: 1.5 }}>{t.profile_privacy_desc}</p>
                                    </div>
                                    <div className="card">
                                        <h4 style={{ marginBottom: 12 }}>{t.profile_pass_title}</h4>
                                        <input
                                            type="password"
                                            placeholder={t.profile_pass_old}
                                            value={passState.old}
                                            onChange={e => setPassState({ ...passState, old: e.target.value })}
                                            style={{ width: '100%', padding: 12, background: 'var(--bg)', border: '1px solid var(--border)', borderRadius: 8, marginBottom: 10, color: 'white' }}
                                        />
                                        <input
                                            type="password"
                                            placeholder={t.profile_pass_new}
                                            value={passState.new}
                                            onChange={e => setPassState({ ...passState, new: e.target.value })}
                                            style={{ width: '100%', padding: 12, background: 'var(--bg)', border: '1px solid var(--border)', borderRadius: 8, color: 'white' }}
                                        />
                                        <button onClick={handleSavePassword} style={{ marginTop: 12, padding: '10px 20px', background: 'var(--primary)', color: 'white', border: 'none', borderRadius: 8, cursor: 'pointer' }}>{t.save}</button>
                                    </div>
                                </div>
                            )}

                            {tab === 'settings' && (
                                <div className="animate">
                                    <div className="card" style={{ marginBottom: 16 }}>
                                        <h4 style={{ marginBottom: 16 }}>{t.profile_pref_display}</h4>
                                        {/* Language */}
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                            <div style={{ color: 'var(--text-gray)' }}>{t.profile_lang_label}</div>
                                            <div style={{ display: 'flex', background: 'rgba(0,0,0,0.2)', padding: 4, borderRadius: 8 }}>
                                                <div onClick={() => onSetLang('id')} style={{ padding: '4px 12px', borderRadius: 6, background: appLang === 'id' ? 'var(--primary)' : 'transparent', fontSize: 12, cursor: 'pointer', transition: '0.2s' }}>ID</div>
                                                <div onClick={() => onSetLang('en')} style={{ padding: '4px 12px', borderRadius: 6, background: appLang === 'en' ? 'var(--primary)' : 'transparent', fontSize: 12, cursor: 'pointer', transition: '0.2s' }}>EN</div>
                                            </div>
                                        </div>
                                        {/* Theme */}
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px 0' }}>
                                            <div style={{ color: 'var(--text-gray)' }}>{t.profile_theme_label}</div>
                                            <div style={{ display: 'flex', background: 'rgba(0,0,0,0.2)', padding: 4, borderRadius: 8 }}>
                                                <div onClick={() => onSetTheme('dark')} style={{ padding: '4px 12px', borderRadius: 6, background: theme === 'dark' ? '#333' : 'transparent', fontSize: 12, cursor: 'pointer', transition: '0.2s' }}>Dark</div>
                                                <div onClick={() => onSetTheme('light')} style={{ padding: '4px 12px', borderRadius: 6, background: theme === 'light' ? 'white' : 'transparent', color: theme === 'light' ? 'black' : 'white', fontSize: 12, cursor: 'pointer', transition: '0.2s' }}>Light</div>
                                            </div>
                                        </div>
                                        {/* Time Zone */}
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingTop: 12, borderTop: '1px solid rgba(255,255,255,0.05)' }}>
                                            <div style={{ color: 'var(--text-gray)' }}>{t.profile_timezone}</div>
                                            <div style={{ display: 'flex', background: 'rgba(0,0,0,0.2)', padding: 4, borderRadius: 8 }}>
                                                <div onClick={() => onSetTimeZone('WIB')} style={{ padding: '4px 12px', borderRadius: 6, background: timeZone === 'WIB' ? 'var(--primary)' : 'transparent', fontSize: 12, cursor: 'pointer', transition: '0.2s' }}>WIB</div>
                                                <div onClick={() => onSetTimeZone('WITA')} style={{ padding: '4px 12px', borderRadius: 6, background: timeZone === 'WITA' ? 'var(--primary)' : 'transparent', fontSize: 12, cursor: 'pointer', transition: '0.2s' }}>WITA</div>
                                                <div onClick={() => onSetTimeZone('WIT')} style={{ padding: '4px 12px', borderRadius: 6, background: timeZone === 'WIT' ? 'var(--primary)' : 'transparent', fontSize: 12, cursor: 'pointer', transition: '0.2s' }}>WIT</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="card">
                                        <h4>{t.profile_config_app}</h4>
                                        <div style={{ marginTop: 10, fontSize: 13, color: 'var(--text-gray)' }}>Versi 2.0.1 (Build 2026.01)</div>
                                    </div>

                                    {/* ADMIN PANEL SECTION */}
                                    {userRole === 'Admin' && (
                                        <div className="card" style={{ marginTop: 16, border: '1px solid var(--primary)', background: 'rgba(99, 102, 241, 0.1)' }}>
                                            <h4 style={{ color: 'var(--primary)', marginBottom: 12, display: 'flex', alignItems: 'center', gap: 8 }}>
                                                <Icon name="shield" size={16} /> Admin Panel
                                            </h4>
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
                                                <button onClick={onOpenUserMan} style={{ padding: '10px', background: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: 8, color: 'white', cursor: 'pointer', textAlign: 'left', display: 'flex', alignItems: 'center', gap: 10 }}>
                                                    <Icon name="users" size={16} /> Kelola Pengguna & Admin
                                                </button>
                                                <button onClick={onOpenDB} style={{ padding: '10px', background: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: 8, color: 'white', cursor: 'pointer', textAlign: 'left', display: 'flex', alignItems: 'center', gap: 10 }}>
                                                    <Icon name="database" size={16} /> Database Manager (Redis)
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    <div style={{ marginTop: 32, padding: '20px 0', borderTop: '1px solid var(--border)' }}>
                                        <button
                                            onClick={onLogout}
                                            style={{ width: '100%', padding: 14, border: 'none', background: 'rgba(255,255,255,0.05)', borderRadius: 12, color: 'white', fontWeight: 600, cursor: 'pointer', marginBottom: 12, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 10 }}
                                        >
                                            <Icon name="log-out" /> {t.profile_logout}
                                        </button>
                                        <button
                                            onClick={onDeleteAccount}
                                            style={{ width: '100%', padding: 14, border: '1px solid #EF4444', background: 'rgba(239, 68, 68, 0.05)', borderRadius: 12, color: '#EF4444', fontWeight: 600, cursor: 'pointer' }}
                                        >
                                            {t.profile_delete_acc}
                                        </button>
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                </Background3D>
            );
        };

        // --- Bidang Detail Screen (The "New Bar" View) ---
        const BidangDetail = ({ bidang, onBack, currentUserName, onAddKnowledge, categoryData, onUpdateCategoryData, addNotification, registeredMembers = [], t, onTagClick }) => {
            const [activeTab, setActiveTab] = useState('diskusi');
            const [msg, setMsg] = useState('');
            const [showMemberSelector, setShowMemberSelector] = useState(false);
            const [memberSearchTerm, setMemberSearchTerm] = useState('');
            const [selectedDiscussionIdx, setSelectedDiscussionIdx] = useState(null);
            const [expertPostText, setExpertPostText] = useState('');
            const [visibleComments, setVisibleComments] = useState({});
            const [commentInputs, setCommentInputs] = useState({});
            const [selectedFile, setSelectedFile] = useState(null);
            const chatFileRef = useRef(null);
            const inputRef = useRef(null);

            const { discussions = [] } = categoryData;

            const handleReplyTo = (user) => {
                setMsg(`@${user} `);
                setTimeout(() => inputRef.current?.focus(), 100);
            };

            const downloadFile = (fileData, fileName) => {
                const link = document.createElement('a');
                link.href = fileData;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleSend = () => {
                const hasFile = selectedFile !== null;
                const hasText = msg.trim().length > 0;

                if (!hasText && !hasFile) return;

                const processSend = (fileAttachment = null) => {
                    const newMsg = {
                        user: currentUserName || 'Anda',
                        text: msg,
                        time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                        self: true,
                        attachment: fileAttachment
                    };

                    const updatedChat = [...(categoryData.chatMessages || []), newMsg];
                    onUpdateCategoryData(bidang.name, {
                        ...categoryData,
                        chatMessages: updatedChat
                    });

                    setMsg('');
                    setSelectedFile(null);
                };

                if (selectedFile) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        processSend({
                            name: selectedFile.name,
                            type: selectedFile.type,
                            data: reader.result
                        });
                    };
                    reader.readAsDataURL(selectedFile);
                } else {
                    processSend();
                }
            };

            const handleChatFileSelect = (e) => {
                if (e.target.files[0]) setSelectedFile(e.target.files[0]);
            };

            const handleToggleLikeMaterial = (matId) => {
                const updatedMaterials = (categoryData.materials || []).map(m => {
                    if (m.id === matId) {
                        const newIsLiked = !m.isLiked;
                        return {
                            ...m,
                            isLiked: newIsLiked,
                            likes: newIsLiked ? (m.likes || 0) + 1 : Math.max(0, (m.likes || 1) - 1)
                        };
                    }
                    return m;
                });
                onUpdateCategoryData(bidang.name, { ...categoryData, materials: updatedMaterials });
            };

            const handleAddCommentMaterial = (matId) => {
                const comment = prompt('Tulis komentar Anda:');
                if (comment) {
                    const updatedMaterials = (categoryData.materials || []).map(m => {
                        if (m.id === matId) {
                            return { ...m, discussions: (m.discussions || 0) + 1 };
                        }
                        return m;
                    });
                    onUpdateCategoryData(bidang.name, { ...categoryData, materials: updatedMaterials });
                    alert(t.fd_comment_added);
                }
            };

            const selectMember = (member) => {
                if (selectedDiscussionIdx === null) {
                    // Global Bidang Member Invite
                    const currentMembers = categoryData.members || [];
                    if (currentMembers.some(m => m.name === member.name)) {
                        alert(`${member.name} sudah menjadi anggota di bidang ini.`);
                    } else {
                        const updatedMembers = [...currentMembers, { ...member, role: member.role || 'Member', joinedAt: new Date().toISOString() }];
                        onUpdateCategoryData(bidang.name, {
                            ...categoryData,
                            members: updatedMembers
                        });
                        alert(`${member.name} berhasil diundang ke ${bidang.name}.`);

                        if (addNotification) {
                            addNotification({
                                title: 'Undangan Berhasil',
                                desc: `Anda berhasil mengundang ${member.name}.`,
                                type: 'info',
                                target: 'bidang',
                                targetId: bidang.name
                            });
                        }
                    }
                    setShowMemberSelector(false);
                    return;
                }

                const updatedDiscussions = [...discussions];
                const disc = { ...updatedDiscussions[selectedDiscussionIdx] };
                if (!disc.participants) disc.participants = [];

                if (disc.participants.some(p => p.id === member.id)) {
                    alert(`${member.name} ${t.fd_alert_joined}`);
                } else {
                    disc.participants.push(member);
                    updatedDiscussions[selectedDiscussionIdx] = disc;
                    onUpdateCategoryData(bidang.name, { ...categoryData, discussions: updatedDiscussions });
                    alert(`${member.name} ${t.fd_alert_diskusi_added} "${disc.title}"`);

                    if (addNotification) {
                        addNotification({
                            title: 'Rekan Ditambahkan',
                            desc: `${member.name} bergabung dalam diskusi Anda.`,
                            type: 'info',
                            target: 'home'
                        });
                    }
                }
                setShowMemberSelector(false);
                setSelectedDiscussionIdx(null);
            };

            const handleJoinField = () => {
                const updatedMembers = [...(categoryData.members || []), { name: currentUserName, role: 'Member', joinedAt: new Date().toISOString() }];
                onUpdateCategoryData(bidang.name, { ...categoryData, members: updatedMembers });
                alert(`Berhasil bergabung di ${bidang.name}!`);
            };

            const isMember = (categoryData.members || []).some(m => m.name === currentUserName);

            return (
                <Background3D color1={bidang.color || 'var(--primary)'} color2="var(--secondary)">
                    <div className="animate" style={{ position: 'relative' }}>
                        {/* Member Selection Overlay */}
                        {showMemberSelector && (
                            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.8)', zIndex: 1000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 24 }}>
                                <div className="card animate" style={{ width: '100%', maxWidth: 360, maxHeight: '70vh', overflow: 'auto', border: '1px solid var(--primary)' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
                                        <h3 style={{ fontSize: 18 }}>{t.fd_choose_colleague}</h3>
                                        <div onClick={() => setShowMemberSelector(false)} style={{ cursor: 'pointer', padding: 8 }}><Icon name="x" /></div>
                                    </div>
                                    <div style={{ marginBottom: 16 }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: 10, background: 'rgba(255,255,255,0.05)', padding: '10px 14px', borderRadius: 12, border: '1px solid var(--border)' }}>
                                            <Icon name="search" size={16} color="var(--text-gray)" />
                                            <input
                                                placeholder={t.fd_search_colleague}
                                                value={memberSearchTerm}
                                                onChange={e => setMemberSearchTerm(e.target.value)}
                                                style={{ background: 'transparent', border: 'none', color: 'white', flex: 1, outline: 'none', fontSize: 13 }}
                                            />
                                        </div>
                                    </div>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                                        {(registeredMembers.length > 0 ? registeredMembers : REGISTERED_MEMBERS)
                                            .filter(m => m.name !== currentUserName)
                                            .filter(m => m.name.toLowerCase().includes(memberSearchTerm.toLowerCase()))
                                            .map(m => (
                                                <div key={m.id || m.name} onClick={() => selectMember(m)} className="nav-item" style={{ padding: 12, borderRadius: 12, background: 'rgba(255,255,255,0.03)', border: '1px solid var(--border)', display: 'flex', gap: 12, alignItems: 'center', cursor: 'pointer' }}>
                                                    <img src={m.image || `https://ui-avatars.com/api/?name=${encodeURIComponent(m.name)}&background=random&color=fff`} style={{ width: 40, height: 40, borderRadius: '50%', objectFit: 'cover' }} />
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: 600, fontSize: 14 }}>{m.name}</div>
                                                        <div style={{ fontSize: 11, color: 'var(--text-gray)' }}>{m.role || 'Member'}</div>
                                                    </div>
                                                    <Icon name="plus" size={16} color="var(--primary)" />
                                                </div>
                                            ))}
                                        {(registeredMembers.length > 0 ? registeredMembers : REGISTERED_MEMBERS).filter(m => m.name !== currentUserName).filter(m => m.name.toLowerCase().includes(memberSearchTerm.toLowerCase())).length === 0 && (
                                            <div style={{ textAlign: 'center', color: 'var(--text-gray)', fontSize: 12, padding: 10 }}>{t.fd_not_found}</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Header */}
                        <header className="page-header" style={{
                            padding: '16px 20px 4px',
                            background: `linear-gradient(135deg, ${bidang.color || 'var(--primary)'}, ${bidang.color || 'var(--secondary)'}dd)`,
                            color: 'white',
                            boxShadow: `0 10px 30px ${(bidang.color || 'var(--primary)')}44`
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                    <div onClick={onBack} style={{ cursor: 'pointer', padding: 6, background: 'rgba(255,255,255,0.2)', borderRadius: '50%' }}>
                                        <Icon name="chevron-left" size={20} color="white" />
                                    </div>
                                    <h2 style={{ fontSize: 16, fontWeight: 800 }}>{bidang.name}</h2>
                                </div>
                                <div style={{ display: 'flex', gap: 8 }}>
                                    {!isMember && (
                                        <button onClick={handleJoinField} style={{
                                            padding: '6px 12px', background: 'rgba(255,255,255,0.2)', border: '1px solid rgba(255,255,255,0.3)', borderRadius: 10, color: 'white', fontSize: 11, fontWeight: 700, display: 'flex', alignItems: 'center', gap: 4, cursor: 'pointer'
                                        }}>
                                            <Icon name="log-in" size={14} /> {t.join_title || 'Ikut Serta'}
                                        </button>
                                    )}
                                    <button onClick={() => { setSelectedDiscussionIdx(null); setShowMemberSelector(true); }} style={{
                                        padding: '6px 12px', background: 'rgba(0,0,0,0.2)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 10, color: 'white', fontSize: 11, fontWeight: 700, display: 'flex', alignItems: 'center', gap: 4, cursor: 'pointer'
                                    }}>
                                        <Icon name="user-plus" size={14} /> {t.invite_label}
                                    </button>
                                </div>
                            </div>

                            <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }}>
                                <div style={{ width: 36, height: 36, borderRadius: 10, background: 'rgba(255,255,255,0.2)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 18 }}>
                                    {bidang.icon}
                                </div>
                                <div>
                                    <div style={{ fontSize: 13, fontWeight: 800 }}>{bidang.name} {t.fd_expert_hub}</div>
                                    <div style={{ fontSize: 10, opacity: 0.9 }}>{discussions.length} {t.fd_tab_diskusi} • {categoryData.materials?.length || 0} {t.fd_tab_materi} • {(categoryData.members || []).length} {t.tab_anggota || 'Anggota'}</div>
                                </div>
                            </div>

                            <div style={{ padding: '0 0 10px', position: 'relative', display: 'flex', gap: 8, overflowX: 'auto', zIndex: 10 }}>
                                {['diskusi', 'materi', 'ahli'].map(t_key => (
                                    <button
                                        key={t_key}
                                        onClick={() => setActiveTab(t_key)}
                                        style={{
                                            flexShrink: 0, padding: '8px 16px', borderRadius: '12px',
                                            background: activeTab === t_key ? (bidang.color || 'var(--primary)') : 'var(--bg-card)',
                                            color: activeTab === t_key ? 'white' : 'var(--text-gray)',
                                            border: `1px solid ${activeTab === t_key ? 'transparent' : 'var(--border)'}`,
                                            fontWeight: 700, fontSize: '12px', cursor: 'pointer', transition: 'all 0.3s',
                                            display: 'flex', alignItems: 'center', gap: 6
                                        }}
                                    >
                                        <Icon name={t_key === 'diskusi' ? 'message-circle' : t_key === 'materi' ? 'book-open' : 'award'} size={16} />
                                        {t_key === 'diskusi' ? `${t.fd_tab_diskusi} (${discussions.length})` : t_key === 'materi' ? `${t.fd_tab_materi} (${(categoryData.materials || []).length})` : t.fd_tab_ahli}
                                    </button>
                                ))}
                            </div>
                        </header>

                        <div className="container" style={{ padding: '24px 0' }}>
                            <div style={{ minHeight: '300px' }}>
                                {activeTab === 'diskusi' && (
                                    <div className="animate">
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                                            <h3 style={{ fontSize: 16 }}>{t.fd_list_diskusi}</h3>
                                            <Icon name="message-square" size={20} color="var(--primary)" />
                                        </div>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                                            {discussions.length === 0 && <div style={{ textAlign: 'center', color: 'var(--text-gray)', padding: 20 }}>{t.fd_empty_diskusi}</div>}
                                            {discussions.map((d, i) => (
                                                <QuestionCard
                                                    key={i} user={d.user} title={d.title} tags={d.tags} comments={d.comments} participants={d.participants}
                                                    onReply={() => handleReplyTo(d.user)}
                                                    onAddColleague={() => { setSelectedDiscussionIdx(i); setShowMemberSelector(true); }}
                                                    onDelete={() => {
                                                        if (confirm(t.fd_confirm_delete_diskusi)) {
                                                            const updated = discussions.filter((_, idx) => idx !== i);
                                                            onUpdateCategoryData(bidang.name, { ...categoryData, discussions: updated });
                                                        }
                                                    }}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'materi' && (
                                    <div className="animate">
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                                            <h3 style={{ fontSize: 16 }}>{t.fd_modul_title}</h3>
                                            <button
                                                onClick={() => {
                                                    const title = prompt(t.fd_prompt_material_title);
                                                    if (title) {
                                                        const newMaterial = {
                                                            id: Date.now(), title,
                                                            update: new Date().toLocaleDateString('id-ID', { month: 'short', year: 'numeric' }),
                                                            type: 'PDF', discussions: 0, likes: 0, isLiked: false, url: '#'
                                                        };
                                                        onUpdateCategoryData(bidang.name, { ...categoryData, materials: [newMaterial, ...(categoryData.materials || [])] });
                                                    }
                                                }}
                                                style={{ padding: '6px 12px', background: 'var(--primary)', border: 'none', borderRadius: 8, color: 'white', fontSize: '12px', fontWeight: 600, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 4 }}
                                            >
                                                <Icon name="plus" size={14} /> {t.fd_btn_add_materi}
                                            </button>
                                        </div>
                                        {(categoryData.materials || []).map(mat => (
                                            <div key={mat.id} className="card" style={{ marginBottom: 16, cursor: 'pointer' }} onClick={() => alert(`${t.fd_alert_open_doc}: ${mat.title}`)}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }}>
                                                    <div style={{ padding: 12, background: 'rgba(99, 102, 241, 0.1)', borderRadius: 12, color: 'var(--primary)' }}><Icon name="file-text" /></div>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: 600 }}>{mat.title}</div>
                                                        <div style={{ fontSize: 12, color: 'var(--text-gray)' }}>{t.fd_update_label}: {mat.update} • {mat.type}</div>
                                                    </div>
                                                </div>
                                                <div style={{ display: 'flex', gap: 16, borderTop: '1px solid rgba(255,255,255,0.05)', paddingTop: 12 }}>
                                                    <div onClick={(e) => { e.stopPropagation(); handleAddCommentMaterial(mat.id); }} style={{ fontSize: 12, color: 'var(--text-gray)', display: 'flex', alignItems: 'center', gap: 4, cursor: 'pointer' }}>
                                                        <Icon name="message-circle" size={14} /> {mat.discussions}
                                                    </div>
                                                    <div onClick={(e) => { e.stopPropagation(); handleToggleLikeMaterial(mat.id); }} style={{ fontSize: 12, color: mat.isLiked ? '#EF4444' : 'var(--text-gray)', display: 'flex', alignItems: 'center', gap: 4, cursor: 'pointer' }}>
                                                        <Icon name="heart" size={14} fill={mat.isLiked ? '#EF4444' : 'none'} color={mat.isLiked ? '#EF4444' : 'currentColor'} /> {mat.likes}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {activeTab === 'ahli' && (
                                    <div className="animate">
                                        <h3 style={{ marginBottom: 16, fontSize: 16 }}>{t.fd_expert_title}</h3>
                                        <div className="card" style={{ marginBottom: 24, padding: 16 }}>
                                            <div style={{ display: 'flex', gap: 12 }}>
                                                <div style={{ width: 40, height: 40, borderRadius: '50%', background: 'var(--primary)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white' }}><Icon name="user" size={20} /></div>
                                                <div style={{ flex: 1 }}>
                                                    <textarea
                                                        placeholder={`${t.fd_expert_placeholder} ${bidang.name}...`}
                                                        value={expertPostText}
                                                        onChange={(e) => setExpertPostText(e.target.value)}
                                                        style={{ width: '100%', background: 'transparent', border: 'none', color: 'white', resize: 'none', minHeight: 60, outline: 'none' }}
                                                    />
                                                    <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: 8 }}>
                                                        <button
                                                            onClick={() => {
                                                                if (!expertPostText.trim()) return;
                                                                const newPost = { id: Date.now(), user: currentUserName || "Anda", role: "Ahli", content: expertPostText, timestamp: t.fd_just_now, comments: [] };
                                                                onUpdateCategoryData(bidang.name, { ...categoryData, expertPosts: [newPost, ...(categoryData.expertPosts || [])] });
                                                                setExpertPostText('');
                                                            }}
                                                            style={{ padding: '8px 16px', background: 'var(--primary)', color: 'white', border: 'none', borderRadius: 8, cursor: 'pointer', fontWeight: 600 }}
                                                        >Posting</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {(categoryData.expertPosts || []).map(post => (
                                            <div key={post.id} className="card" style={{ marginBottom: 16 }}>
                                                <div style={{ display: 'flex', gap: 12, marginBottom: 12 }}>
                                                    <div style={{ width: 40, height: 40, borderRadius: '50%', background: 'linear-gradient(45deg, #10B981, #3B82F6)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white' }}>{post.user[0]}</div>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: 600 }}>{post.user} <Icon name="check-circle" size={12} fill="#3B82F6" color="white" /></div>
                                                        <div style={{ fontSize: 12, color: 'var(--text-gray)' }}>{post.timestamp}</div>
                                                    </div>
                                                </div>
                                                <div style={{ fontSize: 14, lineHeight: 1.5, marginBottom: 16 }}>{post.content}</div>
                                                <div onClick={() => setVisibleComments(prev => ({ ...prev, [post.id]: !prev[post.id] }))} style={{ fontSize: 13, color: 'var(--text-gray)', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 6 }}>
                                                    <Icon name="message-circle" size={16} /> {post.comments?.length || 0} {t.fd_comments_label}
                                                </div>
                                                {visibleComments[post.id] && (
                                                    <div style={{ marginTop: 12, paddingLeft: 12, borderLeft: '2px solid rgba(255,255,255,0.1)' }}>
                                                        {(post.comments || []).map(c => (
                                                            <div key={c.id} style={{ marginBottom: 8, fontSize: 13 }}>
                                                                <span style={{ fontWeight: 700 }}>{c.user}: </span> {renderTextWithMentions(c.text, onTagClick)}
                                                            </div>
                                                        ))}
                                                        <input
                                                            type="text" placeholder={t.fd_reply_placeholder}
                                                            value={commentInputs[post.id] || ''}
                                                            onChange={e => setCommentInputs(prev => ({ ...prev, [post.id]: e.target.value }))}
                                                            onKeyDown={e => {
                                                                if (e.key === 'Enter' && commentInputs[post.id]) {
                                                                    const newComment = { id: Date.now(), user: currentUserName || 'Anda', text: commentInputs[post.id], timestamp: t.fd_just_now };
                                                                    const updated = categoryData.expertPosts.map(p => p.id === post.id ? { ...p, comments: [...(p.comments || []), newComment] } : p);
                                                                    onUpdateCategoryData(bidang.name, { ...categoryData, expertPosts: updated });
                                                                    setCommentInputs(prev => ({ ...prev, [post.id]: '' }));
                                                                }
                                                            }}
                                                            style={{ width: '100%', background: 'rgba(255,255,255,0.05)', border: 'none', borderRadius: 8, padding: '8px 12px', color: 'white', marginTop: 8 }}
                                                        />
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {/* Chat Feed Area (Persistent) */}
                                <div style={{ marginTop: 32, padding: '24px 0', borderTop: '1px solid var(--border)' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16 }}>
                                        <div style={{ width: 8, height: 8, background: '#10B981', borderRadius: '50%' }}></div>
                                        <h3 style={{ fontSize: 14, fontWeight: 700 }}>{t.fd_public_chat}</h3>
                                    </div>
                                    <div style={{ maxHeight: 400, overflowY: 'auto', paddingRight: 8, display: 'flex', flexDirection: 'column', gap: 16 }}>
                                        {(categoryData.chatMessages || []).length === 0 && <div style={{ textAlign: 'center', color: 'var(--text-gray)', fontSize: 13 }}>{t.fd_chat_empty}</div>}
                                        {(categoryData.chatMessages || []).map((m, idx) => (
                                            <div key={idx} style={{ display: 'flex', gap: 12, flexDirection: m.self ? 'row-reverse' : 'row', alignItems: 'flex-start' }}>
                                                <div style={{ width: 32, height: 32, borderRadius: '50%', background: m.self ? 'var(--primary)' : 'rgba(255,255,255,0.1)', flexShrink: 0, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 12, fontWeight: 700 }}>{m.user[0]}</div>
                                                <div style={{ maxWidth: '80%', background: m.self ? 'rgba(99, 102, 241, 0.1)' : 'rgba(255,255,255,0.03)', padding: 12, borderRadius: m.self ? '12px 0 12px 12px' : '0 12px 12px 12px', border: '1px solid var(--border)' }}>
                                                    <div style={{ fontSize: 11, fontWeight: 700, color: m.self ? 'var(--primary)' : '#ddd', marginBottom: 4 }}>{m.user}</div>
                                                    <div style={{ fontSize: 13 }}>{renderTextWithMentions(m.text, onTagClick)}</div>
                                                    {m.attachment && (
                                                        <div onClick={() => downloadFile(m.attachment.data, m.attachment.name)} style={{ marginTop: 8, padding: 8, background: 'rgba(0,0,0,0.2)', borderRadius: 8, display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer', border: '1px solid rgba(255,255,255,0.1)' }}>
                                                            <Icon name="file-text" size={14} />
                                                            <div style={{ fontSize: 11, flex: 1, overflow: 'hidden', textOverflow: 'ellipsis' }}>{m.attachment.name}</div>
                                                            <Icon name="download" size={14} opacity={0.5} />
                                                        </div>
                                                    )}
                                                    <div style={{ fontSize: 9, color: 'var(--text-gray)', marginTop: 4, textAlign: 'right' }}>{m.time}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Input Area */}
                        <div style={{ padding: 20, background: 'rgba(0,0,0,0.3)', backdropFilter: 'blur(20px)', borderTop: '1px solid var(--border)' }}>
                            <div style={{ display: 'flex', gap: 10, alignItems: 'center' }}>
                                <input type="file" ref={chatFileRef} style={{ display: 'none' }} onChange={handleChatFileSelect} />
                                <button onClick={() => chatFileRef.current.click()} style={{ width: 40, height: 40, borderRadius: 12, background: selectedFile ? '#10B981' : 'rgba(255,255,255,0.1)', border: 'none', color: 'white', cursor: 'pointer' }}><Icon name={selectedFile ? 'check' : 'paperclip'} size={18} /></button>
                                <input
                                    ref={inputRef} type="text" placeholder={t.fd_chat_placeholder}
                                    style={{ flex: 1, background: 'rgba(255,255,255,0.05)', border: '1px solid var(--border)', borderRadius: 12, padding: '10px 16px', color: 'white', outline: 'none' }}
                                    value={msg} onChange={e => setMsg(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()}
                                />
                                <button onClick={handleSend} style={{ width: 40, height: 40, borderRadius: 12, background: 'var(--primary)', border: 'none', color: 'white', cursor: 'pointer' }}><Icon name="send" size={18} /></button>
                            </div>
                        </div>
                    </div>
                </Background3D>
            );
        };

        const Home = ({ userName, userRole, checkPermission, onCreateQuestion, onBidangClick, onNavigate, onOpenDB, onLogout, knowledgeBase, getCategoryCount, categories, t }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [searchSource, setSearchSource] = useState('internal'); // internal, google, chatgpt, youtube
            const [showSourceSelector, setShowSourceSelector] = useState(false);
            const [showMoreMenu, setShowMoreMenu] = useState(false);
            const [selectedKnowledge, setSelectedKnowledge] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);

            const searchSources = [
                { id: 'internal', name: 'Internal', icon: 'search', color: 'var(--primary)', placeholder: 'Cari bidang...' },
                { id: 'google', name: 'Google', icon: 'globe', color: '#4285F4', placeholder: 'Ketik & cari di Google...' },
                { id: 'chatgpt', name: 'ChatGPT', icon: 'zap', color: '#10a37f', placeholder: 'Tanya AI (ChatGPT)...' },
                { id: 'youtube', name: 'YouTube', icon: 'video', color: '#FF0000', placeholder: 'Cari panduan video...' }
            ];

            const activeSource = searchSources.find(s => s.id === searchSource);

            const handleSearchAction = () => {
                const query = searchTerm.trim();

                if (searchSource === 'google') {
                    window.open(query ? `https://www.google.com/search?q=${encodeURIComponent(query)}` : 'https://www.google.com', '_blank');
                } else if (searchSource === 'chatgpt') {
                    window.open(query ? `https://chatgpt.com/?q=${encodeURIComponent(query)}` : 'https://chatgpt.com', '_blank');
                } else if (searchSource === 'youtube') {
                    window.open(query ? `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}` : 'https://www.youtube.com', '_blank');
                }
                // internal search is handled by filtering the list automatically
            };

            // Filter logic: Only filter if internal search is active. Otherwise show all (or could show none, but showing all is better UX for "dashboard" feel)
            const filteredBidang = (categories || []).filter(b => {
                if (searchSource !== 'internal') return true; // Don't hide grid when searching external
                return b.name.toLowerCase().includes(searchTerm.toLowerCase());
            });

            const questions = [
                { user: "Ahmad Rizky", title: "Laptop tidak bisa connect ke WiFi kantor setelah update Windows", tags: ["Network", "Hardware"], time: "2m lalu" },
                { user: "Budi Santoso", title: "Error runtime saat menjalankan aplikasi Node.js", tags: ["Runtimes", "Development"], time: "15m lalu" },
                { user: "Dewi Lestari", title: "Cara install driver printer HP di Mac M2?", tags: ["Hardware", "Software"], time: "1j lalu" },
                { user: "Siti Aminah", title: "Database connection lost saat high traffic", tags: ["Database", "Backend"], time: "2j lalu" },
                { user: "Rudi Hermawan", title: "Rekomendasi text editor ringan untuk PC kentang", tags: ["Software", "Tools"], time: "3j lalu" }
            ];

            useEffect(() => {
                const handleClickOutside = () => {
                    setShowSourceSelector(false);
                    setShowMoreMenu(false);
                };
                if (showSourceSelector || showMoreMenu) {
                    window.addEventListener('click', handleClickOutside);
                    return () => window.removeEventListener('click', handleClickOutside);
                }
            }, [showSourceSelector, showMoreMenu]);

            return (
                <Background3D color1="var(--primary)" color2="var(--secondary)">
                    <div className="animate">
                        <header className="page-header" style={{
                            position: 'sticky',
                            top: 0,
                            zIndex: 100,
                            padding: '12px 16px 16px', // Ultra-compact padding
                            borderBottomLeftRadius: 20, // Professional sharp radius
                            borderBottomRightRadius: 20,
                            background: `linear-gradient(135deg, ${searchSource === 'internal' ? 'var(--primary)' : activeSource.color + 'aa'}, var(--secondary))`,
                            transition: 'background 0.5s ease',
                            boxShadow: `0 15px 30px ${searchSource === 'internal' ? 'rgba(0,0,0,0.2)' : activeSource.color + '22'}`,
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                <div>
                                    <h1 style={{ fontSize: '20px', fontWeight: '700', color: 'white' }}>{t.nav_home}</h1>
                                    <p style={{ color: 'rgba(255,255,255,0.8)', fontSize: '11px', marginTop: 0 }}>
                                        {(() => {
                                            const h = new Date().getHours();
                                            if (h < 11) return t.welcome_morning;
                                            if (h < 15) return t.welcome_afternoon;
                                            if (h < 18) return t.welcome_evening;
                                            return t.welcome_night;
                                        })()}, {userName || 'Karyawan'}!
                                        <span style={{
                                            display: 'inline-block',
                                            marginLeft: '6px',
                                            padding: '1px 6px',
                                            borderRadius: '4px',
                                            background: 'rgba(99, 102, 241, 0.2)',
                                            color: '#818cf8',
                                            fontSize: '9px',
                                            fontWeight: '700',
                                            border: '1px solid rgba(99, 102, 241, 0.3)',
                                            verticalAlign: 'middle'
                                        }}>{userRole}</span>
                                    </p>
                                </div>
                                <div style={{ position: 'relative' }}>
                                    <div
                                        onClick={(e) => { e.stopPropagation(); setShowMoreMenu(!showMoreMenu); }}
                                        style={{
                                            cursor: 'pointer',
                                            width: 34, // Compact
                                            height: 34, // Compact
                                            background: 'rgba(255,255,255,0.15)',
                                            borderRadius: '12px',
                                            color: 'white',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            border: '1px solid rgba(255,255,255,0.2)',
                                            backdropFilter: 'blur(10px)',
                                            transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                                            transform: showMoreMenu ? 'rotate(90deg)' : 'rotate(0deg)',
                                            boxShadow: showMoreMenu ? `0 0 15px ${searchSource === 'internal' ? 'rgba(255,255,255,0.3)' : activeSource.color + '66'}` : 'none'
                                        }}
                                        onMouseOver={e => e.currentTarget.style.background = 'rgba(255,255,255,0.25)'}
                                        onMouseOut={e => e.currentTarget.style.background = 'rgba(255,255,255,0.15)'}
                                    >
                                        <Icon name="more-vertical" size={20} />
                                    </div>

                                    {showMoreMenu && (
                                        <div className="animate" style={{
                                            position: 'absolute',
                                            top: 'calc(100% + 12px)',
                                            right: 0,
                                            zIndex: 10000,
                                            width: 220,
                                            padding: 10,
                                            background: 'rgba(15, 23, 42, 0.95)',
                                            borderRadius: 20,
                                            border: `1px solid ${searchSource === 'internal' ? 'rgba(255,255,255,0.1)' : activeSource.color + '44'}`,
                                            backdropFilter: 'blur(30px)',
                                            boxShadow: '0 30px 60px rgba(0,0,0,0.8)',
                                            overflow: 'hidden'
                                        }}>
                                            {/* User Quick Info */}
                                            <div style={{ padding: '12px 14px', marginBottom: 8, borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                                <div style={{ fontSize: 13, fontWeight: 700, color: 'white' }}>{userName || 'Karyawan'}</div>
                                                <div style={{ fontSize: 10, color: 'var(--text-gray)' }}>{t.menu_role}: {userRole} • Status: {t.menu_status_active} 🟢</div>
                                            </div>

                                            {[
                                                { icon: 'user', label: t.menu_my_profile, desc: t.menu_profile_desc, color: '#3B82F6', target: 'profil' },
                                                { icon: 'bell', label: t.menu_notif, desc: t.menu_notif_desc, color: '#F59E0B', target: 'notif' },
                                                { icon: 'history', label: t.menu_history, desc: t.menu_history_desc, color: '#8B5CF6', target: 'pesan' },
                                                { type: 'divider' },
                                                { icon: 'life-buoy', label: t.menu_help, desc: t.menu_help_desc, color: '#10B981', target: 'bantuan' },
                                                { icon: 'settings', label: t.menu_settings, desc: t.menu_settings_desc, color: '#64748B', target: 'profil' },
                                                // Admin Only DB Menu
                                                ...(checkPermission('create_user') ? [{ icon: 'database', label: t.menu_db_manager, desc: t.menu_db_desc, color: '#10B981', action: 'opendb' }] : []),
                                                { type: 'divider' },
                                                { icon: 'power', label: t.menu_logout, desc: t.menu_logout_desc, color: '#EF4444', action: 'logout' }
                                            ].map((item, idx) => (
                                                item.type === 'divider' ? (
                                                    <div key={idx} style={{ height: 1, background: 'rgba(255,255,255,0.08)', margin: '6px 12px' }} />
                                                ) : (
                                                    <div
                                                        key={idx}
                                                        style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: 12,
                                                            padding: '10px 14px',
                                                            borderRadius: 14,
                                                            cursor: 'pointer',
                                                            transition: 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)'
                                                        }}
                                                        onMouseOver={e => {
                                                            e.currentTarget.style.background = `${item.color}15`;
                                                            e.currentTarget.style.transform = 'translateX(4px)';
                                                        }}
                                                        onMouseOut={e => {
                                                            e.currentTarget.style.background = 'transparent';
                                                            e.currentTarget.style.transform = 'translateX(0)';
                                                        }}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setShowMoreMenu(false);
                                                            if (item.action === 'logout') {
                                                                onLogout();
                                                            } else if (item.action === 'opendb') {
                                                                onOpenDB();
                                                            } else if (item.target) {
                                                                onNavigate(item.target);
                                                            }
                                                        }}
                                                    >
                                                        <div style={{
                                                            width: 32, height: 32,
                                                            borderRadius: 10,
                                                            background: `${item.color}22`,
                                                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                            border: `1px solid ${item.color}33`
                                                        }}>
                                                            <Icon name={item.icon} size={16} color={item.color} />
                                                        </div>
                                                        <div style={{ flex: 1 }}>
                                                            <div style={{ fontSize: 13, fontWeight: 700, color: 'white' }}>{item.label}</div>
                                                            <div style={{ fontSize: 9, color: 'var(--text-gray)', fontWeight: 500 }}>{item.desc}</div>
                                                        </div>
                                                        <Icon name="chevron-right" size={12} color="rgba(255,255,255,0.2)" />
                                                    </div>
                                                )
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div style={{ position: 'relative' }}>
                                <div className="search-bar" style={{
                                    background: 'rgba(255,255,255,0.15)',
                                    border: `1.5px solid ${searchSource === 'internal' ? 'rgba(255,255,255,0.2)' : activeSource.color}`,
                                    marginTop: 10, // Ultra-compact margin
                                    transition: 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                                    boxShadow: searchSource === 'internal' ? 'none' : `0 0 20px ${activeSource.color}44`,
                                    backdropFilter: 'blur(10px)'
                                }}>
                                    <div
                                        onClick={(e) => { e.stopPropagation(); setShowSourceSelector(!showSourceSelector); }}
                                        style={{
                                            cursor: 'pointer',
                                            padding: '4px 8px', // Reduced padding
                                            background: 'rgba(255,255,255,0.1)',
                                            borderRadius: 10,
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: 8,
                                            marginRight: 6,
                                            transition: 'all 0.3s',
                                            border: `1px solid ${searchSource === 'internal' ? 'transparent' : activeSource.color + '33'}`
                                        }}
                                        onMouseOver={e => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                                        onMouseOut={e => e.currentTarget.style.background = 'rgba(255,255,255,0.1)'}
                                    >
                                        <Icon name={activeSource.icon} color={searchSource === 'internal' ? 'white' : activeSource.color} size={18} />
                                        <Icon name="chevron-down" size={12} color="rgba(255,255,255,0.6)" />
                                    </div>
                                    <input
                                        type="text"
                                        placeholder={activeSource.placeholder}
                                        style={{ color: 'white', fontWeight: '500' }}
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && handleSearchAction()}
                                    />
                                    {searchTerm && (
                                        <div
                                            onClick={handleSearchAction}
                                            className="animate-pulse"
                                            style={{
                                                cursor: 'pointer',
                                                padding: '8px 12px',
                                                background: activeSource.color,
                                                borderRadius: 10,
                                                marginLeft: 8,
                                                boxShadow: `0 4px 12px ${activeSource.color}66`
                                            }}
                                        >
                                            <Icon name="arrow-right" size={18} color="white" />
                                        </div>
                                    )}
                                </div>

                                {/* Source Selector Menu (Maximized UI) */}
                                {showSourceSelector && (
                                    <div className="animate" style={{
                                        position: 'absolute',
                                        top: 'calc(100% + 12px)',
                                        left: 0,
                                        zIndex: 9999,
                                        padding: 10,
                                        width: 240,
                                        background: 'rgba(15, 23, 42, 0.9)',
                                        borderRadius: 20,
                                        boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.7)',
                                        border: `1px solid ${activeSource.color}55`,
                                        backdropFilter: 'blur(24px)',
                                        overflow: 'hidden'
                                    }}>
                                        <div style={{ fontSize: 11, color: 'var(--text-gray)', padding: '6px 14px 10px', textTransform: 'uppercase', letterSpacing: 1.5, fontWeight: 700 }}>Sumber Bantuan</div>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>
                                            {searchSources.map(s => (
                                                <div
                                                    key={s.id}
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setSearchSource(s.id);
                                                        setShowSourceSelector(false);
                                                    }}
                                                    style={{
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: 14,
                                                        padding: '12px 14px',
                                                        borderRadius: 14,
                                                        cursor: 'pointer',
                                                        background: searchSource === s.id ? `${s.color}22` : 'transparent',
                                                        transition: 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)',
                                                        border: `1px solid ${searchSource === s.id ? s.color + '44' : 'transparent'}`
                                                    }}
                                                    onMouseOver={e => e.currentTarget.style.background = `${s.color}11`}
                                                    onMouseOut={e => e.currentTarget.style.background = searchSource === s.id ? `${s.color}22` : 'transparent'}
                                                >
                                                    <div style={{
                                                        width: 36, height: 36,
                                                        borderRadius: 10,
                                                        background: searchSource === s.id ? s.color : `${s.color}22`,
                                                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                        transition: 'all 0.3s'
                                                    }}>
                                                        <Icon name={s.icon} color={searchSource === s.id ? 'white' : s.color} size={20} />
                                                    </div>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontSize: 13, fontWeight: 700, color: searchSource === s.id ? 'white' : 'rgba(255,255,255,0.7)' }}>{s.name}</div>
                                                        <div style={{ fontSize: 10, color: 'var(--text-gray)' }}>Buka {s.name}</div>
                                                    </div>
                                                    {searchSource === s.id && (
                                                        <div style={{ width: 8, height: 8, borderRadius: '50%', background: s.color, boxShadow: `0 0 10px ${s.color}` }}></div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Quick External Links (Premium Cards) */}
                            <div style={{ display: 'flex', gap: 8, marginTop: 8 }}>
                                <button
                                    onClick={() => window.open(searchTerm.trim() ? `https://www.google.com/search?q=${encodeURIComponent(searchTerm)}` : 'https://www.google.com', '_blank')}
                                    style={{
                                        flex: 1, padding: '6px 10px', // Ultra-compact padding
                                        background: 'rgba(255,255,255,0.95)',
                                        color: '#4285F4', borderRadius: 12, // Smaller radius
                                        border: 'none', fontSize: 11, fontWeight: 700, // Smaller font
                                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                                        gap: 10, cursor: 'pointer',
                                        boxShadow: '0 8px 16px rgba(0,0,0,0.15)',
                                        transition: 'transform 0.2s'
                                    }}
                                    onMouseOver={e => e.currentTarget.style.transform = 'translateY(-2px)'}
                                    onMouseOut={e => e.currentTarget.style.transform = 'translateY(0)'}
                                >
                                    <img src="https://www.google.com/favicon.ico" style={{ width: 14 }} /> Google
                                </button>
                                <button
                                    onClick={() => window.open(searchTerm.trim() ? `https://chatgpt.com/?q=${encodeURIComponent(searchTerm)}` : 'https://chatgpt.com', '_blank')}
                                    style={{
                                        flex: 1, padding: '6px 10px',
                                        background: '#10a37f',
                                        color: 'white', borderRadius: 12,
                                        border: 'none', fontSize: 11, fontWeight: 700,
                                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                                        gap: 10, cursor: 'pointer',
                                        boxShadow: '0 8px 20px rgba(16,163,127,0.3)',
                                        transition: 'transform 0.2s'
                                    }}
                                    onMouseOver={e => e.currentTarget.style.transform = 'translateY(-2px)'}
                                    onMouseOut={e => e.currentTarget.style.transform = 'translateY(0)'}
                                >
                                    <Icon name="zap" size={14} /> ChatGPT
                                </button>
                            </div>
                        </header>

                        <div className="container" style={{ paddingBottom: 40 }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20, padding: '0 16px' }}>
                                <h3 style={{ fontSize: 18, fontWeight: 800 }}>{t.fav_fields}</h3>
                                <div onClick={() => onNavigate('bidang')} style={{ fontSize: 13, color: 'var(--primary)', fontWeight: 700, cursor: 'pointer' }}>{t.view_all}</div>
                            </div>

                            <div className="favorites-grid" style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fill, minmax(clamp(130px, 15vw, 160px), 1fr))',
                                gap: 'var(--gap-responsive)'
                            }}>
                                {filteredBidang.map(b => (
                                    <div key={b.name}
                                        className="card bidang-card"
                                        style={{
                                            '--glow-color': b.color,
                                            padding: '24px 16px',
                                            cursor: 'pointer'
                                        }}
                                        onClick={() => onBidangClick && onBidangClick(b)}
                                    >
                                        <div className="category-glow-bg"></div>
                                        <div className="icon-container-3d" style={{ width: 64, height: 64, marginBottom: 16 }}>
                                            <div className="icon-box" style={{ fontSize: 'clamp(28px, 5vw, 36px)', borderRadius: 16 }}>
                                                {b.icon}
                                            </div>
                                            <div className="icon-shadow-3d" style={{ width: 40, height: 8 }}></div>
                                        </div>
                                        <div style={{
                                            fontSize: '13px',
                                            fontWeight: '800',
                                            color: 'white',
                                            marginBottom: 2,
                                            zIndex: 10
                                        }}>{b.name}</div>
                                        <div style={{
                                            fontSize: '10px',
                                            color: b.color,
                                            fontWeight: 700,
                                            textTransform: 'uppercase',
                                            letterSpacing: 0.5,
                                            zIndex: 10
                                        }}>{getCategoryCount ? getCategoryCount(b.name) : 0} {t.field_topics}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div style={{ paddingBottom: 20 }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10, padding: '0 16px' }}>
                                <div>
                                    <h3 style={{ fontSize: 'clamp(15px, 4vw, 18px)', fontWeight: '800' }}>{t.ai_base_title}</h3>
                                    <p style={{ fontSize: 11, color: 'var(--text-gray)', marginTop: 4 }}>{t.ai_base_subtitle}</p>
                                </div>
                                <div style={{ fontSize: 13, color: 'var(--primary)', fontWeight: 700, cursor: 'pointer' }}>{t.explore}</div>
                            </div>
                            <div className="content-scroll-area">
                                <KnowledgeFeed
                                    searchTerm={searchSource === 'internal' ? searchTerm : ''}
                                    knowledgeBase={knowledgeBase}
                                    onKnowledgeClick={(k) => {
                                        setSelectedKnowledge(k);
                                        setIsAnalyzing(true);
                                        setTimeout(() => setIsAnalyzing(false), 2000);
                                    }}
                                    t={t}
                                />
                            </div>
                        </div>

                        {/* AI Analysis Modal Overlay */}
                        {
                            selectedKnowledge && (
                                <div style={{
                                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                                    background: 'rgba(0,0,0,0.9)', backdropFilter: 'blur(15px)',
                                    zIndex: 30000, display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    padding: 20
                                }} onClick={() => setSelectedKnowledge(null)}>
                                    <div className="animate" style={{
                                        maxWidth: 'min(95vw, 850px)', width: 'calc(100% - 32px)', background: 'var(--bg-card)',
                                        borderRadius: 32, border: '1px solid var(--primary)',
                                        maxHeight: '92vh', overflowY: 'auto', overflowX: 'hidden',
                                        position: 'relative', boxShadow: '0 0 80px rgba(99, 102, 241, 0.4)',
                                        margin: 'auto', WebkitOverflowScrolling: 'touch'
                                    }} onClick={e => e.stopPropagation()}>
                                        {isAnalyzing && (
                                            <div style={{
                                                position: 'absolute', top: 0, left: 0, right: 0, bottom: 0,
                                                background: 'rgba(15, 23, 42, 0.95)', zIndex: 40000,
                                                display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',
                                                gap: 20
                                            }}>
                                                <div className="animate-pulse" style={{ width: 80, height: 80, borderRadius: '50%', border: '4px solid var(--primary)', borderTopColor: 'transparent', animation: 'spin 1.5s linear infinite' }}></div>
                                                <div style={{ color: 'white', fontWeight: 800, fontSize: 18 }}>{t.kf_ai_analyzing}</div>
                                                <div style={{ color: 'var(--text-gray)', fontSize: 12 }}>{t.kf_ai_connecting}</div>
                                            </div>
                                        )}
                                        {/* Header Modal */}
                                        <div style={{ background: 'linear-gradient(135deg, var(--primary), var(--secondary))', padding: 'clamp(16px, 4vw, 24px) clamp(20px, 5vw, 30px)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: 15 }}>
                                                <div style={{ width: 'clamp(36px, 10vw, 44px)', height: 'clamp(36px, 10vw, 44px)', background: 'rgba(255,255,255,0.2)', borderRadius: 12, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                                    <Icon name="brain-circuit" size={24} color="white" />
                                                </div>
                                                <div>
                                                    <div style={{ fontSize: 'clamp(15px, 4vw, 18px)', fontWeight: 900, color: 'white' }}>{t.kf_report_title}</div>
                                                    <div style={{ fontSize: 10, color: 'rgba(255,255,255,0.7)', fontWeight: 600 }}>{t.kf_report_sync}</div>
                                                </div>
                                            </div>
                                            <div onClick={() => setSelectedKnowledge(null)} style={{ cursor: 'pointer', background: 'rgba(0,0,0,0.2)', padding: 10, borderRadius: '50%', color: 'white' }}><Icon name="x" size={20} /></div>
                                        </div>

                                        <div style={{ padding: 'clamp(16px, 5vw, 30px)' }}>
                                            {/* Question Section */}
                                            <div style={{ marginBottom: 24 }}>
                                                <div style={{ fontSize: 11, fontWeight: 800, color: 'var(--primary)', marginBottom: 10, textTransform: 'uppercase', letterSpacing: 1.5, display: 'flex', justifyContent: 'space-between' }}>
                                                    <span>{t.kf_problem_summary}</span>
                                                    <span style={{ color: '#10B981' }}>Live Analysis: {new Date().toLocaleTimeString()}</span>
                                                </div>
                                                <div style={{ fontSize: 16, fontWeight: 700, color: 'white', lineHeight: 1.5, background: 'rgba(99, 102, 241, 0.05)', padding: 16, borderRadius: 16, borderLeft: '4px solid var(--primary)' }}>
                                                    "{selectedKnowledge.question}"
                                                </div>
                                            </div>

                                            {/* AI Crawling Section */}
                                            <div style={{
                                                marginBottom: 24,
                                                display: 'grid',
                                                gridTemplateColumns: 'repeat(auto-fit, minmax(min(100%, 250px), 1fr))',
                                                gap: 16
                                            }}>
                                                <div className="card" style={{ background: 'rgba(16, 185, 129, 0.05)', padding: 'clamp(12px, 3vw, 16px)', borderRadius: 20, border: '1px solid rgba(16, 185, 129, 0.1)', margin: 0 }}>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, color: '#10B981', marginBottom: 10 }}>
                                                        <Icon name="activity" size={16} />
                                                        <div style={{ fontSize: 11, fontWeight: 800 }}>{t.kf_ai_engine}</div>
                                                    </div>
                                                    <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.7)', lineHeight: 1.6, marginBottom: 12 }}>{selectedKnowledge.aiCrawling}</div>
                                                    <button
                                                        onClick={() => alert(t.kf_resource_ai)}
                                                        style={{ background: 'rgba(16, 185, 129, 0.1)', border: 'none', borderRadius: 8, color: '#10B981', fontSize: 10, fontWeight: 700, padding: '6px 10px', cursor: 'pointer' }}>
                                                        {t.kf_btn_resource}
                                                    </button>
                                                </div>
                                                <div className="card" style={{ background: 'rgba(66, 133, 244, 0.05)', padding: 'clamp(12px, 3vw, 16px)', borderRadius: 20, border: '1px solid rgba(66, 133, 244, 0.1)', margin: 0 }}>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, color: '#4285F4', marginBottom: 10 }}>
                                                        <Icon name="search" size={16} />
                                                        <div style={{ fontSize: 11, fontWeight: 800 }}>{t.kf_google_insight}</div>
                                                    </div>
                                                    <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.7)', lineHeight: 1.6, whiteSpace: 'pre-line', marginBottom: 12 }}>{selectedKnowledge.googleInsight}</div>
                                                    <button
                                                        onClick={() => window.open(`https://www.google.com/search?q=${encodeURIComponent(selectedKnowledge.title)}`, '_blank')}
                                                        style={{ background: 'rgba(66, 133, 244, 0.1)', border: 'none', borderRadius: 8, color: '#4285F4', fontSize: 10, fontWeight: 700, padding: '6px 10px', cursor: 'pointer' }}>
                                                        {t.kf_btn_google}
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Detailed Analysis Section */}
                                            <div style={{ background: 'rgba(255,255,255,0.03)', padding: 'clamp(16px, 4vw, 24px)', borderRadius: 24, border: '1px solid var(--border)' }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 16 }}>
                                                    <Icon name="clipboard-check" color="var(--primary)" size={18} />
                                                    <div style={{ fontSize: 13, fontWeight: 800, color: 'white' }}>{t.kf_solution_title}</div>
                                                </div>
                                                <div style={{ fontSize: 14, color: 'rgba(255,255,255,0.8)', lineHeight: 1.8, whiteSpace: 'pre-line' }}>
                                                    {selectedKnowledge.analysis}
                                                </div>
                                            </div>

                                            <div style={{ display: 'flex', gap: 12, marginTop: 30 }}>
                                                <button
                                                    onClick={() => {
                                                        navigator.clipboard.writeText(selectedKnowledge.analysis);
                                                        alert(t.kf_copy_success);
                                                    }}
                                                    style={{
                                                        flex: 1, padding: '16px',
                                                        background: 'rgba(255,255,255,0.05)',
                                                        border: '1px solid var(--border)', borderRadius: 16, color: 'white',
                                                        fontWeight: 800, fontSize: 14, cursor: 'pointer',
                                                        display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8
                                                    }}>
                                                    <Icon name="copy" size={18} /> {t.kf_btn_copy}
                                                </button>
                                                <button
                                                    onClick={() => globalShare({ title: selectedKnowledge.title, text: selectedKnowledge.analysis })}
                                                    style={{
                                                        flex: 1, padding: '16px',
                                                        background: 'linear-gradient(135deg, var(--primary), var(--secondary))',
                                                        border: 'none', borderRadius: 16, color: 'white',
                                                        fontWeight: 800, fontSize: 14, cursor: 'pointer',
                                                        display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8,
                                                        boxShadow: '0 10px 25px rgba(99, 102, 241, 0.3)'
                                                    }}>
                                                    <Icon name="share-2" size={18} /> {t.kf_btn_share}
                                                </button>
                                            </div>
                                            <button
                                                onClick={() => setSelectedKnowledge(null)}
                                                style={{ width: '100%', padding: '12px', background: 'transparent', border: 'none', color: 'var(--text-gray)', fontSize: 13, fontWeight: 600, marginTop: 16, cursor: 'pointer' }}>
                                                {t.kf_btn_close}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )
                        }

                        <div className="fab" onClick={onCreateQuestion}>
                            <Icon name="plus" color="white" size={28} />
                        </div>
                    </div>
                </Background3D >
            );
        };

        const GroupDetailView = ({ group, currentUser, onClose, allMembers, onUpdateGroup, onToggleFriend, t, onTagClick }) => {
            const isAdmin = group.admins && group.admins.includes(currentUser);
            const [activeTab, setActiveTab] = useState('chat'); // chat, anggota, media
            const [msg, setMsg] = useState('');
            const [chatFile, setChatFile] = useState(null);
            const fileRef = useRef(null);
            const mediaInputRef = useRef(null);
            const [showAddMember, setShowAddMember] = useState(false);
            const [memberSearchTerm, setMemberSearchTerm] = useState('');
            const [showEmojiPicker, setShowEmojiPicker] = useState(false);
            const emojis = ['😊', '😂', '🔥', '👍', '🙌', '💻', '🚀', '⭐', '✅', '❌', '👀', '💡', '💯', '🙏', '⚡'];

            // Mock messages if empty
            const [messages, setMessages] = useState(group.messages || [
                { id: 1, user: 'System', text: `Grup "${group.name}" dibuat oleh ${group.createdBy}.`, time: 'System', type: 'system' }
            ]);

            const handleSend = () => {
                if (!msg.trim() && !chatFile) return;

                const processMsg = (attachment = null) => {
                    const newMsg = {
                        id: Date.now(),
                        user: currentUser,
                        text: msg,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        self: true,
                        attachment: attachment
                    };
                    const updatedMsgs = [...messages, newMsg];
                    setMessages(updatedMsgs);
                    onUpdateGroup({ ...group, messages: updatedMsgs });
                    setMsg('');
                    setChatFile(null);
                }

                if (chatFile) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        processMsg({ name: chatFile.name, data: reader.result, type: chatFile.type });
                    };
                    reader.readAsDataURL(chatFile);
                } else {
                    processMsg();
                }
            };

            const handleMediaTabUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onloadend = () => {
                    const newMsg = {
                        id: Date.now(),
                        user: currentUser,
                        text: `📦 Mengirim file: ${file.name}`,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        self: true,
                        attachment: { name: file.name, data: reader.result, type: file.type }
                    };
                    const updatedMsgs = [...messages, newMsg];
                    setMessages(updatedMsgs);
                    onUpdateGroup({ ...group, messages: updatedMsgs });
                    alert(`Media "${file.name}" berhasil diunggah!`);
                };
                reader.readAsDataURL(file);
                e.target.value = null;
            };

            const downloadFile = (data, name) => {
                const a = document.createElement('a');
                a.href = data;
                a.download = name;
                a.click();
            };

            const handleAddMember = (member) => {
                if (group.membersList?.some(m => m.id === member.id)) {
                    alert('User sudah ada di grup!');
                    return;
                }
                const updatedMembers = [...(group.membersList || []), { id: member.id, name: member.name, role: 'Member', joinedAt: new Date().toLocaleDateString() }];
                onUpdateGroup({
                    ...group,
                    members: updatedMembers.length + (group.membersList ? 0 : 1), // Adjust count logic if membersList was empty (migration)
                    membersList: updatedMembers
                });
                alert(`Berhasil menambahkan ${member.name}`);
                setShowAddMember(false);
            }

            const handleRemoveMember = (memberId) => {
                if (!confirm('Hapus anggota ini?')) return;
                const updatedMembers = (group.membersList || []).filter(m => m.id !== memberId);
                onUpdateGroup({
                    ...group,
                    members: updatedMembers.length,
                    membersList: updatedMembers
                });
            }

            const handleAddFriend = (member) => {
                onToggleFriend(member);
            };

            const handleDeleteMessage = (msgId) => {
                if (!confirm('Hapus pesan ini?')) return;
                const updatedMsgs = messages.filter(m => m.id !== msgId);
                setMessages(updatedMsgs);
                onUpdateGroup({ ...group, messages: updatedMsgs });
            };
            const mediaList = messages.filter(m => m.attachment);

            return (
                <div style={{ height: '100%', background: '#0a0c10', display: 'flex', flexDirection: 'column' }}>
                    <div style={{ padding: 16, borderBottom: '1px solid var(--border)', display: 'flex', alignItems: 'center', gap: 12, background: 'var(--bg-card)' }}>
                        <div onClick={onClose} style={{ cursor: 'pointer' }}><Icon name="arrow-left" size={20} /></div>
                        <img src={group.image} style={{ width: 40, height: 40, borderRadius: 10 }} />
                        <div style={{ flex: 1 }}>
                            <div style={{ fontWeight: 700 }}>{group.name}</div>
                            <div style={{ fontSize: 11, color: 'var(--text-gray)' }}>{group.members} {t.member_tab_group} • {isAdmin ? (t.fd_admin_access || 'Anda Admin') : 'Member'}</div>
                        </div>
                    </div>
                    {/* Tabs */}
                    <div style={{ display: 'flex', padding: '0 16px', background: 'var(--bg-card)', borderBottom: '1px solid var(--border)' }}>
                        {['chat', 'anggota', 'media'].map(tab => (
                            <div key={tab}
                                onClick={() => setActiveTab(tab)}
                                style={{
                                    padding: '12px 16px',
                                    cursor: 'pointer',
                                    borderBottom: activeTab === tab ? '2px solid var(--primary)' : '2px solid transparent',
                                    color: activeTab === tab ? 'var(--primary)' : 'var(--text-gray)',
                                    fontWeight: activeTab === tab ? 600 : 500,
                                    textTransform: 'capitalize'
                                }}>
                                {tab}
                            </div>
                        ))}
                    </div>

                    {activeTab === 'anggota' ? (
                        <div style={{ padding: 20, flex: 1, position: 'relative', overflowY: 'auto' }}>
                            <div style={{ position: 'fixed', bottom: 30, left: 30, zIndex: 50 }}>
                                <button onClick={() => setShowAddMember(true)} style={{
                                    padding: '12px 24px',
                                    background: 'var(--primary)',
                                    color: 'white',
                                    borderRadius: 30,
                                    border: 'none',
                                    boxShadow: '0 4px 15px rgba(0,0,0,0.4)',
                                    display: 'flex', alignItems: 'center', gap: 10,
                                    fontWeight: 600,
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}
                                    onMouseOver={e => e.currentTarget.style.transform = 'scale(1.05)'}
                                    onMouseOut={e => e.currentTarget.style.transform = 'scale(1)'}
                                >
                                    <Icon name="user-plus" size={20} />
                                    <span>Tambah Anggota</span>
                                </button>
                            </div>
                            {isAdmin && (
                                <button onClick={() => setShowAddMember(true)} style={{
                                    padding: '14px', width: '100%', borderRadius: 12,
                                    background: 'linear-gradient(to right, var(--primary), var(--secondary))',
                                    border: 'none', color: 'white', fontWeight: 600, cursor: 'pointer', marginBottom: 24,
                                    display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8
                                }}>
                                    <Icon name="user-plus" size={18} /> Tambah Anggota
                                </button>
                            )}

                            <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                                <div style={{ marginBottom: 16 }}>
                                    <div style={{
                                        display: 'flex', alignItems: 'center', gap: 10,
                                        background: 'rgba(255,255,255,0.05)', padding: '10px 14px',
                                        borderRadius: 12, border: '1px solid rgba(255,255,255,0.1)'
                                    }}>
                                        <Icon name="search" size={16} color="var(--text-gray)" />
                                        <input
                                            placeholder="Cari anggota grup..."
                                            value={memberSearchTerm}
                                            onChange={e => setMemberSearchTerm(e.target.value)}
                                            style={{ background: 'transparent', border: 'none', color: 'white', flex: 1, outline: 'none', fontSize: 13 }}
                                        />
                                    </div>
                                </div>
                                <div style={{ fontSize: 12, fontWeight: 700, color: '#64748b', textTransform: 'uppercase', letterSpacing: 1 }}>Daftar Anggota ({group.membersList?.length || 1})</div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: 'rgba(255,255,255,0.03)', borderRadius: 12 }}>
                                    <div style={{ position: 'relative' }}>
                                        <div style={{ width: 40, height: 40, borderRadius: '50%', background: 'var(--primary)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white' }}>{currentUser.charAt(0)}</div>
                                        <div style={{ position: 'absolute', bottom: 0, right: 0, width: 12, height: 12, background: '#10B981', border: '2px solid #0a0c10', borderRadius: '50%' }} />
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ fontWeight: 600 }}>{currentUser} (Anda)</div>
                                        <div style={{ fontSize: 11, color: '#94a3b8' }}>{isAdmin ? 'Admin' : 'Member'}</div>
                                    </div>
                                </div>
                                {(group.membersList || []).filter(m => m.name.toLowerCase().includes(memberSearchTerm.toLowerCase())).map(m => (
                                    <div key={m.id} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: 'rgba(255,255,255,0.03)', borderRadius: 12 }}>
                                        <div style={{ position: 'relative' }}>
                                            <div style={{ width: 40, height: 40, borderRadius: '50%', background: '#334155', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white' }}>{m.name.charAt(0)}</div>
                                            <div style={{ position: 'absolute', bottom: 0, right: 0, width: 12, height: 12, background: '#10B981', border: '2px solid #0a0c10', borderRadius: '50%' }} />
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ fontWeight: 600 }}>{m.name}</div>
                                            <div style={{ fontSize: 11, color: '#94a3b8' }}>{m.role}</div>
                                        </div>
                                        <div style={{ display: 'flex', gap: 8 }}>
                                            {m.name !== currentUser && (
                                                <button onClick={() => handleAddFriend(m)} style={{ padding: '8px', background: 'rgba(16, 185, 129, 0.2)', color: '#10B981', border: 'none', borderRadius: 8, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }} title="Tambah Teman">
                                                    <Icon name="user-plus" size={16} />
                                                </button>
                                            )}
                                            {isAdmin && m.name !== currentUser && (
                                                <button onClick={() => handleRemoveMember(m.id)} style={{
                                                    padding: '8px',
                                                    background: 'rgba(239, 68, 68, 0.15)',
                                                    color: '#ef4444',
                                                    border: 'none',
                                                    borderRadius: 8,
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center'
                                                }} title="Hapus dari Grup">
                                                    <Icon name="trash-2" size={16} />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ) : activeTab === 'media' ? (
                        <div style={{ padding: 20 }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
                                <div style={{ fontSize: 12, fontWeight: 700, color: '#64748b', textTransform: 'uppercase', letterSpacing: 0.5 }}>Media ({mediaList.length})</div>
                                <button onClick={() => mediaInputRef.current.click()} style={{
                                    padding: '8px 16px', borderRadius: 10, background: 'rgba(99, 102, 241, 0.15)', border: '1px solid var(--primary)',
                                    color: 'var(--primary)', fontSize: 12, fontWeight: 700, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 6
                                }}>
                                    <Icon name="plus" size={16} /> Tambah Media
                                </button>
                                <input type="file" ref={mediaInputRef} style={{ display: 'none' }} onChange={handleMediaTabUpload} />
                            </div>
                            {mediaList.length === 0 ? <div style={{ textAlign: 'center', padding: 40, color: '#64748b', background: 'rgba(255,255,255,0.02)', borderRadius: 16, border: '1px dashed rgba(255,255,255,0.1)' }}>Belum ada file.</div> : (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(100px, 1fr))', gap: 12 }}>
                                    {mediaList.map((m, idx) => {
                                        const isImage = m.attachment.type && m.attachment.type.startsWith('image/');
                                        return (
                                            <div key={idx} onClick={() => downloadFile(m.attachment.data, m.attachment.name)} style={{
                                                aspectRatio: '1/1',
                                                background: 'rgba(255,255,255,0.05)',
                                                borderRadius: 16,
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                cursor: 'pointer',
                                                flexDirection: 'column',
                                                gap: 8,
                                                overflow: 'hidden',
                                                border: '1px solid rgba(255,255,255,0.1)',
                                                position: 'relative'
                                            }}>
                                                {isImage ? (
                                                    <img src={m.attachment.data} style={{ width: '100%', height: '100%', objectFit: 'cover' }} alt={m.attachment.name} />
                                                ) : (
                                                    <Icon name="file" size={24} color="var(--primary)" />
                                                )}
                                                <div style={{
                                                    position: 'absolute', bottom: 0, left: 0, right: 0,
                                                    padding: '4px 8px', background: 'rgba(0,0,0,0.6)',
                                                    backdropFilter: 'blur(5px)', fontSize: 10,
                                                    whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'
                                                }}>
                                                    {m.attachment.name}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    ) : (
                        <>
                            <div className="hide-scrollbar" style={{ flex: 1, overflowY: 'auto', padding: 16, display: 'flex', flexDirection: 'column', gap: 12 }}>
                                {messages.map((m, idx) => (
                                    <div key={idx} style={{ alignSelf: m.type === 'system' ? 'center' : (m.self ? 'flex-end' : 'flex-start'), maxWidth: m.type === 'system' ? '100%' : '80%' }}>
                                        {m.type === 'system' ? (
                                            <div style={{ fontSize: 10, color: 'var(--text-gray)', padding: '4px 8px', background: 'rgba(255,255,255,0.05)', borderRadius: 10 }}>{m.text}</div>
                                        ) : (
                                            <div>
                                                <div style={{
                                                    background: m.self ? 'var(--primary)' : 'rgba(255,255,255,0.1)',
                                                    padding: '8px 12px', borderRadius: 12,
                                                    color: 'white', fontSize: 13
                                                }}>
                                                    {renderTextWithMentions(m.text, onTagClick)}
                                                    {m.attachment && (
                                                        <div onClick={() => downloadFile(m.attachment.data, m.attachment.name)} style={{ marginTop: 8, padding: 8, background: 'rgba(0,0,0,0.2)', borderRadius: 6, display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' }}>
                                                            <Icon name="file" size={16} />
                                                            <span style={{ fontSize: 12, textDecoration: 'underline' }}>{m.attachment.name}</span>
                                                        </div>
                                                    )}
                                                </div>
                                                <div style={{ fontSize: 9, color: 'var(--text-gray)', marginTop: 2, textAlign: m.self ? 'right' : 'left' }}>
                                                    {m.user} • {m.time}
                                                    {(isAdmin || m.self) && <span onClick={() => handleDeleteMessage(m.id)} style={{ marginLeft: 8, color: '#EF4444', cursor: 'pointer', fontWeight: 600 }}>Hapus</span>}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            <div style={{ position: 'relative' }}>
                                {showEmojiPicker && (
                                    <div style={{
                                        position: 'absolute', bottom: '100%', left: 12, marginBottom: 12,
                                        background: 'rgba(15, 23, 42, 0.95)', backdropFilter: 'blur(20px)',
                                        padding: 12, borderRadius: 16, border: '1px solid rgba(255,255,255,0.1)',
                                        display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 8,
                                        boxShadow: '0 10px 30px rgba(0,0,0,0.5)', zIndex: 100
                                    }}>
                                        {emojis.map(e => (
                                            <div key={e} onClick={() => { setMsg(msg + e); setShowEmojiPicker(false); }} style={{ fontSize: 20, cursor: 'pointer', padding: 4, textAlign: 'center' }}>{e}</div>
                                        ))}
                                    </div>
                                )}
                                <div style={{ padding: 12, background: 'rgba(30, 41, 59, 0.5)', backdropFilter: 'blur(20px)', borderTop: '1px solid rgba(255,255,255,0.1)', display: 'flex', gap: 10, alignItems: 'center', position: 'sticky', bottom: 0 }}>
                                    <div onClick={() => setShowEmojiPicker(!showEmojiPicker)} style={{ padding: 8, cursor: 'pointer', color: showEmojiPicker ? 'var(--primary)' : 'var(--text-gray)' }}>
                                        <Icon name="smile" size={20} />
                                    </div>
                                    <input type="file" ref={fileRef} style={{ display: 'none' }} onChange={(e) => setChatFile(e.target.files[0])} />
                                    <div onClick={() => fileRef.current.click()} style={{ padding: 8, cursor: 'pointer', color: chatFile ? '#10B981' : 'var(--text-gray)' }}>
                                        <Icon name={chatFile ? "check-circle" : "paperclip"} size={20} />
                                    </div>
                                    <input
                                        value={msg}
                                        onChange={e => setMsg(e.target.value)}
                                        onKeyDown={e => e.key === 'Enter' && handleSend()}
                                        placeholder={chatFile ? `File: ${chatFile.name}` : "Ketik pesan... (@user untuk tag)"}
                                        style={{ flex: 1, background: 'rgba(0,0,0,0.2)', border: 'none', padding: '10px 14px', borderRadius: 20, color: 'white', outline: 'none' }}
                                    />
                                    <div onClick={handleSend} style={{ padding: 8, background: 'var(--primary)', borderRadius: '50%', display: 'flex', cursor: 'pointer' }}>
                                        <Icon name="send" size={18} color="white" />
                                    </div>
                                </div>
                            </div>
                        </>
                    )}

                    {showAddMember && (
                        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', zIndex: 6000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 20 }}>
                            <div className="card" style={{ width: '100%', maxWidth: 350, maxHeight: '80vh', overflowY: 'auto' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 16 }}>
                                    <h3>Pilih Anggota</h3>
                                    <div onClick={() => setShowAddMember(false)} style={{ cursor: 'pointer' }}><Icon name="x" /></div>
                                </div>
                                {allMembers.filter(m => m.name !== currentUser && !group.membersList?.some(gm => gm.id === m.id)).map(m => (
                                    <div key={m.id} onClick={() => handleAddMember(m)} style={{ padding: 12, borderBottom: '1px solid var(--border)', cursor: 'pointer', display: 'flex', gap: 12, alignItems: 'center' }}>
                                        <img src={m.image} style={{ width: 32, height: 32, borderRadius: '50%' }} />
                                        <div>
                                            <div style={{ fontWeight: 600, fontSize: 13 }}>{m.name}</div>
                                            <div style={{ fontSize: 11, color: 'var(--text-gray)' }}>{m.role}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            )
        };

        // --- Anggota (Membership & Friends) Screen ---
        const Anggota = ({ isPrivateMode, registeredUsers = [], onNavigate, userName, friends = [], onUpdateFriends, t, onStartChat, onTagClick }) => {
            const safeRegisteredUsers = Array.isArray(registeredUsers) ? registeredUsers : [];
            const safeFriends = Array.isArray(friends) ? friends : [];

            const [searchTerm, setSearchTerm] = useState('');
            const [activeTab, setActiveTab] = useState('semua'); // semua, teman, grup
            const [selectedMember, setSelectedMember] = useState(null);
            const [openCreateGroup, setOpenCreateGroup] = useState(false);
            const [selectedGroup, setSelectedGroup] = useState(null); // Track selected group for detail view

            // Persistent Groups from Redis
            const [groups, setGroups] = useState(() => redis.get('groups_db', []));

            // Transform Registered Users to Member Format
            const [allMembers, setAllMembers] = useState(() => {
                const realMembers = safeRegisteredUsers.map(u => ({
                    id: u.id,
                    name: u.name,
                    role: u.role || 'User Baru',
                    status: 'Online',
                    isFriend: safeFriends.includes(u.id),
                    email: u.email || 'user@local.com',
                    items: u.items || 1, // Persist items if possible, else 1
                    image: `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name)}&background=random`,
                    isPrivate: false,
                    weeklyStats: Array.from({ length: 7 }, () => Math.floor(Math.random() * 10))
                }));

                let combined = [...realMembers];

                // Add specific demo members ONLY if they don't exist by name (simple de-dupe)
                DEMO_MEMBERS.forEach(dm => {
                    if (!combined.some(c => c.name === dm.name)) {
                        combined.push({
                            ...dm,
                            items: Math.floor(Math.random() * 30),
                            isPrivate: false,
                            weeklyStats: Array.from({ length: 7 }, () => Math.floor(Math.random() * 15))
                        });
                    }
                });

                return combined.map(m => ({ ...m, isFriend: safeFriends.includes(m.id) })).sort((a, b) => b.items - a.items);
            });

            // Sync members friendship status when friends prop updates
            useEffect(() => {
                setAllMembers(prev => prev.map(m => ({
                    ...m,
                    isFriend: safeFriends.includes(m.id)
                })));
            }, [safeFriends]);




            const filteredMembers = allMembers.filter(m => {
                const matchesSearch = m.name.toLowerCase().includes(searchTerm.toLowerCase()) || m.role.toLowerCase().includes(searchTerm.toLowerCase());
                if (activeTab === 'teman') return matchesSearch && m.isFriend;
                return matchesSearch;
            });

            // Action Handlers
            const handleAddFriend = (member) => {
                const isFriend = (friends || []).includes(member.id);
                if (!isFriend) {
                    onUpdateFriends([...(friends || []), member.id]);
                }
                alert(`Anda berteman dengan ${member.name}!`);
            };

            const handleRemoveUser = (member) => {
                if (confirm(t.member_confirm_delete.replace('{name}', member.name) || `Hapus ${member.name} dari daftar anggota?`)) {
                    setAllMembers(prev => prev.filter(m => m.id !== member.id));
                    // Also remove from friends if exists
                    const newFriends = safeFriends.filter(id => id !== member.id);
                    if (newFriends.length !== safeFriends.length) {
                        onUpdateFriends(newFriends);
                    }
                    setSelectedMember(null);
                }
            };

            const toggleFriendStatus = (member) => {
                const isFriend = (friends || []).includes(member.id);
                const newFriends = isFriend ? friends.filter(id => id !== member.id) : [...(friends || []), member.id];
                onUpdateFriends(newFriends);
                alert(!isFriend ? `Ditambahkan ke teman: ${member.name}` : `Dihapus dari teman: ${member.name}`);
                if (selectedMember && selectedMember.id === member.id) {
                    setSelectedMember(prev => ({ ...prev, isFriend: !isFriend }));
                }
            };

            const handleCreateGroup = (e) => {
                e.preventDefault();
                const name = e.target.groupName.value;
                const desc = e.target.groupDesc.value;
                if (!name) return;

                const currentUser = userName || 'Anda';

                const newGroup = {
                    id: Date.now(),
                    name,
                    desc: desc || 'Grup diskusi baru',
                    members: 1, // You are the first member
                    image: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff`,
                    admins: [currentUser], // Grant full admin rights
                    createdBy: currentUser
                };

                const updatedGroups = [...groups, newGroup];
                setGroups(updatedGroups);
                redis.set('groups_db', updatedGroups); // Save to Redis

                setOpenCreateGroup(false);
                alert(t.member_group_success.replace('{name}', name));
            };

            return (
                <>
                    <Background3D color1="var(--primary)" color2="var(--secondary)">
                        <div className="animate">
                            <header className="page-header" style={{
                                padding: '24px 16px 0',
                                background: 'linear-gradient(to right, #6366f1, #ec4899)',
                                borderBottomLeftRadius: 0, borderBottomRightRadius: 0
                            }}>
                                <h1 style={{ fontSize: '20px', fontWeight: '800', color: 'white' }}>{t.member_title}</h1>
                                <p style={{ color: 'rgba(255,255,255,0.8)', fontSize: '11px', marginTop: 2 }}>{t.member_subtitle || 'Kelola koneksi dan grup kerja Anda.'}</p>

                                <div className="search-bar" style={{
                                    background: 'rgba(255,255,255,0.2)', border: 'none',
                                    marginTop: 18, padding: '10px 14px', borderRadius: 14
                                }}>
                                    <Icon name="search" color="rgba(255,255,255,0.7)" size={18} />
                                    <input
                                        type="text"
                                        placeholder={t.member_search_placeholder}
                                        style={{ color: 'white', fontSize: 13 }}
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>

                                {/* Menu Tabs */}
                                <div style={{ display: 'flex', gap: 24, marginTop: 20, overflowX: 'auto', paddingBottom: 4 }}>
                                    {[
                                        { id: 'semua', tKey: 'all' },
                                        { id: 'teman', tKey: 'friend' },
                                        { id: 'grup', tKey: 'group' },
                                        { id: 'kontribusi', tKey: 'contribution' }
                                    ].map(tab => {
                                        const label = t[`member_tab_${tab.tKey}`];
                                        const isActive = activeTab === tab.id;
                                        return (
                                            <div
                                                key={tab.id}
                                                onClick={() => setActiveTab(tab.id)}
                                                style={{
                                                    paddingBottom: 10,
                                                    cursor: 'pointer',
                                                    borderBottom: isActive ? '4px solid white' : '4px solid transparent',
                                                    fontWeight: 700,
                                                    color: isActive ? 'white' : 'rgba(255,255,255,0.6)',
                                                    textTransform: 'capitalize',
                                                    fontSize: 14,
                                                    letterSpacing: 0.5
                                                }}
                                            >
                                                {label}
                                            </div>
                                        );
                                    })}
                                </div>
                            </header>

                            <div style={{ padding: '24px' }}>
                                {activeTab === 'grup' && (
                                    <div>
                                        {/* Action Header for Groups */}
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                                            <h3 style={{ fontSize: 16 }}>{t.member_heading_my_groups} ({groups.length})</h3>
                                            <button
                                                onClick={() => setOpenCreateGroup(true)}
                                                style={{ padding: '8px 16px', background: 'var(--primary)', border: 'none', borderRadius: 8, color: 'white', fontWeight: 600, fontSize: 12, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 6 }}
                                            >
                                                <Icon name="plus" size={14} /> {t.member_group_create}
                                            </button>
                                        </div>

                                        {groups.length === 0 ? (
                                            <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-gray)' }}>
                                                <Icon name="users" size={48} style={{ opacity: 0.5, marginBottom: 16 }} />
                                                <h3>Belum Ada Grup</h3>
                                                <p style={{ fontSize: 13, maxWidth: 250, margin: '8px auto' }}>Buat grup baru untuk berkolaborasi dengan tim Anda.</p>
                                                <button
                                                    onClick={() => setOpenCreateGroup(true)}
                                                    style={{ marginTop: 16, padding: '10px 20px', background: 'var(--primary)', border: 'none', borderRadius: 10, color: 'white', fontWeight: 700, cursor: 'pointer' }}
                                                >
                                                    + Buat Grup
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="grid-responsive">
                                                {groups.map(g => (
                                                    <div key={g.id} className="card" style={{ padding: 16, display: 'flex', flexDirection: 'column', gap: 12 }}>
                                                        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                                            <img src={g.image} style={{ width: 48, height: 48, borderRadius: 12, objectFit: 'cover' }} />
                                                            <div>
                                                                <div style={{ fontWeight: 700, fontSize: 15 }}>{g.name}</div>
                                                                <div style={{ fontSize: 11, color: 'var(--text-gray)' }}>
                                                                    {g.members} {t.member_tab_group}
                                                                    {(g.admins && g.admins.includes(userName || 'Anda')) && <span style={{ color: '#10B981', marginLeft: 6, fontWeight: 700 }}>• 👑 {t.fd_admin_access || 'Admin Akses Penuh'}</span>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div style={{ fontSize: 12, color: 'var(--text-gray)', borderTop: '1px solid rgba(255,255,255,0.1)', paddingTop: 8 }}>
                                                            {g.desc}
                                                        </div>
                                                        <button
                                                            onClick={() => setSelectedGroup(g)}
                                                            style={{ width: '100%', padding: '8px', background: 'rgba(255,255,255,0.05)', border: 'none', borderRadius: 8, color: 'white', fontSize: 12, fontWeight: 600, cursor: 'pointer' }}>
                                                            {t.member_btn_view_group}
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}



                                {(activeTab === 'semua' || activeTab === 'teman') && (
                                    <>
                                        {activeTab === 'semua' && (
                                            <>
                                                <h3 style={{ fontSize: 16, marginBottom: 16 }}>{t.member_heading_suggestion}</h3>
                                                <div className="horizontal-scroll" style={{ paddingBottom: 16, marginBottom: 8 }}>
                                                    {allMembers.filter(m => m.status === 'Baru Bergabung' || m.role === 'User Baru').map(m => (
                                                        <div key={m.id} className="card" onClick={() => setSelectedMember(m)} style={{ minWidth: 140, textAlign: 'center', padding: 16, margin: 0, cursor: 'pointer' }}>
                                                            <div style={{ width: 60, height: 60, borderRadius: '50%', margin: '0 auto 12px', border: '2px solid var(--primary)', padding: 2 }}>
                                                                <img src={m.isPrivate ? 'https://www.w3schools.com/howto/img_avatar.png' : m.image} style={{ width: '100%', height: '100%', borderRadius: '50%', objectFit: 'cover', filter: m.isPrivate ? 'grayscale(1) blur(2px)' : 'none' }} />
                                                            </div>
                                                            <div style={{ fontWeight: 700, fontSize: 13, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                                                                {m.isPrivate ? 'Anggota Privat' : m.name}
                                                            </div>
                                                            <div style={{ fontSize: 10, color: 'var(--text-gray)', marginBottom: 12 }}>{m.role}</div>
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); handleAddFriend(m); }}
                                                                style={{ width: '100%', padding: '6px', background: 'var(--primary)', border: 'none', borderRadius: 8, color: 'white', fontSize: 11, fontWeight: 600 }}
                                                            >
                                                                {t.member_btn_add}
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </>
                                        )}

                                        <h3 style={{ fontSize: 16, marginBottom: 16, marginTop: 16 }}>{activeTab === 'teman' ? t.member_heading_my_friends : t.member_heading_all_members}</h3>
                                        <div className="grid-responsive" style={{ paddingTop: 8 }}>
                                            {filteredMembers.map(m => (
                                                <div key={m.id} className="card animate" onClick={() => setSelectedMember(m)} style={{
                                                    display: 'flex', alignItems: 'center', gap: 16, padding: '14px 18px',
                                                    cursor: 'pointer', background: 'rgba(255,255,255,0.03)',
                                                    border: '1px solid rgba(255,255,255,0.05)', borderRadius: 20
                                                }}>
                                                    <div style={{ position: 'relative', flexShrink: 0 }}>
                                                        <img src={m.isPrivate ? 'https://www.w3schools.com/howto/img_avatar.png' : m.image} style={{ width: 56, height: 56, borderRadius: '50%', objectFit: 'cover', border: '2px solid rgba(255,255,255,0.1)', filter: m.isPrivate ? 'grayscale(1) blur(1px)' : 'none' }} />
                                                        <div style={{
                                                            position: 'absolute', bottom: 2, right: 2, width: 14, height: 14, borderRadius: '50%',
                                                            background: m.status === 'Online' ? '#10B981' : (m.status === 'Baru Bergabung' ? '#3B82F6' : '#8B949E'),
                                                            border: '3px solid #161b22'
                                                        }}></div>
                                                    </div>
                                                    <div style={{ flex: 1, minWidth: 0 }}>
                                                        <div style={{ fontWeight: 800, fontSize: 16, color: 'white', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{m.isPrivate ? 'Anggota Privat' : m.name}</div>
                                                        <div style={{ fontSize: 12, color: '#8b949e', fontWeight: 500 }}>{m.role}</div>
                                                    </div>
                                                    {/* Action Button Small */}
                                                    <div style={{ display: 'flex', gap: 6 }} onClick={e => e.stopPropagation()}>
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); toggleFriendStatus(m); }}
                                                            style={{
                                                                padding: '10px', background: m.isFriend ? 'rgba(255,255,255,0.05)' : 'rgba(99, 102, 241, 0.15)',
                                                                border: 'none', borderRadius: 12,
                                                                color: m.isFriend ? '#8b949e' : 'var(--primary)', cursor: 'pointer'
                                                            }}
                                                            title={m.isFriend ? "Hapus Pertemanan" : "Tambah Teman"}
                                                        >
                                                            <Icon name={m.isFriend ? "user-minus" : "user-plus"} size={18} />
                                                        </button>
                                                        {(userName === 'Muhammad Ramadhan' || userName === 'Admin' || m.role === 'User Baru') && (
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); handleRemoveUser(m); }}
                                                                style={{
                                                                    padding: '10px', background: 'rgba(239, 68, 68, 0.1)',
                                                                    border: 'none', borderRadius: 12,
                                                                    color: '#EF4444', cursor: 'pointer'
                                                                }}
                                                                title="Hapus Anggota"
                                                            >
                                                                <Icon name="trash-2" size={18} />
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                            {filteredMembers.length === 0 && <div style={{ color: 'var(--text-gray)', padding: 20, textAlign: 'center', width: '100%' }}>{t.member_no_found}</div>}
                                        </div>
                                    </>
                                )}

                                {activeTab === 'kontribusi' && (
                                    <div>
                                        <div style={{ textAlign: 'center', marginBottom: 30 }}>
                                            <h2 style={{ fontSize: 18, marginBottom: 8 }}>{t.member_heading_leaderboard}</h2>
                                            <p style={{ color: 'var(--text-gray)', fontSize: 13 }}>{t.member_desc_leaderboard}</p>
                                        </div>

                                        {/* Top 3 Podium */}
                                        <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'flex-end', gap: 16, marginBottom: 40, height: 180 }}>
                                            {/* 2nd Place */}
                                            <div style={{ textAlign: 'center', width: 80 }}>
                                                <div style={{ width: 50, height: 50, borderRadius: '50%', border: '3px solid #C0C0C0', margin: '0 auto 8px', overflow: 'hidden' }}>
                                                    <img src={allMembers[2]?.image} style={{ width: '100%', height: '100%' }} />
                                                </div>
                                                <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 4 }}>{allMembers[2]?.name?.split(' ')[0] || 'Member'}</div>
                                                <div style={{ height: 80, background: 'linear-gradient(to top, #C0C0C0, rgba(192,192,192,0.2))', borderRadius: '8px 8px 0 0', display: 'flex', alignItems: 'flex-end', justifyContent: 'center', paddingBottom: 8 }}>
                                                    <span style={{ fontSize: 20, fontWeight: 800 }}>2</span>
                                                </div>
                                                <div style={{ fontSize: 11, color: '#C0C0C0', marginTop: 4, fontWeight: 600 }}>{allMembers[2] ? allMembers[2].items * 15 : 0} {t.profile_stat_points}</div>
                                            </div>

                                            {/* 1st Place */}
                                            <div style={{ textAlign: 'center', width: 90 }}>
                                                <div style={{ position: 'relative', width: 60, height: 60, margin: '0 auto 8px' }}>
                                                    <div style={{ width: '100%', height: '100%', borderRadius: '50%', border: '3px solid #FFD700', overflow: 'hidden' }}>
                                                        <img src={allMembers[0]?.image} style={{ width: '100%', height: '100%' }} />
                                                    </div>
                                                    <div style={{ position: 'absolute', top: -10, left: '50%', transform: 'translateX(-50%)' }}>
                                                        <Icon name="award" size={24} color="#FFD700" fill="#FFD700" />
                                                    </div>
                                                </div>
                                                <div style={{ fontSize: 13, fontWeight: 800, marginBottom: 4, color: '#FFD700' }}>{allMembers[0]?.name?.split(' ')[0] || 'Member'}</div>
                                                <div style={{ height: 110, background: 'linear-gradient(to top, #FFD700, rgba(255,215,0,0.2))', borderRadius: '8px 8px 0 0', display: 'flex', alignItems: 'flex-end', justifyContent: 'center', paddingBottom: 8 }}>
                                                    <span style={{ fontSize: 24, fontWeight: 800 }}>1</span>
                                                </div>
                                                <div style={{ fontSize: 12, color: '#FFD700', marginTop: 4, fontWeight: 700 }}>{allMembers[0] ? allMembers[0].items * 20 : 0} {t.profile_stat_points}</div>
                                            </div>

                                            {/* 3rd Place */}
                                            <div style={{ textAlign: 'center', width: 80 }}>
                                                <div style={{ width: 50, height: 50, borderRadius: '50%', border: '3px solid #CD7F32', margin: '0 auto 8px', overflow: 'hidden' }}>
                                                    <img src={allMembers[4]?.image} style={{ width: '100%', height: '100%' }} />
                                                </div>
                                                <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 4 }}>{allMembers[4]?.name?.split(' ')[0] || 'Member'}</div>
                                                <div style={{ height: 60, background: 'linear-gradient(to top, #CD7F32, rgba(205,127,50,0.2))', borderRadius: '8px 8px 0 0', display: 'flex', alignItems: 'flex-end', justifyContent: 'center', paddingBottom: 8 }}>
                                                    <span style={{ fontSize: 20, fontWeight: 800 }}>3</span>
                                                </div>
                                                <div style={{ fontSize: 11, color: '#CD7F32', marginTop: 4, fontWeight: 600 }}>{allMembers[4] ? allMembers[4].items * 10 : 0} {t.profile_stat_points}</div>
                                            </div>
                                        </div>

                                        {/* Statistics Slide Bar (New Feature) */}
                                        <div style={{ marginBottom: 30 }}>
                                            <h3 style={{ fontSize: 14, marginBottom: 12, paddingLeft: 4 }}>{t.member_performance_weekly}</h3>
                                            <div className="horizontal-scroll" style={{ display: 'flex', gap: 12, paddingBottom: 8, overflowX: 'auto' }}>
                                                {/* Simulate Activity Bars for 7 Days */}
                                                {['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'].map((day, i) => {
                                                    const height = Math.floor(Math.random() * 60) + 20; // Random height 20-80
                                                    return (
                                                        <div key={day} style={{
                                                            minWidth: 60, height: 100, background: 'rgba(255,255,255,0.05)', borderRadius: 12,
                                                            display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'flex-end', padding: 8
                                                        }}>
                                                            <div style={{
                                                                width: 8, height: `${height}%`,
                                                                background: i === 6 ? 'var(--primary)' : 'rgba(255,255,255,0.2)',
                                                                borderRadius: 4, transition: 'height 0.5s'
                                                            }}></div>
                                                            <div style={{ fontSize: 10, marginTop: 8, color: 'var(--text-gray)' }}>{day.substring(0, 3)}</div>
                                                        </div>
                                                    );
                                                })}

                                                {/* Additional 'Total' Card in Slider */}
                                                <div style={{
                                                    minWidth: 100, height: 100, background: 'linear-gradient(135deg, var(--primary), var(--secondary))', borderRadius: 12,
                                                    display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', color: 'white'
                                                }}>
                                                    <div style={{ fontSize: 20, fontWeight: 800 }}>84%</div>
                                                    <div style={{ fontSize: 10, opacity: 0.8 }}>Partisipasi</div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Contribution List (Renamed & Moved Down) */}
                                        <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: 16, padding: 20 }}>
                                            <h3 style={{ fontSize: 14, marginBottom: 16, display: 'flex', justifyContent: 'space-between' }}>
                                                <span>{t.member_heading_all_members}</span>
                                                <span style={{ fontSize: 11, color: 'var(--text-gray)', fontWeight: 400 }}>{t.just_now}</span>
                                            </h3>

                                            {allMembers.slice(0, 6).map((m, idx) => {
                                                const score = m.items * (20 - idx * 2); // Dummy calculation logic based on items
                                                const maxScore = 500;
                                                const widthPercent = Math.min((score / maxScore) * 100, 100);

                                                // Assign medal icons for top 3 in list too
                                                let medalIcon = null;
                                                if (idx === 0) medalIcon = "🥇";
                                                else if (idx === 1) medalIcon = "🥈"; // Assuming simplified match to index for demo
                                                else if (idx === 2) medalIcon = "🥉";

                                                return (
                                                    <div key={m.id} style={{ marginBottom: 16 }}>
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6, fontSize: 13 }}>
                                                            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                                                <span style={{ fontSize: 14, width: 20, textAlign: 'center' }}>{medalIcon || (idx + 1)}</span>
                                                                <span style={{ fontWeight: idx < 3 ? 700 : 400 }}>{m.name}</span>
                                                            </div>
                                                            <span style={{ fontWeight: 700, color: 'var(--primary)' }}>{score}</span>
                                                        </div>
                                                        <div style={{ height: 8, background: 'rgba(255,255,255,0.1)', borderRadius: 4, overflow: 'hidden' }}>
                                                            <div style={{
                                                                height: '100%',
                                                                width: `${widthPercent}%`,
                                                                background: idx === 0 ? '#FFD700' : (idx === 1 ? '#C0C0C0' : (idx === 2 ? '#CD7F32' : 'var(--primary)')),
                                                                borderRadius: 4
                                                            }}></div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Profile Viewer Modal */}
                            {selectedMember && (
                                <div style={{
                                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                                    background: 'rgba(0,0,0,0.85)', zIndex: 5000,
                                    display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 20
                                }} onClick={() => setSelectedMember(null)}>
                                    <div className="animate" style={{
                                        width: '100%', maxWidth: 360, background: '#161b22',
                                        borderRadius: 28, border: '1px solid rgba(255,255,255,0.1)', overflow: 'hidden',
                                        position: 'relative', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.5)'
                                    }} onClick={e => e.stopPropagation()}>
                                        {/* Cover Image */}
                                        <div style={{ height: 100, background: 'linear-gradient(to right, #6366f1, #ec4899)' }}></div>

                                        {/* Profile Image */}
                                        <div style={{ textAlign: 'center', marginTop: -50 }}>
                                            <div style={{
                                                width: 100, height: 100, borderRadius: '50%', border: '5px solid #161b22',
                                                margin: '0 auto', overflow: 'hidden', background: '#21262d', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.3)'
                                            }}>
                                                <img src={selectedMember.isPrivate ? 'https://www.w3schools.com/howto/img_avatar.png' : selectedMember.image} style={{ width: '100%', height: '100%', objectFit: 'cover', filter: selectedMember.isPrivate ? 'grayscale(1) blur(2px)' : 'none' }} />
                                            </div>
                                        </div>

                                        <div style={{ padding: '20px 24px 30px', textAlign: 'center' }}>
                                            <h2 style={{ fontSize: 22, fontWeight: 800, color: 'white', marginBottom: 4 }}>{selectedMember.isPrivate ? (t.member_private_label || 'Anggota Privat') : selectedMember.name}</h2>
                                            <div style={{ color: '#8b949e', fontSize: 13, fontWeight: 500 }}>{selectedMember.role}</div>

                                            {!selectedMember.isPrivate && (
                                                <>
                                                    <div style={{ margin: '24px auto', display: 'flex', justifyContent: 'center', gap: 30 }}>
                                                        <div style={{ textAlign: 'center' }}>
                                                            <div style={{ fontWeight: 800, fontSize: 18, color: 'white' }}>{selectedMember.items || 0}</div>
                                                            <div style={{ fontSize: 10, color: '#8b949e', fontWeight: 600, letterSpacing: 0.5 }}>{t.member_stat_contribution}</div>
                                                        </div>
                                                        <div style={{ textAlign: 'center' }}>
                                                            <div style={{ fontWeight: 800, fontSize: 18, color: 'white' }}>4.8</div>
                                                            <div style={{ fontSize: 10, color: '#8b949e', fontWeight: 600, letterSpacing: 0.5 }}>{t.member_stat_rating}</div>
                                                        </div>
                                                        <div style={{ textAlign: 'center' }}>
                                                            <div style={{ fontWeight: 800, fontSize: 18, color: '#3fb950' }}>{selectedMember.status}</div>
                                                            <div style={{ fontSize: 10, color: '#8b949e', fontWeight: 600, letterSpacing: 0.5 }}>{t.member_stat_status}</div>
                                                        </div>
                                                    </div>

                                                    {/* Weekly Performance Chart */}
                                                    <div style={{ margin: '20px 0', padding: 20, background: 'rgba(255,255,255,0.03)', borderRadius: 20, border: '1px solid rgba(255,255,255,0.05)' }}>
                                                        <h4 style={{ fontSize: 12, fontWeight: 700, marginBottom: 16, color: '#8b949e', textAlign: 'left' }}>{t.member_performance_weekly}</h4>
                                                        <div style={{ display: 'flex', alignItems: 'flex-end', justifyContent: 'space-between', height: 80, gap: 10 }}>
                                                            {(selectedMember.weeklyStats || [2, 5, 3, 8, 4, 6, 9]).map((val, idx) => {
                                                                const heightPct = Math.min((val / 15) * 100, 100);
                                                                return (
                                                                    <div key={idx} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 12 }}>
                                                                        <div style={{
                                                                            width: '100%',
                                                                            height: `${Math.max(heightPct, 8)}px`,
                                                                            background: idx === 6 ? '#238636' : '#21262d',
                                                                            borderRadius: 4,
                                                                            transition: 'height 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                                                                            maxHeight: '100%'
                                                                        }}></div>
                                                                        <div style={{ fontSize: 9, color: '#484f58', fontWeight: 600 }}>{['S', 'S', 'R', 'K', 'J', 'S', 'M'][idx]}</div>
                                                                    </div>
                                                                )
                                                            })}
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            <div style={{ display: 'flex', flexDirection: 'column', gap: 14, marginTop: 28 }}>
                                                <button
                                                    onClick={() => toggleFriendStatus(selectedMember)}
                                                    style={{
                                                        padding: '14px', background: 'transparent',
                                                        border: '1px solid #30363d', borderRadius: 14,
                                                        color: 'white', fontWeight: 700, fontSize: 15, cursor: 'pointer',
                                                        transition: 'background 0.2s'
                                                    }}
                                                    onMouseOver={e => e.currentTarget.style.background = 'rgba(255,255,255,0.05)'}
                                                    onMouseOut={e => e.currentTarget.style.background = 'transparent'}
                                                >
                                                    {selectedMember.isFriend ? t.member_btn_remove_friend : t.member_btn_add_friend}
                                                </button>
                                                <div style={{ display: 'flex', gap: 12 }}>
                                                    <button onClick={() => { if (onStartChat) onStartChat(selectedMember); if (onNavigate) onNavigate('pesan'); setSelectedMember(null); }} style={{ flex: 1, padding: '14px', background: '#21262d', border: 'none', borderRadius: 14, color: 'white', fontSize: 14, fontWeight: 700, cursor: 'pointer' }}>{t.member_btn_chat}</button>
                                                    <button onClick={() => { handleRemoveUser(selectedMember); setSelectedMember(null); }} style={{ flex: 1, padding: '14px', background: 'rgba(248, 81, 73, 0.1)', border: 'none', borderRadius: 14, color: '#f85149', fontSize: 14, fontWeight: 700, cursor: 'pointer' }}>{t.member_btn_delete_user}</button>
                                                </div>
                                            </div>
                                        </div>

                                        <div onClick={() => setSelectedMember(null)} style={{ position: 'absolute', top: 14, right: 14, padding: 8, color: 'white', cursor: 'pointer', opacity: 0.7 }}>
                                            <Icon name="x" size={24} />
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Create Group Modal */}
                            {openCreateGroup && (
                                <div style={{
                                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                                    background: 'rgba(0,0,0,0.8)', zIndex: 5000,
                                    display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 20
                                }} onClick={() => setOpenCreateGroup(false)}>
                                    <div className="animate" style={{
                                        width: '100%', maxWidth: 360, background: 'var(--bg-card)',
                                        borderRadius: 20, padding: 24, border: '1px solid var(--primary)',
                                        position: 'relative'
                                    }} onClick={e => e.stopPropagation()}>
                                        <h2 style={{ fontSize: 18, marginBottom: 16, textAlign: 'center' }}>{t.member_group_new_title}</h2>
                                        <form onSubmit={handleCreateGroup} style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                                            <div>
                                                <label style={{ fontSize: 12, fontWeight: 600, marginBottom: 8, display: 'block' }}>{t.member_group_label_name}</label>
                                                <input name="groupName" type="text" placeholder="Contoh: Komunitas ReactJS" style={{ width: '100%', padding: 12, borderRadius: 10, border: '1px solid var(--border)', background: 'rgba(255,255,255,0.05)', color: 'white' }} required />
                                            </div>
                                            <div>
                                                <label style={{ fontSize: 12, fontWeight: 600, marginBottom: 8, display: 'block' }}>{t.member_group_label_desc}</label>
                                                <textarea name="groupDesc" rows="3" placeholder="Tujuan grup ini..." style={{ width: '100%', padding: 12, borderRadius: 10, border: '1px solid var(--border)', background: 'rgba(255,255,255,0.05)', color: 'white' }}></textarea>
                                            </div>
                                            <button type="submit" style={{ padding: 14, background: 'var(--primary)', border: 'none', borderRadius: 12, color: 'white', fontWeight: 700, fontSize: 14, marginTop: 8, cursor: 'pointer' }}>{t.member_group_btn_create}</button>
                                        </form>
                                        <div onClick={() => setOpenCreateGroup(false)} style={{ position: 'absolute', top: 12, right: 12, cursor: 'pointer', padding: 4 }}>
                                            <Icon name="x" size={20} color="var(--text-gray)" />
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div >
                    </Background3D >
                    {/* Group Detail View Overlay - Movable Overlay */}
                    {
                        selectedGroup && (
                            <div style={{
                                position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                                background: '#0a0c10', zIndex: 10000, overflow: 'hidden'
                            }}>
                                <GroupDetailView
                                    group={selectedGroup}
                                    currentUser={userName || 'Anda'}
                                    onClose={() => setSelectedGroup(null)}
                                    allMembers={allMembers}
                                    onUpdateGroup={(updatedGroup) => {
                                        const newGroups = groups.map(g => g.id === updatedGroup.id ? updatedGroup : g);
                                        setGroups(newGroups);
                                        redis.set('groups_db', newGroups);
                                        setSelectedGroup(updatedGroup);
                                    }}
                                    onToggleFriend={toggleFriendStatus}
                                    t={t}
                                    onTagClick={onTagClick}
                                />
                            </div>
                        )
                    }
                </>
            );
        };

        // --- REDIS DATABASE SIMULATION LAYER ---
        // Kelas ini mensimulasikan koneksi Database Redis menggunakan LocalStorage
        // Memungkinkan aplikasi berfungsi seolah memiliki backend DB saat berjalan di sisi klien.
        class RedisClient {
            constructor() {
                this.prefix = 'bb_redis_db:';
                this.connected = true;
                console.log('🔌 Redis Client Connected to 127.0.0.1:6379 (Simulation Mode)');
            }

            _k(key) { return this.prefix + key; }

            // GET key: Mengambil data JSON
            get(key, defaultValue = null) {
                try {
                    const val = localStorage.getItem(this._k(key));
                    // Jika data tidak ada di "Redis", cek apakah data lama (migrasi) ada
                    if (!val) {
                        const legacy = localStorage.getItem('bb_' + key);
                        if (legacy) {
                            this.set(key, JSON.parse(legacy)); // Migrasi otomatis
                            return JSON.parse(legacy);
                        }
                        return defaultValue;
                    }
                    return JSON.parse(val);
                } catch (e) {
                    console.error('Redis GET Error:', e);
                    return defaultValue;
                }
            }

            // SET key value: Menyimpan data
            set(key, value) {
                try {
                    localStorage.setItem(this._k(key), JSON.stringify(value));
                    return "OK";
                } catch (e) {
                    console.error('Redis SET Error:', e);
                    return "ERR";
                }
            }

            // DEL key: Hapus data
            del(key) {
                localStorage.removeItem(this._k(key));
                return 1;
            }

            // FLUSHDB: Bersihkan database
            flushdb() {
                Object.keys(localStorage).forEach(k => {
                    if (k.startsWith(this.prefix)) localStorage.removeItem(k);
                });
                return "OK";
            }
        }

        // Inisialisasi Database Redis Global
        const redis = new RedisClient();

        // --- DBeaver / Database Manager Component ---
        const DBManager = ({ onClose }) => {
            const [isLocked, setIsLocked] = useState(true); // Locked by default
            const [password, setPassword] = useState('');
            const [adminError, setAdminError] = useState('');

            const [keys, setKeys] = useState([]);
            const [selectedKey, setSelectedKey] = useState(null);
            const [editValue, setEditValue] = useState('');
            const [status, setStatus] = useState('Connected to Local Redis Simulation');
            const [showAdminPanel, setShowAdminPanel] = useState(false); // For adding new admins feature

            // --- SECURITY LOCK ---
            // In a real app, this would check against a secure backend or hash.
            // For simulation, we use a hardcoded 'admin123' or check a Redis key 'admin_secret'
            const handleUnlock = () => {
                const secret = redis.get('admin_secret', 'rama000102'); // Default password if not set
                if (password === secret) {
                    setIsLocked(false);
                    setAdminError('');
                    refreshKeys();
                } else {
                    setAdminError('Access Denied: Incorrect Admin Password');
                }
            };

            useEffect(() => {
                refreshKeys();
            }, []);

            const refreshKeys = () => {
                const allKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k.startsWith(redis.prefix)) {
                        allKeys.push(k.replace(redis.prefix, ''));
                    }
                }
                setKeys(allKeys);
            };

            const handleSelect = (k) => {
                setSelectedKey(k);
                const val = redis.get(k);
                setEditValue(JSON.stringify(val, null, 2));
            };

            const handleSave = () => {
                try {
                    const parsed = JSON.parse(editValue);
                    redis.set(selectedKey, parsed);
                    setStatus(`Saved key: ${selectedKey}`);
                    setTimeout(() => setStatus('Ready'), 2000);
                } catch (e) {
                    alert('Invalid JSON Format!');
                }
            };

            const handleDelete = () => {
                if (confirm(`Delete key ${selectedKey}?`)) {
                    redis.del(selectedKey);
                    setSelectedKey(null);
                    setEditValue('');
                    refreshKeys();
                }
            };

            const handleExport = () => {
                const dump = {};
                keys.forEach(k => {
                    dump[k] = redis.get(k);
                });
                const blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `redis_dump_${new Date().toISOString()}.json`;
                a.click();
            };

            if (isLocked) {
                return (
                    <div className="db-overlay" style={{ alignItems: 'center', justifyContent: 'center' }}>
                        <div className="animate" style={{
                            width: '100%', maxWidth: 360, background: '#1e1e1e', padding: 30, borderRadius: 16,
                            border: '1px solid #333', boxShadow: '0 20px 50px rgba(0,0,0,0.5)', textAlign: 'center'
                        }}>
                            <div style={{ fontSize: 40, marginBottom: 20 }}>🔒</div>
                            <h2 style={{ fontSize: 20, color: 'white', marginBottom: 10 }}>Database Locked</h2>
                            <p style={{ color: '#aaa', fontSize: 13, marginBottom: 24 }}>
                                Security Protocol Active. Only authorized root administrators can access the raw database layer.
                            </p>

                            <input
                                type="password"
                                placeholder="Enter Admin Password"
                                value={password}
                                onChange={e => setPassword(e.target.value)}
                                style={{
                                    width: '100%', padding: '12px', borderRadius: 8, border: '1px solid #333',
                                    background: '#2b2b2b', color: 'white', marginBottom: 12, outline: 'none'
                                }}
                            />
                            {adminError && <div style={{ color: '#ff6b6b', fontSize: 12, marginBottom: 12 }}>{adminError}</div>}

                            <div style={{ display: 'flex', gap: 10 }}>
                                <button onClick={onClose} style={{ flex: 1, padding: 12, background: 'transparent', border: '1px solid #333', color: '#aaa', borderRadius: 8, cursor: 'pointer' }}>Cancel</button>
                                <button onClick={handleUnlock} style={{ flex: 1, padding: 12, background: '#6366f1', border: 'none', color: 'white', borderRadius: 8, fontWeight: 'bold', cursor: 'pointer' }}>Unlock</button>
                            </div>
                            <div style={{ marginTop: 20, fontSize: 11, color: '#555' }}>Default Debug Pass: admin123</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="db-overlay">
                    {/* DBeaver-like Toolbar */}
                    <div style={{ height: 40, background: '#3c3f41', display: 'flex', alignItems: 'center', padding: '0 10px', borderBottom: '1px solid #111', gap: 10, flexShrink: 0 }}>
                        <div style={{ fontWeight: 'bold', color: '#fff', marginRight: 'auto' }}>🦫 DBeaver Lite <span style={{ fontSize: 10, opacity: 0.7 }}>(Secured)</span></div>
                        <button onClick={() => setShowAdminPanel(!showAdminPanel)} style={{ background: showAdminPanel ? '#4a4d50' : 'none', border: 'none', color: '#fff', cursor: 'pointer', padding: '6px 12px', borderRadius: 4, fontSize: 12 }}>
                            👤 Manage Admins
                        </button>
                        <button onClick={refreshKeys} style={{ background: 'none', border: 'none', color: '#fff', cursor: 'pointer', title: 'Refresh', padding: 8 }}>🔄</button>
                        <button onClick={handleExport} style={{ background: 'none', border: 'none', color: '#fff', cursor: 'pointer', title: 'Export', padding: 8 }}>⬇️</button>
                        <button onClick={onClose} style={{ background: '#d32f2f', color: 'white', border: 'none', padding: '4px 12px', borderRadius: 4, cursor: 'pointer' }}>Exit</button>
                    </div>

                    {showAdminPanel && (
                        <div style={{ padding: 16, background: '#252526', borderBottom: '1px solid #111' }}>
                            <h4 style={{ margin: '0 0 10px 0', color: '#fff' }}>Admin Access Management</h4>
                            <div style={{ display: 'flex', gap: 10, alignItems: 'center' }}>
                                <input type="text" placeholder="New Admin Secret..." style={{ padding: 6, background: '#1e1e1e', border: '1px solid #333', color: '#fff' }} id="newAdminSecretFn" />
                                <button onClick={() => {
                                    const val = document.getElementById('newAdminSecretFn').value;
                                    if (val) {
                                        redis.set('admin_secret', val);
                                        alert('New Admin Secret Set!');
                                        setShowAdminPanel(false);
                                    }
                                }} style={{ padding: '6px 12px', background: '#10B981', color: 'white', border: 'none', cursor: 'pointer' }}>Update Secret</button>
                            </div>
                            <div style={{ fontSize: 11, color: '#aaa', marginTop: 8 }}>Note: This will replace the master password for all admins.</div>
                        </div>
                    )}

                    <div className="db-layout">
                        {/* Sidebar Keys */}
                        <div className="db-sidebar">
                            <div style={{ padding: 8, background: '#3c3f41', fontWeight: 'bold', fontSize: 12 }}>Explorer</div>
                            <div style={{ flex: 1, overflowY: 'auto' }}>
                                {keys.map(k => (
                                    <div key={k} onClick={() => handleSelect(k)} style={{
                                        padding: '8px 10px', fontSize: 13, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 6,
                                        background: selectedKey === k ? '#0d293e' : 'transparent',
                                        color: selectedKey === k ? '#fff' : '#aaa',
                                        borderBottom: '1px solid #3a3a3a'
                                    }}>
                                        <span style={{ color: '#e67e22' }}>🔑</span> {k}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Editor Area */}
                        <div className="db-editor">
                            {selectedKey ? (
                                <>
                                    <div style={{ height: 36, background: '#313335', display: 'flex', alignItems: 'center', padding: '0 10px', gap: 10, borderBottom: '1px solid #111', flexShrink: 0 }}>
                                        <span style={{ fontWeight: 'bold', color: '#fff', fontSize: 12, overflow: 'hidden', whiteSpace: 'nowrap', textOverflow: 'ellipsis', maxWidth: 150 }}>{selectedKey}</span>
                                        <button onClick={handleSave} style={{ marginLeft: 'auto', padding: '4px 12px', background: '#2f6b55', border: 'none', color: 'white', cursor: 'pointer', fontSize: 12 }}>💾</button>
                                        <button onClick={handleDelete} style={{ padding: '4px 12px', background: '#8c2d2d', border: 'none', color: 'white', cursor: 'pointer', fontSize: 12 }}>🗑️</button>
                                    </div>
                                    <textarea
                                        value={editValue}
                                        onChange={e => setEditValue(e.target.value)}
                                        style={{
                                            flex: 1, width: '100%', background: '#1e1e1e', color: '#d4d4d4', border: 'none', padding: 10,
                                            fontFamily: 'Consolas, monospace', fontSize: 14, resize: 'none', outline: 'none'
                                        }}
                                        spellCheck="false"
                                    />
                                </>
                            ) : (
                                <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#555', padding: 20, textAlign: 'center' }}>
                                    Select a key to view
                                </div>
                            )}
                            <div style={{ height: 24, background: '#007acc', color: 'white', fontSize: 11, display: 'flex', alignItems: 'center', padding: '0 10px', flexShrink: 0 }}>
                                {status}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- RBAC SYSTEM (Role-Based Access Control) ---
        const ROLES = {
            ADMIN: 'Admin',
            STAFF: 'Staff',
            USER: 'User'
        };

        const PERMISSIONS = {
            [ROLES.ADMIN]: ['create_user', 'edit_user', 'delete_user', 'view_report', 'view_profile'],
            [ROLES.STAFF]: ['view_report', 'view_profile'],
            [ROLES.USER]: ['view_profile']
        };

        // Helper untuk cek permission
        const checkPermission = (role, action) => {
            const rolePermissions = PERMISSIONS[role] || [];
            if (role === ROLES.ADMIN) return true; // Super admin bypass
            return rolePermissions.includes(action);
        };

        // Global Categories Data (Shared)
        const CATEGORIES_DATA = [
            { name: 'Hardware', icon: <img src="ICON HDW.png" alt="Hardware" style={{ width: '100%', height: '100%', objectFit: 'contain', filter: 'drop-shadow(0 4px 6px rgba(0,0,0,0.2))' }} />, color: '#3B82F6' },
            { name: 'Software', icon: '💿', color: '#8B5CF6' },
            { name: 'Network', icon: '🌐', color: '#10B981' },
            { name: 'Security', icon: '🛡️', color: '#EF4444' },
            { name: 'Database', icon: '🗄️', color: '#F59E0B' },
            { name: 'Development', icon: '⚡', color: '#EC4899' },
            { name: 'Runtimes', icon: '🚀', color: '#F59E0B' },
            { name: 'Cloud', icon: '☁️', color: '#0EA5E9' }
        ];

        // --- User Manager Component (Admin Only) ---
        const UserManager = ({ onClose }) => {
            const [users, setUsers] = useState([]);

            useEffect(() => {
                refreshUsers();
            }, []);

            const refreshUsers = () => {
                const db = redis.get('users_db', []);
                setUsers(db);
            };

            const toggleRole = (u) => {
                const newRole = u.role === 'Admin' ? 'User' : 'Admin';
                if (u.email === 'ramaeror24@gmail.com' && newRole === 'User') {
                    alert('Tidak bisa menurunkan status Super Admin Utama!');
                    return;
                }
                const updated = users.map(user => user.id === u.id ? { ...user, role: newRole } : user);
                redis.set('users_db', updated);
                setUsers(updated);
            };

            const deleteUser = (u) => {
                if (u.email === 'ramaeror24@gmail.com') {
                    alert('Super Admin tidak bisa dihapus!');
                    return;
                }
                if (confirm(`Hapus user ${u.name} (${u.email})?`)) {
                    const updated = users.filter(user => user.id !== u.id);
                    redis.set('users_db', updated);
                    setUsers(updated);
                }
            };

            return (
                <div className="db-overlay" style={{ alignItems: 'center', justifyContent: 'center' }}>
                    <div className="animate" style={{ maxWidth: 600, width: '100%', background: '#1e1e1e', borderRadius: 16, overflow: 'hidden', display: 'flex', flexDirection: 'column', maxHeight: '80vh', border: '1px solid #333', boxShadow: '0 50px 100px rgba(0,0,0,0.5)' }}>
                        <div style={{ padding: 20, borderBottom: '1px solid #333', display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: '#252526' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                <Icon name="users" color="white" />
                                <h2 style={{ fontSize: 18, color: 'white', margin: 0 }}>Kelola Pengguna ({users.length})</h2>
                            </div>
                            <button onClick={onClose} style={{ background: 'transparent', border: 'none', color: '#aaa', cursor: 'pointer' }}><Icon name="x" /></button>
                        </div>
                        <div style={{ overflowY: 'auto', padding: 20, display: 'flex', flexDirection: 'column', gap: 12 }}>
                            <div style={{ background: 'rgba(99, 102, 241, 0.1)', padding: 12, borderRadius: 8, fontSize: 12, color: '#818cf8', display: 'flex', gap: 8, alignItems: 'center' }}>
                                <Icon name="info" size={16} />
                                <div>Gunakan panel ini untuk mempromosikan user menjadi Admin atau menghapus akun spam.</div>
                            </div>
                            {users.map(u => (
                                <div key={u.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: '#2b2b2b', padding: 16, borderRadius: 12, border: '1px solid #3a3a3a' }}>
                                    <div style={{ display: 'flex', gap: 12, alignItems: 'center' }}>
                                        <div style={{ width: 40, height: 40, borderRadius: '50%', background: 'linear-gradient(45deg, #3B82F6, #8B5CF6)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontWeight: 'bold' }}>
                                            {u.name.charAt(0)}
                                        </div>
                                        <div>
                                            <div style={{ fontWeight: 'bold', color: 'white' }}>{u.name} {u.email === 'ramaeror24@gmail.com' && '👑'}</div>
                                            <div style={{ fontSize: 12, color: '#aaa' }}>{u.email}</div>
                                            <div style={{ fontSize: 11, color: u.role === 'Admin' ? '#10B981' : '#3B82F6', marginTop: 4, fontWeight: 700 }}>{u.role.toUpperCase()}</div>
                                        </div>
                                    </div>
                                    <div style={{ display: 'flex', gap: 8 }}>
                                        <button onClick={() => toggleRole(u)} style={{ padding: '8px 12px', background: u.role === 'Admin' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(16, 185, 129, 0.1)', color: u.role === 'Admin' ? '#EF4444' : '#10B981', border: 'none', borderRadius: 8, cursor: 'pointer', fontSize: 11, fontWeight: 600 }}>
                                            {u.role === 'Admin' ? 'Turunkan User' : 'Jadikan Admin'}
                                        </button>
                                        <button onClick={() => deleteUser(u)} style={{ padding: 10, background: '#333', color: '#EF4444', border: 'none', borderRadius: 8, cursor: 'pointer' }}>
                                            <Icon name="trash-2" size={16} />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            // Always force splash screen on first load
            const [screen, setScreen] = useState('splash');
            const [onboardingStep, setOnboardingStep] = useState(0);

            // State Initialization via Redis Database
            const [tab, setTab] = useState(() => redis.get('tab', 'home'));
            const [appLang, setAppLang] = useState(() => redis.get('appLang', 'id'));
            const [theme, setTheme] = useState(() => redis.get('theme', 'dark'));
            const [timeZone, setTimeZone] = useState(() => redis.get('timeZone', 'WIB'));
            const [userName, setUserName] = useState(() => redis.get('userName', ''));
            const [userBio, setUserBio] = useState(() => redis.get('userBio', 'Senior System Admin'));
            const [userPhoto, setUserPhoto] = useState(() => redis.get('userPhoto', 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=200'));
            const [activityLog, setActivityLog] = useState(() => redis.get('activityLog', [
                { id: 1, action: 'Login ke sistem', timestamp: Date.now() - 60000 },
                { id: 2, action: 'Membuka menu Profil', timestamp: Date.now() - 300000 },
                { id: 3, action: 'Melihat notifikasi', timestamp: Date.now() - 3600000 }
            ]));
            const [userRole, setUserRole] = useState(() => redis.get('userRole', 'Admin')); // Default: Admin
            const [isPrivate, setIsPrivate] = useState(() => redis.get('isPrivate', false));
            const [userFriends, setUserFriends] = useState(() => redis.get('userFriends', []));
            const [selectedBidang, setSelectedBidang] = useState(null);
            const [chatTarget, setChatTarget] = useState(null); // State for starting new chat
            const [selectedProfile, setSelectedProfile] = useState(null); // Global profile viewer

            const t = getT(appLang);

            const handleTagClick = (name) => {
                if (!name) return;
                const searchName = name.toLowerCase();
                const found = allUsers.find(u => u.name.toLowerCase() === searchName) ||
                    DEMO_MEMBERS.find(m => m.name.toLowerCase() === searchName) ||
                    allUsers.find(u => u.name.toLowerCase().includes(searchName)) ||
                    DEMO_MEMBERS.find(m => m.name.toLowerCase().includes(searchName));

                if (found) {
                    setSelectedProfile({
                        ...found,
                        items: found.items || Math.floor(Math.random() * 20),
                        role: found.role || 'Member',
                        status: found.status || 'Active',
                        weeklyStats: found.weeklyStats || [2, 5, 3, 8, 4, 6, 9]
                    });
                }
            };

            // Pull To Refresh States
            const [ptrProgress, setPtrProgress] = useState(0);
            const [isPtrRefreshing, setIsPtrRefreshing] = useState(false);
            const ptrStartY = useRef(-1);

            const ptrHandleTouchStart = (e) => {
                const scrollable = document.querySelector('.page-container-3d') ||
                    document.querySelector('.app-content') ||
                    document.querySelector('.main-content') ||
                    document.body;

                if (scrollable && scrollable.scrollTop <= 0) {
                    ptrStartY.current = e.touches[0].pageY;
                } else {
                    ptrStartY.current = -1;
                }
            };

            const ptrHandleTouchMove = (e) => {
                if (ptrStartY.current === -1 || isPtrRefreshing) return;

                const currentY = e.touches[0].pageY;
                const diff = currentY - ptrStartY.current;

                if (diff > 0) {
                    const progress = Math.min(diff / 150, 1.2);
                    setPtrProgress(progress);
                    if (progress > 0 && e.cancelable) e.preventDefault();
                }
            };

            const ptrHandleTouchEnd = () => {
                if (isPtrRefreshing || ptrStartY.current === -1) {
                    ptrStartY.current = -1;
                    return;
                }

                if (ptrProgress >= 1) {
                    setIsPtrRefreshing(true);
                    setPtrProgress(1);
                    if ("vibrate" in navigator) navigator.vibrate(10);

                    setTimeout(() => {
                        setIsPtrRefreshing(false);
                        setPtrProgress(0);
                        addNotification({
                            title: 'Data Diperbarui',
                            desc: 'Konten aplikasi telah berhasil disinkronkan.',
                            type: 'info',
                            target: 'home'
                        });
                    }, 1500);
                } else {
                    setPtrProgress(0);
                }
                ptrStartY.current = -1;
            };

            // Load Knowledge Base & Category Data from Redis
            const [knowledge, setKnowledge] = useState(() => redis.get('knowledge', KNOWLEDGE_BASE));
            const [categoryData, setCategoryData] = useState(() => redis.get('categoryData', {}));
            const [notifications, setNotifications] = useState(() => redis.get('notifications', [
                { id: 1, title: 'Selamat Datang', desc: 'Sistem siap digunakan.', time: 'Baru saja', type: 'info', target: 'home', unread: false },
                { id: 2, title: 'Pesan Baru', desc: 'Budi Santoso membalas komentar Anda.', time: '10m lalu', type: 'message', target: 'pesan', unread: true },
                { id: 3, title: 'Level Up!', desc: 'Selamat! Anda naik ke Level 5 (Active Member).', time: '1j lalu', type: 'award', target: 'profil', unread: true },
                { id: 4, title: 'Maintenance Server', desc: 'Server akan maintenance pada pukul 00:00.', time: '3j lalu', type: 'info', target: 'home', unread: false },
                { id: 5, title: 'Diskusi Panas 🔥', desc: 'Topik "Hardware" sedang ramai dibahas user lain.', time: '5j lalu', type: 'message', target: 'bidang', targetId: 'Hardware', unread: false }
            ]));

            // Registered Users State
            const [allUsers, setAllUsers] = useState(() => redis.get('users_db', []));

            // Redis Persistence Effect (Auto-Save)
            useEffect(() => {
                redis.set('screen', screen);
                redis.set('tab', tab);
                redis.set('appLang', appLang);
                redis.set('theme', theme);
                redis.set('timeZone', timeZone);
                redis.set('userName', userName);
                redis.set('userBio', userBio);
                redis.set('userPhoto', userPhoto);
                redis.set('activityLog', activityLog);
                redis.set('userRole', userRole);
                redis.set('isPrivate', isPrivate);
                redis.set('userFriends', userFriends);
                redis.set('knowledge', knowledge);
                redis.set('categoryData', categoryData);
                redis.set('notifications', notifications);
            }, [screen, tab, appLang, theme, timeZone, userName, userBio, userPhoto, activityLog, userRole, isPrivate, userFriends, knowledge, categoryData, notifications]);

            // Browser History & Keyboard Navigation Handler
            const isInternalNav = useRef(false);

            useEffect(() => {
                if (!isInternalNav.current) {
                    window.history.pushState(
                        { tab, selectedBidang: selectedBidang ? selectedBidang.name : null },
                        '',
                        `#${tab}${selectedBidang ? '/' + encodeURIComponent(selectedBidang.name) : ''}`
                    );
                }
                isInternalNav.current = false;
            }, [tab, selectedBidang]);

            useEffect(() => {
                const handlePopState = (event) => {
                    if (event.state) {
                        isInternalNav.current = true;
                        setTab(event.state.tab || 'home');
                        if (event.state.selectedBidang === null) {
                            setSelectedBidang(null);
                        } else {
                            const found = CATEGORIES_DATA.find(c => c.name === event.state.selectedBidang);
                            if (found) setSelectedBidang(found);
                        }
                    }
                };

                const handleKeyDown = (e) => {
                    // Don't trigger if user is typing
                    if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;

                    const tabs = ['home', 'bidang', 'pesan', 'anggota', 'notif', 'profil'];
                    const currentIndex = tabs.indexOf(tab);

                    if (e.key === 'ArrowRight') {
                        const nextIndex = (currentIndex + 1) % tabs.length;
                        setTab(tabs[nextIndex]);
                        setSelectedBidang(null);
                    } else if (e.key === 'ArrowLeft') {
                        const prevIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                        setTab(tabs[prevIndex]);
                        setSelectedBidang(null);
                    }
                };

                window.addEventListener('popstate', handlePopState);
                window.addEventListener('keydown', handleKeyDown);
                return () => {
                    window.removeEventListener('popstate', handlePopState);
                    window.removeEventListener('keydown', handleKeyDown);
                };
            }, [tab, selectedBidang]);

            const addNotification = (notif) => {
                const newNotif = { ...notif, id: Date.now(), time: 'Baru saja', unread: true };
                setNotifications(prev => [newNotif, ...prev]);
            };

            const handleNotificationClick = (n) => {
                if (n.target === 'bidang') {
                    const targetBidang = CATEGORIES_DATA.find(c => c.name === n.targetId);
                    if (targetBidang) {
                        setSelectedBidang(targetBidang);
                        setTab('home'); // Pastikan tab home aktif karena BidangDetail di render di sana
                    }
                } else {
                    setTab(n.target || 'home');
                }
            };

            const handleAddKnowledge = (newItem) => {
                setKnowledge(prev => {
                    if (prev.find(k => k.id === newItem.id)) return prev;
                    return [newItem, ...prev];
                });
            };

            const handleUpdateCategoryData = (name, data) => {
                if (!name) return;
                setCategoryData(prev => ({
                    ...prev,
                    [name]: data
                }));
            };

            const getCategoryData = (name) => {
                if (!name) return { discussions: [], chatMessages: [], materials: [], members: [] };
                return categoryData[name] || {
                    members: DEMO_MEMBERS.map(m => ({ ...m, id: m.id, role: m.role, name: m.name, image: m.image })), // Initialize members with demo data
                    discussions: [
                        { user: "Rudi Tabuti", title: `Optimasi performa di ${name}`, tags: [name], comments: 5 },
                        { user: "Sari Roti", title: `Standard Operating Procedure (SOP) ${name}`, tags: ["Work", name], comments: 2 }
                    ],
                    chatMessages: [
                        { user: "Andi", text: "Izin bertanya pak, untuk implementasi terbaru baiknya pakai framework apa?", time: "10:05" },
                        { user: "Budi Santoso", text: "Untuk case Anda, saya sarankan menggunakan pendekatan modular.", time: "10:12" }
                    ],
                    materials: [
                        { id: 1, title: `Panduan Utama ${name}`, update: 'Jan 2026', type: 'PDF', discussions: 12, likes: 24, isLiked: false, url: '#' }
                    ]
                };
            };

            const getCategoryCount = (name) => {
                const data = getCategoryData(name);
                return data.discussions.length;
            };



            const handleOnboardingNext = () => {
                if (onboardingStep < 2) {
                    setOnboardingStep(onboardingStep + 1);
                } else {
                    setScreen('auth');
                }
            };

            const handleLogin = (authData) => {
                // Support legacy simple string call if any
                if (typeof authData === 'string') {
                    if (!authData) { alert('Mohon isi nama Anda'); return; }
                    setUserName(authData);
                    setScreen('main');
                    redis.set('userName', authData);
                    redis.set('screen', 'main');
                    return;
                }

                const { name, email, password, isRegister } = authData;

                // Fetch DB
                const users = redis.get('users_db', []);

                if (isRegister) {
                    if (users.find(u => u.email === email)) {
                        alert('Email sudah terdaftar! Silakan login.');
                        return;
                    }
                    const newUser = { id: Date.now(), name: name || 'User', email, password, role: 'User', joinedAt: new Date().toISOString() };
                    users.push(newUser);
                    redis.set('users_db', users);
                    setAllUsers(users); // Update state

                    alert('Registrasi Berhasil! Selamat datang, ' + newUser.name);
                    setUserName(newUser.name);
                    setUserRole('User'); // Default role
                    setScreen('main');

                    // Persist Session
                    redis.set('userName', newUser.name);
                    redis.set('userRole', 'User');
                    redis.set('screen', 'main');
                } else {
                    const user = users.find(u => u.email === email && u.password === password);
                    if (user) {
                        setUserName(user.name);
                        setUserRole(user.role || 'User');
                        setScreen('main');

                        redis.set('userName', user.name);
                        redis.set('userRole', user.role || 'User');
                        redis.set('screen', 'main');
                    } else {
                        // Backdoor Local Demo
                        if (email === 'admin' && password === 'admin') {
                            setUserName('Super Admin');
                            redis.set('userName', 'Super Admin');
                            setUserRole('Admin');
                            redis.set('userRole', 'Admin');
                            setScreen('main');
                            return;
                        }

                        // SUPER ADMIN BACKDOOR for requested email
                        if (email === 'ramaeror24@gmail.com') {
                            // Force login/register logic for this specific email
                            alert('Selamat datang, Super Admin Rama!');
                            const adminUser = {
                                id: 'super-admin-rama', name: 'Rama (Super Admin)', email, password, role: 'Admin',
                                joinedAt: new Date().toISOString()
                            };
                            // Ensure user exists in DB or update role
                            const existing = users.find(u => u.email === email);
                            if (!existing) {
                                users.push(adminUser);
                                redis.set('users_db', users);
                            } else if (existing.role !== 'Admin') {
                                existing.role = 'Admin';
                                redis.set('users_db', users);
                            }

                            setUserName(adminUser.name);
                            setUserRole('Admin');
                            setScreen('main');
                            redis.set('userName', adminUser.name);
                            redis.set('userRole', 'Admin');
                            redis.set('screen', 'main');
                            return;
                        }

                        // Precise Error Handling
                        const emailExists = users.some(u => u.email === email);
                        if (emailExists) {
                            alert('Password salah! Coba lagi.');
                        } else {
                            alert('Email belum terdaftar! Mohon pastikan email benar atau daftar akun baru.');
                        }
                    }
                }
            };

            const handleLogout = () => {
                if (confirm('Apakah Anda yakin ingin keluar?')) {
                    // Direct cleanup to prevent state race conditions
                    // Clear Session Data ONLY (Preserve users_db)
                    redis.del('userName');
                    redis.del('userRole');
                    redis.del('screen');

                    // Force reload to clear all React states
                    window.location.reload();
                }
            };

            // Splash Screen
            if (screen === 'splash') {
                return <Splash onFinish={() => setScreen('onboarding')} t={t} />;
            }

            // Onboarding Screen
            if (screen === 'onboarding') {
                return <Onboarding step={onboardingStep} onNext={handleOnboardingNext} t={t} />;
            }

            // Auth Screen
            if (screen === 'auth') {
                return <Auth onLogin={handleLogin} t={t} />;
            }

            // Main App
            return (
                <div style={{ display: 'flex', width: '100%' }}>
                    {/* DBeaver Overlay */}
                    {screen === 'db_manager' && <DBManager onClose={() => setScreen('main')} />}
                    {screen === 'user_manager' && <UserManager onClose={() => setScreen('main')} />}

                    {/* Desktop Sidebar */}
                    <div className="sidebar">
                        <div style={{ marginBottom: 40, padding: '0 12px', textAlign: 'center', position: 'relative' }}>
                            <div className="logo-container" style={{
                                width: 120,
                                height: 120,
                                margin: '0 auto',
                                borderRadius: '50%', // Make it circular/soft
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                background: 'radial-gradient(circle at center, rgba(255,215,0,0.15) 0%, transparent 70%)', // Inner gold glow
                                boxShadow: '0 0 30px rgba(255, 165, 0, 0.2)', // Outer glow
                                transition: 'transform 0.3s ease',
                                cursor: 'pointer'
                            }}
                                onMouseOver={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                onMouseOut={(e) => e.currentTarget.style.transform = 'scale(1)'}
                            >
                                <img src="WhatsApp Image 2026-02-01 at 20.04.56.jpeg" alt="MR Tech" style={{
                                    width: '100%',
                                    height: '100%',
                                    objectFit: 'contain',
                                    filter: 'drop-shadow(0 4px 8px rgba(0,0,0,0.4))',
                                    borderRadius: '50%'
                                }} />
                            </div>
                        </div>

                        <div className={`nav-item ${tab === 'home' ? 'active' : ''}`} data-menu="home" onClick={() => { setTab('home'); setSelectedBidang(null); }}>
                            <Icon name="home" />
                            <span>{t.tab_home}</span>
                        </div>
                        <div className={`nav-item ${tab === 'bidang' ? 'active' : ''}`} data-menu="bidang" onClick={() => setTab('bidang')}>
                            <Icon name="grid" />
                            <span>{t.tab_bidang}</span>
                        </div>
                        <div className={`nav-item ${tab === 'pesan' ? 'active' : ''}`} data-menu="pesan" onClick={() => setTab('pesan')}>
                            <Icon name="message-circle" />
                            <span>{t.tab_pesan}</span>
                        </div>
                        <div className={`nav-item ${tab === 'anggota' ? 'active' : ''}`} data-menu="anggota" onClick={() => setTab('anggota')}>
                            <Icon name="users" />
                            <span>{t.tab_anggota}</span>
                        </div>
                        <div className={`nav-item ${tab === 'notif' ? 'active' : ''}`} data-menu="notif" onClick={() => setTab('notif')} style={{ position: 'relative' }}>
                            <Icon name="bell" />
                            {notifications.some(n => n.unread) && <div style={{ position: 'absolute', top: 12, right: 20, width: 8, height: 8, background: '#EF4444', borderRadius: '50%', border: '1px solid var(--bg-card)' }}></div>}
                            <span>{t.tab_notif}</span>
                        </div>
                        <div className={`nav-item ${tab === 'profil' ? 'active' : ''}`} data-menu="profil" onClick={() => setTab('profil')}>
                            <Icon name="user" />
                            <span>{t.tab_profil}</span>
                        </div>
                    </div >

                    {/* Pull To Refresh UI */}
                    <div className="ptr-container" style={{
                        transform: `translateY(${ptrProgress * 80}px)`,
                        opacity: ptrProgress > 0.1 ? 1 : 0
                    }}>
                        <div className={`ptr-indicator ${ptrProgress > 0.2 ? 'visible' : ''} ${isPtrRefreshing ? 'ptr-spinning' : ''}`} style={{
                            transform: isPtrRefreshing ? 'none' : `rotate(${ptrProgress * 360}deg) scale(${Math.min(ptrProgress, 1)})`
                        }}>
                            <Icon name={isPtrRefreshing ? "loader-2" : "arrow-down"} size={20} />
                        </div>
                    </div>

                    {/* Main Mobile/Desktop Content Area - Optimized for Instant Switching (No Loading) */}
                    <div className="main-content"
                        onTouchStart={ptrHandleTouchStart}
                        onTouchMove={ptrHandleTouchMove}
                        onTouchEnd={ptrHandleTouchEnd}
                    >
                        {/* Home & Bidang Detail Layer */}
                        <div style={{ display: tab === 'home' ? 'block' : 'none' }}>
                            {
                                selectedBidang ? (
                                    <BidangDetail
                                        bidang={selectedBidang}
                                        onBack={() => setSelectedBidang(null)}
                                        currentUserName={userName}
                                        onAddKnowledge={handleAddKnowledge}
                                        categoryData={getCategoryData(selectedBidang.name)}
                                        onUpdateCategoryData={handleUpdateCategoryData}
                                        addNotification={addNotification}
                                        onTagClick={handleTagClick}
                                        registeredMembers={allUsers}
                                        t={t}
                                    />
                                ) : (
                                    <Home
                                        userName={userName}
                                        userRole={userRole}
                                        handleTagClick={handleTagClick}
                                        checkPermission={(action) => checkPermission(userRole, action)} // Pass checker
                                        onCreateQuestion={() => {
                                            if (checkPermission(userRole, 'create_user')) {
                                                alert('Access Granted: Membuka Form Create Question (Admin/Privileged).');
                                            } else {
                                                alert('Access Denied: Anda tidak memiliki izin untuk membuat pertanyaan global.');
                                            }
                                        }}
                                        onBidangClick={(bidang) => setSelectedBidang(bidang)}
                                        onNavigate={(target) => setTab(target)}
                                        onOpenDB={() => setScreen('db_manager')}
                                        onLogout={handleLogout}
                                        knowledgeBase={knowledge}
                                        getCategoryCount={getCategoryCount}
                                        categories={CATEGORIES_DATA}
                                        t={t}
                                    />
                                )}
                        </div>

                        {/* Bidang Layer */}
                        <div style={{ display: tab === 'bidang' ? 'block' : 'none' }}>
                            {
                                selectedBidang ? (
                                    <BidangDetail
                                        bidang={selectedBidang}
                                        onBack={() => setSelectedBidang(null)}
                                        currentUserName={userName}
                                        onAddKnowledge={handleAddKnowledge}
                                        categoryData={getCategoryData(selectedBidang.name)}
                                        onUpdateCategoryData={handleUpdateCategoryData}
                                        addNotification={addNotification}
                                        onTagClick={handleTagClick}
                                        registeredMembers={allUsers}
                                        t={t}
                                    />
                                ) : (
                                    <Bidang
                                        onBidangClick={(bidang) => setSelectedBidang(bidang)}
                                        getCategoryCount={getCategoryCount}
                                        t={t}
                                        categories={CATEGORIES_DATA}
                                    />
                                )}
                        </div>

                        {/* Pesan Layer */}
                        <div style={{ display: tab === 'pesan' ? 'block' : 'none' }}>
                            <Pesan
                                userName={userName}
                                t={t}
                                onNavigate={setTab}
                                newChatTarget={chatTarget}
                                onTagClick={handleTagClick}
                                onClearChatTarget={() => setChatTarget(null)}
                                registeredUsers={allUsers}
                                friends={userFriends}
                            />
                        </div>

                        {/* Anggota Layer */}
                        <div style={{ display: tab === 'anggota' ? 'block' : 'none' }}>
                            <Anggota
                                isPrivateMode={isPrivate}
                                registeredUsers={allUsers}
                                userName={userName}
                                t={t}
                                friends={userFriends}
                                onNavigate={setTab}
                                onUpdateFriends={setUserFriends}
                                onStartChat={(user) => { setChatTarget(user); setTab('pesan'); }}
                                onTagClick={handleTagClick}
                            />
                        </div>

                        {/* Notif Layer */}
                        <div style={{ display: tab === 'notif' ? 'block' : 'none' }}>
                            <Notifikasi
                                notifications={notifications}
                                setNotifications={setNotifications}
                                onNotificationClick={handleNotificationClick}
                                t={t}
                                onNavigate={setTab}
                            />
                        </div>

                        {/* Profil Layer */}
                        <div style={{ display: tab === 'profil' ? 'block' : 'none' }}>
                            <Profil
                                userName={userName}
                                userRole={userRole}
                                bio={userBio}
                                photo={userPhoto}
                                activityLog={activityLog}
                                isPrivate={isPrivate}
                                onTogglePrivate={() => setIsPrivate(!isPrivate)}
                                onLogout={handleLogout}
                                onNavigate={(target) => setTab(target)}
                                onOpenDB={() => setScreen('db_manager')}
                                onOpenUserMan={() => setScreen('user_manager')}
                                onUpdateProfile={(data) => {
                                    if (data.name) setUserName(data.name);
                                    if (data.bio) setUserBio(data.bio);
                                    if (data.photo) setUserPhoto(data.photo);
                                    alert(t.profile_update_success);
                                    setActivityLog(prev => [{ id: Date.now(), action: t.profile_activity_update, timestamp: Date.now() }, ...prev]);
                                }}
                                onDeleteAccount={() => {
                                    if (confirm(t.profile_delete_confirm)) {
                                        redis.flushdb();
                                        window.location.reload();
                                    }
                                }}
                                appLang={appLang}
                                onSetLang={setAppLang}
                                theme={theme}
                                onSetTheme={setTheme}
                                timeZone={timeZone}
                                onSetTimeZone={setTimeZone}
                                t={t}
                            />
                        </div>
                        <div style={{ display: tab === 'bantuan' ? 'block' : 'none' }}><Bantuan onNavigate={(target) => setTab(target)} t={t} /></div>
                        <div style={{ display: tab === 'pengetahuan' ? 'block' : 'none' }}><KnowledgeFeed onBack={() => setTab('home')} knowledgeBase={knowledge} t={t} /></div>
                    </div>

                    {/* Mobile Bottom Nav */}
                    <div className="bottom-nav" >
                        <div className={`nav-item ${tab === 'home' ? 'active' : ''}`} data-menu="home" onClick={() => { setTab('home'); setSelectedBidang(null); }}>
                            <Icon name="home" />
                            <span>{t.tab_home}</span>
                        </div>
                        <div className={`nav-item ${tab === 'bidang' ? 'active' : ''}`} data-menu="bidang" onClick={() => setTab('bidang')}>
                            <Icon name="grid" />
                            <span>{t.tab_bidang}</span>
                        </div>
                        <div className={`nav-item ${tab === 'pesan' ? 'active' : ''}`} data-menu="pesan" onClick={() => setTab('pesan')}>
                            <Icon name="message-circle" />
                            <span>{t.tab_pesan}</span>
                        </div>
                        <div className={`nav-item ${tab === 'anggota' ? 'active' : ''}`} data-menu="anggota" onClick={() => setTab('anggota')}>
                            <Icon name="users" />
                            <span>{t.tab_anggota}</span>
                        </div>
                        <div className={`nav-item ${tab === 'notif' ? 'active' : ''}`} data-menu="notif" onClick={() => setTab('notif')} style={{ position: 'relative' }}>
                            <Icon name="bell" />
                            {notifications.some(n => n.unread) && <div style={{ position: 'absolute', top: 10, right: 'calc(50% - 10px)', width: 8, height: 8, background: '#EF4444', borderRadius: '50%', border: '1px solid var(--bg-card)' }}></div>}
                            <span>{t.tab_notif}</span>
                        </div>
                        <div className={`nav-item ${tab === 'profil' ? 'active' : ''}`} data-menu="profil" onClick={() => setTab('profil')}>
                            <Icon name="user" />
                            <span>{t.tab_profil}</span>
                        </div>
                    </div >

                    {/* Global Profile Viewer Modal */}
                    {selectedProfile && (
                        <div style={{
                            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                            background: 'rgba(0,0,0,0.85)', zIndex: 15000,
                            display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 20
                        }} onClick={() => setSelectedProfile(null)}>
                            <div className="animate" style={{
                                width: '100%', maxWidth: 360, background: '#161b22',
                                borderRadius: 28, border: '1px solid rgba(255,255,255,0.1)', overflow: 'hidden',
                                position: 'relative', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.5)'
                            }} onClick={e => e.stopPropagation()}>
                                <div style={{ height: 100, background: 'linear-gradient(to right, #6366f1, #ec4899)' }}></div>
                                <div style={{ textAlign: 'center', marginTop: -50 }}>
                                    <div style={{ width: 100, height: 100, borderRadius: '50%', border: '5px solid #161b22', margin: '0 auto', overflow: 'hidden', background: '#21262d' }}>
                                        <img src={selectedProfile.image || `https://ui-avatars.com/api/?name=${encodeURIComponent(selectedProfile.name)}&background=random`} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                    </div>
                                </div>
                                <div style={{ padding: '20px 24px 30px', textAlign: 'center' }}>
                                    <h2 style={{ fontSize: 22, fontWeight: 800, color: 'white', marginBottom: 4 }}>{selectedProfile.name}</h2>
                                    <div style={{ color: '#8b949e', fontSize: 13, fontWeight: 500 }}>{selectedProfile.role}</div>

                                    <div style={{ margin: '24px auto', display: 'flex', justifyContent: 'center', gap: 30 }}>
                                        <div style={{ textAlign: 'center' }}>
                                            <div style={{ fontWeight: 800, fontSize: 18, color: 'white' }}>{selectedProfile.items || 0}</div>
                                            <div style={{ fontSize: 10, color: '#8b949e', fontWeight: 600 }}>KONTRIBUSI</div>
                                        </div>
                                        <div style={{ textAlign: 'center' }}>
                                            <div style={{ fontWeight: 800, fontSize: 18, color: '#3fb950' }}>{selectedProfile.status}</div>
                                            <div style={{ fontSize: 10, color: '#8b949e', fontWeight: 600 }}>STATUS</div>
                                        </div>
                                    </div>

                                    <div style={{ display: 'flex', gap: 12, marginTop: 20 }}>
                                        <button onClick={() => { setChatTarget(selectedProfile); setTab('pesan'); setSelectedProfile(null); }} style={{ flex: 1, padding: '14px', background: 'var(--primary)', border: 'none', borderRadius: 14, color: 'white', fontSize: 14, fontWeight: 700, cursor: 'pointer' }}>Kirim Pesan</button>
                                        <button onClick={() => setSelectedProfile(null)} style={{ flex: 1, padding: '14px', background: '#21262d', border: 'none', borderRadius: 14, color: 'white', fontSize: 14, fontWeight: 700, cursor: 'pointer' }}>Tutup</button>
                                    </div>
                                </div>
                                <div onClick={() => setSelectedProfile(null)} style={{ position: 'absolute', top: 14, right: 14, padding: 8, color: 'white', cursor: 'pointer', opacity: 0.7 }}>
                                    <Icon name="x" size={24} />
                                </div>
                            </div>
                        </div>
                    )}
                </div >
            );
        }

        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        } catch (error) {
            console.error("React Render Error:", error);
            document.body.innerHTML += '<div style="color: red; padding: 20px;"><h3>React Gagal Dirender:</h3><pre>' + error.message + '</pre></div>';
        }
    </script>
</body>

</html>